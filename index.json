[{"content":"EventBusæ˜¯ä¸€ä¸ªæ¶ˆæ¯è®¢é˜…/å‘å¸ƒçš„å¼€æºæ¡†æ¶ã€‚\nå¦‚ä¸Šå›¾æ‰€ç¤º , EventBusæ¡†æ¶ä¸­ä¸»è¦æœ‰2ä¸ªè§’è‰² :\nPublisher : å‘å¸ƒæ¶ˆæ¯çš„, è¢«è§‚å¯Ÿè€… Subscriber : æ¥æ”¶æ¶ˆæ¯çš„ , è§‚å¯Ÿè€… Publisher(è¢«è§‚å¯Ÿè€…) é€šè¿‡ post() å°†ä¸€ä¸ªäº‹ä»¶/æ¶ˆæ¯(Event) å‘é€åˆ°äº‹ä»¶çš„é›†ä¸­åœ°,ä¹Ÿå°±æ˜¯å›¾ä¸­çš„ EventBus ï¼ŒEventBus å†å°†äº‹ä»¶/æ¶ˆæ¯(Event)å‘ç»™Subcriberè§‚å¯Ÿè€…ã€‚\nä½¿ç”¨è¿™æ ·çš„æ¡†æ¶ï¼Œèƒ½å¤Ÿä½¿Activity/Fragmentç­‰ç»„ä»¶ä¹‹é—´çš„é€šä¿¡ç®€åŒ– , ä¸ç”¨å†åƒä»¥å‰ä¸€ç›´ä½¿ç”¨ intent æ¥ä¼ é€æ•°æ® , ä»è€Œæå‡å¼€å‘æ•ˆç‡ã€‚\n1.é…ç½®ä¾èµ– åœ¨appå±‚çš„ build.gradle ä¸­æ·»åŠ  :\nimplementation \u0026#39;org.greenrobot:eventbus:3.1.1\u0026#39; 2.åˆæ­¥ä½¿ç”¨ æ ¹æ®å®˜æ–¹æ–‡æ¡£ , é¦–å…ˆè¦å®šä¹‰ä¸€ä¸ªEvent(æ¶ˆæ¯)çš„POJOç±» :\npublic class MessageEvent { private String message ; public MessageEvent(String message) { this.message = message; } public String getMessage() { return message; } public void setMessage(String message) { this.message = message; } } ç„¶å , æˆ‘ä»¬è¦æ˜ç¡®å“ªä¸ªç»„ä»¶æ˜¯ Subsriber(è§‚å¯Ÿè€…), å“ªä¸ªç»„ä»¶æ˜¯Publisher(è¢«è§‚å¯Ÿè€…) , åœ¨è¿™é‡Œ , æˆ‘ä»¬é€šè¿‡EventBusæ¼”ç¤ºä¸€ä¸ªä¼ é€æ¶ˆæ¯çš„demoã€‚\né¦–å…ˆ , è§‚å¯Ÿè€…è¦æ³¨å†ŒEventBus , åœ¨è¿™é‡Œ å› ä¸ºå½“å‰æ´»åŠ¨å°±æ˜¯æ¥æ”¶æ¶ˆæ¯çš„,æ‰€ä»¥å½“å‰æ´»åŠ¨å°±æ˜¯ è§‚å¯Ÿè€…(æ¥æ”¶äº‹ä»¶çš„ä¸€æ–¹) ,\nå¹¶ä¸”ç”¨ @Subscribe æ³¨è§£å®šä¹‰ä¸€ä¸ªå¤„ç†æ¥æ”¶äº‹ä»¶çš„æ–¹æ³• ï¼Œ è¿™é‡Œæˆ‘ä»¬ç®€å•åœ°æŠŠæ”¶åˆ°çš„äº‹ä»¶å†…å®¹ç”¨Toastå¼¹å‡ºã€‚\npublic class ToastActivity extends AppCompatActivity { @Override protected void onCreate(Bundle savedInstanceState) { super.onCreate(savedInstanceState); setContentView(R.layout.activity_toast); //æ³¨å†Œ EventBus.getDefault().register(this); } @Override protected void onDestroy() { //è§£é™¤æ³¨å†Œ EventBus.getDefault().unregister(this); super.onDestroy(); } /** * æ¥æ”¶äº‹ä»¶ * @param msg */ @Subscribe public void onMessageEvent(Message msg) { Toast.makeText(this, msg.getMessage(), Toast.LENGTH_SHORT).show(); } } æœ€å , æˆ‘ä»¬è¦å®ç°ç‚¹å‡»æŒ‰é’®,é€šè¿‡EventBuså‘é€äº‹ä»¶ , æ‰€ä»¥å½“å‰æ´»åŠ¨ä¹Ÿä½œä¸ºè¢« è§‚å¯Ÿè€…(å‘é€äº‹ä»¶çš„ä¸€æ–¹) , å‘é€æ¶ˆæ¯é€šè¿‡ post() å³å¯ã€‚\npublic class ToastActivity extends AppCompatActivity { EditText mMsgEt; @Override protected void onCreate(Bundle savedInstanceState) { super.onCreate(savedInstanceState); setContentView(R.layout.activity_toast); EventBus.getDefault().register(this); mMsgEt = (EditText) findViewById(R.id.message_et); findViewById(R.id.send_msg_btn).setOnClickListener(new View.OnClickListener() { @Override public void onClick(View v) { //å‘é€äº‹ä»¶ EventBus.getDefault().post(new Message(mMsgEt.getText().toString())); } }); } /** * æ¥æ”¶äº‹ä»¶ * @param msg */ @Subscribe public void onMessageEvent(Message msg) { Toast.makeText(this, msg.getMessage(), Toast.LENGTH_SHORT).show(); } @Override protected void onDestroy() { EventBus.getDefault().unregister(this); super.onDestroy(); } } 3.ThreadMode åœ¨EventBusä¸­, æˆ‘ä»¬å¯ä»¥è®¾ç½®è§‚å¯Ÿè€…å¤„ç†æ¥æ”¶åˆ°æ¶ˆæ¯çš„å‡½æ•°æ‰€åœ¨çš„çº¿ç¨‹ã€‚\n1.ThreadMode.POSTING @Subscribe(threadMode = ThreadMode.POSTING) public void onMessage(MessageEvent event) { log(event.message); } è¿™æ˜¯eventBusçš„é»˜è®¤æ¨¡å¼ , æ¥æ”¶æ¶ˆæ¯çš„å‡½æ•°ä¼šåœ¨å‘é€æ¶ˆæ¯æ‰€åœ¨çš„çº¿ç¨‹ä¸­è¢«è°ƒç”¨ã€‚è¿™ç§æ¨¡å¼ä¸‹é¿å…äº†å‘é€äº‹ä»¶å’Œå¤„ç†äº‹ä»¶é—´çš„çº¿ç¨‹åˆ‡æ¢ï¼Œå¼€é”€æœ€å°ã€‚\nä½†æ˜¯å½“å‘é€äº‹ä»¶åœ¨ä¸»çº¿ç¨‹æ—¶ï¼Œåº”é¿å…å¤„ç†äº‹ä»¶çš„å‡½æ•°å‘ç”Ÿå µå¡ï¼Œå¦åˆ™ä¼šå¼•èµ·å¡é¡¿ã€‚\n2.ThreadMode.MAIN @Subscribe(threadMode = ThreadMode.MAIN) public void onMessage(MessageEvent event) { log(event.message); } è¿™ç§æ¨¡å¼ä¸‹å¤„ç†äº‹ä»¶çš„å‡½æ•°å°†åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œ , æ‰€ä»¥ä¹Ÿåº”è¯¥é¿å…åœ¨å¤„ç†å‡½æ•°ä¸­å‘ç”Ÿå µå¡ã€‚\n3.ThreadMode.MAIN_ORDERED @Subscribe(threadMode = ThreadMode.MAIN_ORDERED) public void onMessage(MessageEvent event) { log(event.message); } è¿™ç§æ¨¡å¼ä¸‹ , äº‹ä»¶çš„å¤„ç†å‡½æ•°ä¸ä»…åœ¨ä¸»çº¿ç¨‹ , å½“æœ‰è¢«è§‚å¯Ÿè€…å‘é€äº†å¤šä¸ªäº‹ä»¶çš„æ—¶å€™ , äº‹ä»¶å°†æŒ‰ç…§å‘é€çš„é¡ºåºä¾æ¬¡è¢«å¤„ç† , ä¿è¯äº†äº‹ä»¶ä¹‹é—´çš„é¡ºåºæ€§ã€‚\n4.TheadMode.BACKGROUND @Subscribe(threadMode = ThreadMode.BACKGROUND) public void onMessage(MessageEvent event) { log(event.message); } å½“å‘é€äº‹ä»¶æ‰€åœ¨çº¿ç¨‹æ˜¯å­çº¿ç¨‹ , åˆ™äº‹ä»¶ä¹Ÿåœ¨ç»Ÿä¸€å­çº¿ç¨‹å¤„ç†ã€‚\nå½“å‘é€äº‹ä»¶æ‰€åœ¨çº¿ç¨‹æ˜¯ä¸»çº¿è½¦å·¥ , åˆ™eventBusä¼šåœ¨åå°æ–°å¼€ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨äº‹ä»¶å¤„ç†å‡½æ•°ã€‚\n5.ThreadMode.ASYNC @Subscribe(threadMode = ThreadMode.ASYNC) public void onMessage(MessageEvent event) { log(event.message); } åœ¨æ­¤æ¨¡å¼ä¸‹ , äº‹ä»¶å¤„ç†å‡½æ•°å§‹ç»ˆåœ¨ä¸å‘é€äº‹ä»¶æ‰€åœ¨çº¿ç¨‹ä¹‹å¤–çš„å­çº¿ç¨‹ä¸­æ‰§è¡Œ , ä¹Ÿå°±æ˜¯ä¸¤è€…æ‰€åœ¨çº¿ç¨‹ç›¸äº’ç‹¬ç«‹ã€‚\n4.ç²˜æ€§äº‹ä»¶ æ™®é€šçš„äº‹ä»¶éœ€è¦æ¥æ”¶æ–¹å…ˆæ³¨å†Œ,å‘é€æ–¹å†å‘é€æ¶ˆæ¯,æ‰èƒ½å®Œæˆæ¶ˆæ¯çš„å‘é€å’Œå¤„ç†ã€‚\nè€Œç²˜æ€§äº‹ä»¶çš„ä½œç”¨å°±æ˜¯,å‘é€æ–¹å¯ä»¥å…ˆå‘é€äº‹ä»¶ , æ¥æ”¶æ–¹åœ¨ä¹‹åè¿›è¡Œæ³¨å†Œæ—¶å†å®Œæˆæ¶ˆæ¯çš„å¤„ç†ã€‚\n1.ç®€å•ä½¿ç”¨ ç°åœ¨æˆ‘ä»¬åšä¸€ä¸ªæ³¨å†Œ-\u0026gt;ç™»é™†æµç¨‹çš„demo ,æˆ‘ä»¬æƒ³è¦å®ç° :\nç”¨æˆ·é¦–å…ˆåœ¨æ³¨å†Œé¡µé¢å¡«å†™è´¦å·\u0026amp;å¯†ç ä¿¡æ¯ , å†è¿›å…¥ç™»é™†é¡µé¢æ—¶, å°±ä¸ç”¨å†é‡å¤è¾“å…¥è´¦å·å¯†ç äº†ã€‚\næ•ˆæœå›¾ :\nä»£ç  :\næ³¨å†Œé¡µé¢ :\npublic class RegisterActivity extends AppCompatActivity { EditText mUsernameEditText;//ç”¨æˆ·åç¼–è¾‘æ¡† EditText mPasswordEditText;//å¯†ç ç¼–è¾‘æ¡† @Override protected void onCreate(Bundle savedInstanceState) { super.onCreate(savedInstanceState); setContentView(R.layout.activity_register); mUsernameEditText = (EditText) findViewById(R.id.register_username_text_input_layout); mPasswordEditText = (EditText) findViewById(R.id.register_activity_password_et); //ç‚¹å‡»æ³¨å†Œ findViewById(R.id.register_btn).setOnClickListener(new View.OnClickListener() { @Override public void onClick(View v) { String username = mUsernameEditText.getText().toString(); String password = mPasswordEditText.getText().toString(); Toast.makeText(RegisterActivity.this, \u0026#34;æ³¨å†ŒæˆåŠŸ , å¿«å»ç™»é™†~\u0026#34;, Toast.LENGTH_SHORT).show(); //å‘é€ç²˜æ€§äº‹ä»¶ EventBus.getDefault().postSticky(new MessageEvent(username,password)); startActivity(new Intent(RegisterActivity.this, LoginActivity.class)); } }); } } é€šè¿‡ postSticky() å‘é€ä¸€ä¸ªç²˜æ€§äº‹ä»¶ã€‚\nç™»é™†é¡µé¢ :\npublic class LoginActivity extends AppCompatActivity { EditText mUsernameEd;//ç”¨æˆ·åç¼–è¾‘æ¡† EditText mPasswordEd;//å¯†ç ç¼–è¾‘æ¡† @Override protected void onCreate(Bundle savedInstanceState) { super.onCreate(savedInstanceState); setContentView(R.layout.activity_login); EventBus.getDefault().register(this); mUsernameEd = (EditText)findViewById(R.id.login_username_text_input_layout); mPasswordEd = (EditText)findViewById(R.id.login_password_editText); } //æ¥æ”¶ç²˜æ€§äº‹ä»¶ , å°†æ³¨å†Œé¡µé¢çš„ä¿¡æ¯èµ‹å€¼åˆ°ç¼–è¾‘æ¡†ä¸­ @Subscribe(sticky = true) public void onEvent(MessageEvent event) { mUsernameEd.setText(event.getUsername()); mPasswordEd.setText(event.getPassword()); } @Override protected void onDestroy() { EventBus.getDefault().unregister(this); super.onDestroy(); } } 2. è·å–/ç§»é™¤ç²˜æ€§æ¶ˆæ¯ å½“æˆ‘ä»¬å‘é€äº†ä¸€ä¸ªç²˜æ€§æ¶ˆæ¯ , ä½†è¿™ä¸ªæ¶ˆæ¯å°šæœªè¢«è®¢é˜…è€…æ¥æ”¶å¤„ç†æ—¶ , æˆ‘ä»¬å¯ä»¥é€šè¿‡ getStickyEvent() æ‹¿åˆ°è¿™ä¸ªæ¶ˆæ¯ã€‚\n//è·å–å·²ç»å‘é€çš„ä½†æœªå¤„ç†çš„ç²˜æ€§æ¶ˆæ¯ MessageEvent stickyEvent = EventBus.getDefault().getStickyEvent(MessageEvent.class); å¹¶ä¸”å¯ä»¥é€šè¿‡ removeStickyEvent() ç§»é™¤è¿™ä¸ªäº‹ä»¶ , è¿™æ ·ä¹‹åè®¢é˜…ä¹‹æ³¨å†Œä¹‹åä¹Ÿä¸ä¼šæ”¶åˆ°è¿™ä¸ªäº‹ä»¶ã€‚\n//ç§»é™¤æ¶ˆæ¯ EventBus.getDefault().removeStickyEvent(stickyEvent); ç°åœ¨è¯•éªŒä¸€ä¸‹, æˆ‘ä»¬åœ¨å‰é¢çš„demoä¸­è¿›è¡Œä¿®æ”¹ , åœ¨æ³¨å†Œé¡µé¢ç‚¹å‡»æ³¨å†ŒæŒ‰é’®æ—¶ , ç§»é™¤ç²˜æ€§äº‹ä»¶ã€‚\npublic class RegisterActivity extends AppCompatActivity { ... @Override protected void onCreate(Bundle savedInstanceState) { super.onCreate(savedInstanceState); setContentView(R.layout.activity_register); ... findViewById(R.id.register_btn).setOnClickListener(new View.OnClickListener() { @Override public void onClick(View v) { String username = mUsernameEditText.getText().toString(); String password = mPasswordEditText.getText().toString(); //å‘é€ç²˜æ€§æ¶ˆæ¯ EventBus.getDefault().postSticky(new MessageEvent(username, password)); //è·å–å·²ç»å‘é€çš„ä½†æœªå¤„ç†çš„ç²˜æ€§æ¶ˆæ¯ MessageEvent stickyEvent = EventBus.getDefault().getStickyEvent(MessageEvent.class); if (stickyEvent != null) { //ç§»é™¤æ¶ˆæ¯ EventBus.getDefault().removeStickyEvent(stickyEvent); } startActivity(new Intent(RegisterActivity.this, LoginActivity.class)); } }); } } è¿™æ · , åœ¨è·³è½¬åˆ°ç™»é™†é¡µé¢æ—¶ , è‡ªåŠ¨å¡«å……ç”¨æˆ·å\u0026amp;å¯†ç çš„æ•ˆæœå°±æ¶ˆå¤±äº†ã€‚\n5.æºç å­¦ä¹  åœ¨çœ‹EventBusæºç ä¹‹å‰ , è¦å…ˆæƒ³æ¸…æ¥šæˆ‘ä»¬æƒ³è¦å¾—åˆ°ä»€ä¹ˆåé¦ˆ , çœ‹æºç èƒ½å¼„æ˜ç™½ä»€ä¹ˆé—®é¢˜ã€‚\nEventBusæ˜¯å¦‚ä½•å®ç°è®¢é˜…è€…åœ¨äº‹ä»¶åˆ°æ¥æ—¶æ‰§è¡Œå¯¹åº”æ–¹æ³•çš„ , åœ¨register(),post()æ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ EventBus.getDefault().register(this); 1.register() : public void register(Object subscriber) { //1.è·å¾—è®¢é˜…è€…(Activity,fragment)çš„Classå¯¹è±¡ Class\u0026lt;?\u0026gt; subscriberClass = subscriber.getClass(); //2.æ ¹æ®è®¢é˜…è€…çš„Classå¯¹è±¡æŸ¥æ‰¾å®ƒç”¨@Subcribeæ³¨è§£çš„æ–¹æ³•é›†åˆ , å¯¹äºSubcriberMethodFinderçš„ç±»æš‚æ—¶å…ˆä¸ç”¨ç®¡ List\u0026lt;SubscriberMethod\u0026gt; subscriberMethods = subscriberMethodFinder.findSubscriberMethods(subscriberClass); synchronized (this) { //3.å°†Classå¯¹è±¡ä¸å®ƒé‡Œé¢çš„@Subcribeæ–¹æ³•è¿›è¡Œæ³¨å†Œç»‘å®š for (SubscriberMethod subscriberMethod : subscriberMethods) { subscribe(subscriber, subscriberMethod); } } } register()æ–¹æ³•ä¸­åšäº†3ä»¶äº‹æƒ… :\nè·å¾—è®¢é˜…è€…(Activity,fragment)çš„Classå¯¹è±¡ æ ¹æ®è®¢é˜…è€…çš„Classå¯¹è±¡æŸ¥æ‰¾å®ƒç”¨@Subcribeæ³¨è§£çš„æ–¹æ³•é›†åˆ å°†Classå¯¹è±¡ä¸å®ƒé‡Œé¢çš„@Subcribeæ–¹æ³•è¿›è¡Œæ³¨å†Œç»‘å®š ##subcribe()æ–¹æ³• : åœ¨æ³¨é‡Šä¸­å·²ç»å†™æ¸…æ¥šä»£ç çš„ä½œç”¨ , æŒ‰ç…§é¡ºåºé˜…è¯»åº”è¯¥å¾ˆå®¹æ˜“ç†è§£ã€‚\n/** * @param subscriber è®¢é˜…è€…(Activity,fragmentç­‰ç»„ä»¶)çš„Classå¯¹è±¡ * @param subscriberMethod è®¢é˜…è€…ä¸­ç”¨@Subcribeæ³¨è§£çš„æ–¹æ³• */ private void subscribe(Object subscriber, SubscriberMethod subscriberMethod) { //1.è·å¾—è®¢é˜…æ–¹æ³•æ‰€å¯¹åº”çš„Eventç±»å‹ Class\u0026lt;?\u0026gt; eventType = subscriberMethod.eventType; //2.å°†è®¢é˜…è€…å’Œè®¢é˜…æ–¹æ³•æ‰“åŒ…åˆ°ä¸€ä¸ªåŒ…è£…ç±» Subscription newSubscription = new Subscription(subscriber, subscriberMethod); //3.è·å¾—è¿™ä¸ªEventæ‰€æœ‰çš„\u0026lt;è®¢é˜…è€…,è®¢é˜…æ–¹æ³•\u0026gt;é›†åˆï¼Œé›†åˆä¸­ä¹Ÿå¯èƒ½åŒ…å«å‚æ•°ä¸­è®¢é˜…è€…ä»¥å¤–çš„è®¢é˜…è€… CopyOnWriteArrayList\u0026lt;Subscription\u0026gt; subscriptions = subscriptionsByEventType.get(eventType); //4.è‹¥\u0026lt;è®¢é˜…è€…,è®¢é˜…æ–¹æ³•\u0026gt;é›†åˆä¸ºç©º , è¯´æ˜æ¥æ”¶è¯¥Eventçš„è‹¥å¹²ç»„ä»¶è¿˜æœªè°ƒç”¨register() if (subscriptions == null) { subscriptions = new CopyOnWriteArrayList\u0026lt;\u0026gt;(); subscriptionsByEventType.put(eventType, subscriptions); } else { //5.å¦‚æœè¿™ä¸ªEventå¯¹åº”çš„çš„\u0026lt;è®¢é˜…è€…,è®¢é˜…æ–¹æ³•\u0026gt;é›†åˆä¸­å·²ç»åŒ…å«äº†å½“å‰è¿™ä¸ª\u0026lt;è®¢é˜…è€…,è®¢é˜…æ–¹æ³•\u0026gt;ï¼Œåˆ™è¯´æ˜å½“å‰ç»„ä»¶é‡å¤è°ƒç”¨register()äº†. if (subscriptions.contains(newSubscription)) { throw new EventBusException(\u0026#34;Subscriber \u0026#34; + subscriber.getClass() + \u0026#34; already registered to event \u0026#34; + eventType); } } int size = subscriptions.size(); //6.å°†è®¢é˜…æ–¹æ³•æŒ‰ç…§ä¼˜å…ˆçº§å¤§å°æ’åº for (int i = 0; i \u0026lt;= size; i++) { if (i == size || subscriberMethod.priority \u0026gt; subscriptions.get(i).subscriberMethod.priority) { subscriptions.add(i, newSubscription); break; } } //7.è·å–è¿™ä¸ªè®¢é˜…è€…è®¢é˜…çš„æ‰€æœ‰Eventé›†åˆ List\u0026lt;Class\u0026lt;?\u0026gt;\u0026gt; subscribedEvents = typesBySubscriber.get(subscriber); if (subscribedEvents == null) { subscribedEvents = new ArrayList\u0026lt;\u0026gt;(); typesBySubscriber.put(subscriber, subscribedEvents); } //8.å°†å½“å‰@Subcribeæ–¹æ³•çš„Eventç±»å‹æ·»åŠ åˆ°è¿™ä¸ªè®¢é˜…è€…çš„Eventé›†åˆä¸­ subscribedEvents.add(eventType); //9.å¦‚æœ@Subcribe()æ–¹æ³•ä¸­sticky = true ,åˆ™è·å¾—è¿™ä¸ªç²˜æ€§äº‹ä»¶ //æ³¨æ„å¦‚æœå½“å‰äº‹ä»¶æ˜¯æ™®é€šäº‹ä»¶ , åˆ™ä¸åšä»»ä½•å¤„ç†ã€‚ if (subscriberMethod.sticky) { if (eventInheritance) { Set\u0026lt;Map.Entry\u0026lt;Class\u0026lt;?\u0026gt;, Object\u0026gt;\u0026gt; entries = stickyEvents.entrySet(); for (Map.Entry\u0026lt;Class\u0026lt;?\u0026gt;, Object\u0026gt; entry : entries) { //å…ˆè·å¾—ç²˜æ€§äº‹ä»¶Eventçš„Classå¯¹è±¡ Class\u0026lt;?\u0026gt; candidateEventType = entry.getKey(); //æ‰¾åˆ°å½“å‰Subscribe()æ–¹æ³•è®¢é˜…çš„ç²˜æ€§äº‹ä»¶ if (eventType.isAssignableFrom(candidateEventType)) { //å¾—åˆ°ç²˜æ€§äº‹ä»¶ Object stickyEvent = entry.getValue(); checkPostStickyEventToSubscription(newSubscription, stickyEvent); } } } else { Object stickyEvent = stickyEvents.get(eventType); //10.å¯¹stickyäº‹ä»¶åˆ¤ç©º,å¹¶æ‰§è¡Œè®¢é˜…æ–¹æ³• checkPostStickyEventToSubscription(newSubscription, stickyEvent); } } } çœ‹ä¸€ä¸‹ç¬¬10æ­¥çš„æ–¹æ³• checkPostStickyEventToSubsctiption() :\n/** * å¯¹äº‹ä»¶è¿›è¡Œåˆ¤ç©º * @param newSubscription (è®¢é˜…è€…,è®¢é˜…æ–¹æ³•) * @param stickyEvent ç²˜æ€§äº‹ä»¶ */ private void checkPostStickyEventToSubscription(Subscription newSubscription, Object stickyEvent) { if (stickyEvent != null) { // If the subscriber is trying to abort the event, it will fail (event is not tracked in posting state) // --\u0026gt; Strange corner case, which we don\u0026#39;t take care of here. postToSubscription(newSubscription, stickyEvent, isMainThread()); } } ##postToSubscription() :\nprivate void postToSubscription(Subscription subscription, Object event, boolean isMainThread) { //æ ¹æ®å¯¹åº”çš„ThreadMode,åœ¨å¯¹åº”çš„çº¿ç¨‹ä¸­æ‰§è¡Œ switch (subscription.subscriberMethod.threadMode) { case POSTING: invokeSubscriber(subscription, event); break; case MAIN: if (isMainThread) { invokeSubscriber(subscription, event); } else { mainThreadPoster.enqueue(subscription, event); } break; case MAIN_ORDERED: if (mainThreadPoster != null) { mainThreadPoster.enqueue(subscription, event); } else { // temporary: technically not correct as poster not decoupled from subscriber invokeSubscriber(subscription, event); } break; case BACKGROUND: if (isMainThread) { backgroundPoster.enqueue(subscription, event); } else { invokeSubscriber(subscription, event); } break; case ASYNC: asyncPoster.enqueue(subscription, event); break; default: throw new IllegalStateException(\u0026#34;Unknown thread mode: \u0026#34; + subscription.subscriberMethod.threadMode); } } è¿™ä¸ªæ–¹æ³•æ ¹æ®å¯¹åº”çš„ThreadMode,åœ¨å¯¹åº”çš„çº¿ç¨‹ä¸­è°ƒç”¨ invokeSubcriber() æ–¹æ³• , è¿™ä¸ªæ–¹æ³•å°±æ˜¯è®©ç²˜æ€§äº‹ä»¶çš„@Subcriberæ³¨è§£çš„æ–¹æ³•æ‰§è¡Œçš„åœ°æ–¹ :\n##invokeSubcriber() :\n/** * é€šè¿‡åå°„è°ƒç”¨è®¢é˜…è€…ä¸­çš„@Subcribeæ–¹æ³• * @param subscription * @param event */ void invokeSubscriber(Subscription subscription, Object event) { try { // subscription.subscriberMethod.method.invoke(subscription.subscriber, event); } catch (InvocationTargetException e) { handleSubscriberException(subscription, event, e.getCause()); } catch (IllegalAccessException e) { throw new IllegalStateException(\u0026#34;Unexpected exception\u0026#34;, e); } } ä»ä»¥ä¸Šæµç¨‹å¯ä»¥çœ‹å‡º è®¢é˜…è€…è°ƒç”¨äº† register() ä¹‹å ,å¯¹ç²˜æ€§äº‹ä»¶çš„å¤„ç†æƒ…å†µ , æµç¨‹å›¾å¦‚ä¸‹ :\né‚£ä¹ˆæ™®é€šäº‹ä»¶æ˜¯å¦‚ä½•å¤„ç†çš„å‘¢ ?\næˆ‘ä»¬çœ‹ä¸€ä¸‹ post() æ–¹æ³•åšäº†ä»€ä¹ˆ :\n2.post() /** * Posts the given event to the event bus. */ public void post(Object event) { //è·å–å½“å‰çº¿ç¨‹çš„å‘é€çŠ¶æ€ PostingThreadState postingState = currentPostingThreadState.get(); //è·å–å½“å‰çº¿ç¨‹çš„äº‹ä»¶åºåˆ— List\u0026lt;Object\u0026gt; eventQueue = postingState.eventQueue; //æŠŠäº‹ä»¶æ·»åŠ åˆ°åºåˆ—ä¸­ eventQueue.add(event); //å¦‚æœå½“å‰çº¿ç¨‹å°šæœªå¤„äºå‘é€çŠ¶æ€ if (!postingState.isPosting) { postingState.isMainThread = isMainThread(); //æ ‡å¿—å½“å‰çº¿ç¨‹å¤„äºå‘é€äº‹ä»¶çŠ¶æ€ postingState.isPosting = true; //æ­£å¤„äºå‘é€çŠ¶æ€æ—¶æ˜¯ä¸èƒ½å–æ¶ˆçš„ if (postingState.canceled) { throw new EventBusException(\u0026#34;Internal error. Abort state was not reset\u0026#34;); } try { //å°†äº‹ä»¶åºåˆ—ä¸­çš„äº‹ä»¶æŒ¨ä¸ªå‘é€ while (!eventQueue.isEmpty()) { postSingleEvent(eventQueue.remove(0), postingState); } } finally { postingState.isPosting = false; postingState.isMainThread = false; } } } EventBusä¸­ç”¨ThreadLocalå­˜å‚¨äº†æ¯ä¸ªçº¿ç¨‹çš„å‘é€çŠ¶æ€ ,\nprivate final ThreadLocal\u0026lt;PostingThreadState\u0026gt; currentPostingThreadState = new ThreadLocal\u0026lt;PostingThreadState\u0026gt;() { @Override protected PostingThreadState initialValue() { return new PostingThreadState(); } }; ThreadLocalè¿™ä¸ªç±»æ˜¯çº¿ç¨‹ç‹¬ç«‹çš„ ï¼Œ èƒ½å¤Ÿä¿è¯æ¯ä¸ªçº¿ç¨‹ä¹‹é—´çš„å‘é€çŠ¶æ€äº’ä¸å¹²æ‰°ã€‚\nè¿›å…¥æœ€åå‘é€äº‹ä»¶çš„å‡½æ•° postSingleEvent() :\nprivate void postSingleEvent(Object event, PostingThreadState postingState) throws Error { Class\u0026lt;?\u0026gt; eventClass = event.getClass(); boolean subscriptionFound = false; //æ˜¯å¦å¼€å¯äº†äº‹ä»¶ç»§æ‰¿ if (eventInheritance) { //å¯»æ‰¾å½“å‰äº‹ä»¶ç±»çš„ç´ æœ‰çˆ¶ç±»,æ¥å£ List\u0026lt;Class\u0026lt;?\u0026gt;\u0026gt; eventTypes = lookupAllEventTypes(eventClass); int countTypes = eventTypes.size(); for (int h = 0; h \u0026lt; countTypes; h++) { Class\u0026lt;?\u0026gt; clazz = eventTypes.get(h); //æœ‰å¤šä¸ªè®¢é˜…è€…æ—¶,åªè¦æœ‰ä¸€ä¸ªå‘é€æˆåŠŸ,åˆ™å·¦è¾¹ä¸ºtrue subscriptionFound |= postSingleEventForEventType(event, postingState, clazz); } } else { //å‘é€å•ä¸ªäº‹ä»¶ subscriptionFound = postSingleEventForEventType(event, postingState, eventClass); } //å¦‚æœå½“å‰äº‹ä»¶è¿˜æ²¡æœ‰è®¢é˜…è€…è®¢é˜… if (!subscriptionFound) { if (logNoSubscriberMessages) { logger.log(Level.FINE, \u0026#34;No subscribers registered for event \u0026#34; + eventClass); } if (sendNoSubscriberEvent \u0026amp;\u0026amp; eventClass != NoSubscriberEvent.class \u0026amp;\u0026amp; eventClass != SubscriberExceptionEvent.class) { //å‘é€ä¸€ä¸ªæ²¡æœ‰è®¢é˜…è€…çš„äº‹ä»¶ï¼Œè¿™ä¸ªäº‹ä»¶å¯ä»¥ç”±æˆ‘ä»¬æ¥æ¥æ”¶ post(new NoSubscriberEvent(this, event)); } } } è¿›å…¥ postSingleEventForEventType() :\nprivate boolean postSingleEventForEventType(Object event, PostingThreadState postingState, Class\u0026lt;?\u0026gt; eventClass) { CopyOnWriteArrayList\u0026lt;Subscription\u0026gt; subscriptions; //è·å–è®¢é˜…äº†è¿™ä¸ªäº‹ä»¶çš„\u0026lt;è®¢é˜…è€…,è®¢é˜…æ–¹æ³•\u0026gt;åˆ—è¡¨ synchronized (this) { subscriptions = subscriptionsByEventType.get(eventClass); } //å¦‚æœè¿™ä¸ªäº‹ä»¶æœ‰è®¢é˜…è€… if (subscriptions != null \u0026amp;\u0026amp; !subscriptions.isEmpty()) { for (Subscription subscription : subscriptions) { postingState.event = event; postingState.subscription = subscription; boolean aborted = false; try { //å°†äº‹ä»¶åˆ†å‘ç»™è®¢é˜…è€… , åœ¨åˆ†æregister()æ—¶åˆ†æè¿‡ã€‚ postToSubscription(subscription, event, postingState.isMainThread); aborted = postingState.canceled; } finally { postingState.event = null; postingState.subscription = null; postingState.canceled = false; } if (aborted) { break; } } return true; } return false; } å¯ä»¥çœ‹åˆ°,æœ€åçš„æŠŠäº‹ä»¶å‘é€ç»™è®¢é˜…è€…çš„å‡½æ•° postToSubcription() ä¸ register() æµç¨‹ä¸­æœ€åå‘é€ç²˜æ€§äº‹ä»¶ç»™è®¢é˜…è€…çš„ä¸€æ · , è¿™é‡Œå°±ä¸ä»‹ç»äº†ã€‚\nprivate void postToSubscription(Subscription subscription, Object event, boolean isMainThread) { //æ ¹æ®å¯¹åº”çš„ThreadMode,åœ¨å¯¹åº”çš„çº¿ç¨‹ä¸­æ‰§è¡Œ switch (subscription.subscriberMethod.threadMode) { case POSTING: invokeSubscriber(subscription, event); break; case MAIN: if (isMainThread) { invokeSubscriber(subscription, event); } else { mainThreadPoster.enqueue(subscription, event); } break; case MAIN_ORDERED: if (mainThreadPoster != null) { mainThreadPoster.enqueue(subscription, event); } else { // temporary: technically not correct as poster not decoupled from subscriber invokeSubscriber(subscription, event); } break; case BACKGROUND: if (isMainThread) { backgroundPoster.enqueue(subscription, event); } else { invokeSubscriber(subscription, event); } break; case ASYNC: asyncPoster.enqueue(subscription, event); break; default: throw new IllegalStateException(\u0026#34;Unknown thread mode: \u0026#34; + subscription.subscriberMethod.threadMode); } } post() çš„æ€»ä½“æµç¨‹å›¾å¦‚ä¸‹ :\nReferences :\nhttp://greenrobot.org/eventbus/ https://www.jianshu.com/p/f057c460c77e https://github.com/greenrobot/EventBus ","permalink":"https://chenyongda2018.github.io/posts/android/eventbus%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/","summary":"\u003cp\u003eEventBusæ˜¯ä¸€ä¸ªæ¶ˆæ¯è®¢é˜…/å‘å¸ƒçš„å¼€æºæ¡†æ¶ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/11/15/16e6cfac7adeac21~tplv-t2oaga2asx-image.image\"\u003e\u003c/p\u003e\n\u003cp\u003eå¦‚ä¸Šå›¾æ‰€ç¤º , EventBusæ¡†æ¶ä¸­ä¸»è¦æœ‰2ä¸ªè§’è‰² :\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePublisher : å‘å¸ƒæ¶ˆæ¯çš„, è¢«è§‚å¯Ÿè€…\u003c/li\u003e\n\u003cli\u003eSubscriber : æ¥æ”¶æ¶ˆæ¯çš„ , è§‚å¯Ÿè€…\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003ccode\u003ePublisher(è¢«è§‚å¯Ÿè€…)\u003c/code\u003e é€šè¿‡ \u003ccode\u003epost()\u003c/code\u003e å°†ä¸€ä¸ªäº‹ä»¶/æ¶ˆæ¯(\u003ccode\u003eEvent\u003c/code\u003e) å‘é€åˆ°äº‹ä»¶çš„é›†ä¸­åœ°,ä¹Ÿå°±æ˜¯å›¾ä¸­çš„ \u003ccode\u003eEventBus\u003c/code\u003e ï¼Œ\u003ccode\u003eEventBus\u003c/code\u003e å†å°†äº‹ä»¶/æ¶ˆæ¯(\u003ccode\u003eEvent\u003c/code\u003e)å‘ç»™\u003ccode\u003eSubcriber\u003c/code\u003eè§‚å¯Ÿè€…ã€‚\u003c/p\u003e\n\u003cp\u003eä½¿ç”¨è¿™æ ·çš„æ¡†æ¶ï¼Œèƒ½å¤Ÿä½¿Activity/Fragmentç­‰ç»„ä»¶ä¹‹é—´çš„é€šä¿¡ç®€åŒ– , ä¸ç”¨å†åƒä»¥å‰ä¸€ç›´ä½¿ç”¨ \u003ccode\u003eintent\u003c/code\u003e æ¥ä¼ é€æ•°æ® , ä»è€Œæå‡å¼€å‘æ•ˆç‡ã€‚\u003c/p\u003e\n\u003ch2 id=\"1é…ç½®ä¾èµ–\"\u003e1.é…ç½®ä¾èµ–\u003c/h2\u003e\n\u003cp\u003eåœ¨appå±‚çš„ \u003ccode\u003ebuild.gradle\u003c/code\u003e ä¸­æ·»åŠ  :\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eimplementation\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"n\"\u003eorg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egreenrobot\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"n\"\u003eeventbus\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"n\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003e1\u003c/span\u003e\u003cspan class=\"err\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"2åˆæ­¥ä½¿ç”¨\"\u003e2.åˆæ­¥ä½¿ç”¨\u003c/h2\u003e\n\u003cp\u003eæ ¹æ®å®˜æ–¹æ–‡æ¡£ , é¦–å…ˆè¦å®šä¹‰ä¸€ä¸ª\u003ccode\u003eEvent(æ¶ˆæ¯)\u003c/code\u003eçš„POJOç±» :\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eMessageEvent\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003emessage\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eMessageEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003emessage\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003emessage\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003emessage\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003egetMessage\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003emessage\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003esetMessage\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003emessage\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003emessage\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003emessage\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eç„¶å , æˆ‘ä»¬è¦æ˜ç¡®å“ªä¸ªç»„ä»¶æ˜¯ \u003ccode\u003eSubsriber(è§‚å¯Ÿè€…)\u003c/code\u003e,  å“ªä¸ªç»„ä»¶æ˜¯\u003ccode\u003ePublisher(è¢«è§‚å¯Ÿè€…)\u003c/code\u003e ,  åœ¨è¿™é‡Œ , æˆ‘ä»¬é€šè¿‡EventBusæ¼”ç¤ºä¸€ä¸ªä¼ é€æ¶ˆæ¯çš„demoã€‚\u003c/p\u003e","title":"EventBusä½¿ç”¨è¯¦è§£åŠæºç è§£æ"},{"content":"ARGB A æ˜¯ alphaï¼Œé€æ˜åº¦ã€‚ RGB æ˜¯ Redã€Greenã€Blueï¼Œçº¢è‰²ã€ç»¿è‰²ã€è“è‰²ï¼Œä¸‰ç§åŸè‰²ã€‚\nBitmap.Config æœ‰å››ç§æšä¸¾ç±»å‹ã€‚ ARGB_8888ï¼šARGB å››ä¸ªé€šé“çš„å€¼éƒ½æ˜¯ 8 ä½ï¼ŒåŠ èµ·æ¥ 32 ä½ï¼Œä¹Ÿå°±æ˜¯ 4 ä¸ªå­—èŠ‚ã€‚æ¯ä¸ªåƒç´ ç‚¹å ç”¨ 4 ä¸ªå­—èŠ‚çš„å¤§å°ã€‚ ARGB_4444ï¼šARGB å››ä¸ªé€šé“çš„å€¼éƒ½æ˜¯ 4 ä½ï¼ŒåŠ èµ·æ¥ 16 ä½ï¼Œä¹Ÿå°±æ˜¯ 2 ä¸ªå­—èŠ‚ã€‚æ¯ä¸ªåƒç´ ç‚¹å ç”¨ 2 ä¸ªå­—èŠ‚çš„å¤§å°ã€‚ RGB_565ï¼šRGB ä¸‰ä¸ªé€šé“åˆ†åˆ«æ˜¯ 5 ä½ã€6 ä½ã€5 ä½ï¼Œæ²¡æœ‰ A é€šé“ï¼ŒåŠ èµ·æ¥ 16 ä½ï¼Œä¹Ÿå°±æ˜¯ 2 ä¸ªå­—èŠ‚ã€‚æ¯ä¸ªåƒç´ ç‚¹å ç”¨ 2 ä¸ªå­—èŠ‚çš„å¤§å°ã€‚ ALPHA_8ï¼šåªæœ‰ A é€šé“ï¼Œå  8 ä½ï¼Œ1 ä¸ªå­—èŠ‚ã€‚æ¯ä¸ªåƒç´ ç‚¹å ç”¨ 1 ä¸ªå­—èŠ‚çš„å¤§å°ã€‚ é‚£åˆ°åº•ç”¨å“ªä¸ªå‘¢ï¼Ÿ å¾ˆæ˜æ˜¾ ARGB_8888 çš„å›¾ç‰‡æ˜¯è´¨é‡æœ€é«˜çš„ï¼Œä½†ä¹Ÿæ˜¯å ç”¨å†…å­˜æœ€å¤§çš„ã€‚\nå¦‚æœæƒ³è¦èŠ‚çœå†…å­˜ï¼Œå¯ä»¥ä½¿ç”¨ ARGB_4444 æˆ–è€… RGB_565ã€‚å®ƒä»¬ç›¸æ¯” ARGB_8888 å†…å­˜å ç”¨éƒ½å°äº†ä¸€åŠã€‚ ARGB_4444 å›¾ç‰‡çš„å¤±çœŸæ˜¯æ¯”è¾ƒä¸¥é‡çš„ã€‚ RGB_565 å›¾ç‰‡çš„å¤±çœŸè™½ç„¶å¾ˆå°ï¼Œä½†æ˜¯æ²¡æœ‰é€æ˜åº¦ã€‚\nALPHA_8 åªæœ‰é€æ˜åº¦ï¼Œæ²¡æœ‰é¢œè‰²å€¼ã€‚å¯¹äºåœ¨å›¾ç‰‡ä¸Šè®¾ç½®é®ç›–çš„æ•ˆæœçš„æ˜¯æœ‰å¾ˆæœ‰ç”¨ã€‚\næ€»ç»“ä¸€ä¸‹ï¼ ARGB_4444 å›¾ç‰‡å¤±çœŸä¸¥é‡ï¼ŒåŸºæœ¬ä¸ç”¨ï¼ ALPHA_8 ä½¿ç”¨åœºæ™¯æ¯”è¾ƒç‰¹æ®Šï¼ å¦‚æœä¸è®¾ç½®é€æ˜åº¦ï¼ŒRGB_565æ˜¯ä¸ªä¸é”™é€‰æ‹©ï¼ æ—¢è¦è®¾ç½®é€æ˜åº¦ï¼Œå¯¹å›¾ç‰‡è´¨é‡è¦æ±‚åˆé«˜çš„åŒ–ï¼Œé‚£å°±ç”¨ ARGB_8888 !\n","permalink":"https://chenyongda2018.github.io/posts/android/android%E9%A2%9C%E8%89%B2%E6%A0%BC%E5%BC%8F%E5%8C%BA%E5%88%AB/","summary":"\u003ch3 id=\"argb\"\u003eARGB\u003c/h3\u003e\n\u003cp\u003eA æ˜¯ alphaï¼Œé€æ˜åº¦ã€‚\nRGB æ˜¯ Redã€Greenã€Blueï¼Œçº¢è‰²ã€ç»¿è‰²ã€è“è‰²ï¼Œä¸‰ç§åŸè‰²ã€‚\u003c/p\u003e\n\u003ch4 id=\"bitmapconfig-æœ‰å››ç§æšä¸¾ç±»å‹\"\u003eBitmap.Config æœ‰å››ç§æšä¸¾ç±»å‹ã€‚\u003c/h4\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eARGB_8888\u003c/strong\u003eï¼šARGB å››ä¸ªé€šé“çš„å€¼éƒ½æ˜¯ 8 ä½ï¼ŒåŠ èµ·æ¥ 32 ä½ï¼Œä¹Ÿå°±æ˜¯ 4 ä¸ªå­—èŠ‚ã€‚æ¯ä¸ªåƒç´ ç‚¹å ç”¨ 4 ä¸ªå­—èŠ‚çš„å¤§å°ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eARGB_4444\u003c/strong\u003eï¼šARGB å››ä¸ªé€šé“çš„å€¼éƒ½æ˜¯ 4 ä½ï¼ŒåŠ èµ·æ¥ 16 ä½ï¼Œä¹Ÿå°±æ˜¯ 2 ä¸ªå­—èŠ‚ã€‚æ¯ä¸ªåƒç´ ç‚¹å ç”¨ 2 ä¸ªå­—èŠ‚çš„å¤§å°ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eRGB_565\u003c/strong\u003eï¼šRGB ä¸‰ä¸ªé€šé“åˆ†åˆ«æ˜¯ 5 ä½ã€6 ä½ã€5 ä½ï¼Œæ²¡æœ‰ A é€šé“ï¼ŒåŠ èµ·æ¥ 16 ä½ï¼Œä¹Ÿå°±æ˜¯ 2 ä¸ªå­—èŠ‚ã€‚æ¯ä¸ªåƒç´ ç‚¹å ç”¨ 2 ä¸ªå­—èŠ‚çš„å¤§å°ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eALPHA_8\u003c/strong\u003eï¼šåªæœ‰ A é€šé“ï¼Œå  8 ä½ï¼Œ1 ä¸ªå­—èŠ‚ã€‚æ¯ä¸ªåƒç´ ç‚¹å ç”¨ 1 ä¸ªå­—èŠ‚çš„å¤§å°ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch4 id=\"é‚£åˆ°åº•ç”¨å“ªä¸ªå‘¢\"\u003eé‚£åˆ°åº•ç”¨å“ªä¸ªå‘¢ï¼Ÿ\u003c/h4\u003e\n\u003cp\u003eå¾ˆæ˜æ˜¾ ARGB_8888 çš„å›¾ç‰‡æ˜¯è´¨é‡æœ€é«˜çš„ï¼Œä½†ä¹Ÿæ˜¯å ç”¨å†…å­˜æœ€å¤§çš„ã€‚\u003c/p\u003e\n\u003cp\u003eå¦‚æœæƒ³è¦èŠ‚çœå†…å­˜ï¼Œå¯ä»¥ä½¿ç”¨ ARGB_4444 æˆ–è€… RGB_565ã€‚å®ƒä»¬ç›¸æ¯” ARGB_8888 å†…å­˜å ç”¨éƒ½å°äº†ä¸€åŠã€‚\nARGB_4444 å›¾ç‰‡çš„å¤±çœŸæ˜¯æ¯”è¾ƒä¸¥é‡çš„ã€‚\nRGB_565 å›¾ç‰‡çš„å¤±çœŸè™½ç„¶å¾ˆå°ï¼Œä½†æ˜¯æ²¡æœ‰é€æ˜åº¦ã€‚\u003c/p\u003e\n\u003cp\u003eALPHA_8 åªæœ‰é€æ˜åº¦ï¼Œæ²¡æœ‰é¢œè‰²å€¼ã€‚å¯¹äºåœ¨å›¾ç‰‡ä¸Šè®¾ç½®é®ç›–çš„æ•ˆæœçš„æ˜¯æœ‰å¾ˆæœ‰ç”¨ã€‚\u003c/p\u003e\n\u003cp\u003eæ€»ç»“ä¸€ä¸‹ï¼\nARGB_4444 å›¾ç‰‡å¤±çœŸä¸¥é‡ï¼ŒåŸºæœ¬ä¸ç”¨ï¼\nALPHA_8 ä½¿ç”¨åœºæ™¯æ¯”è¾ƒç‰¹æ®Šï¼\nå¦‚æœä¸è®¾ç½®é€æ˜åº¦ï¼ŒRGB_565æ˜¯ä¸ªä¸é”™é€‰æ‹©ï¼\næ—¢è¦è®¾ç½®é€æ˜åº¦ï¼Œå¯¹å›¾ç‰‡è´¨é‡è¦æ±‚åˆé«˜çš„åŒ–ï¼Œé‚£å°±ç”¨ ARGB_8888 !\u003c/p\u003e","title":"Androidé¢œè‰²æ ¼å¼åŒºåˆ«"},{"content":"ä¸€.ä»€ä¹ˆæ˜¯å†…å­˜æ³„æ¼ å†…å­˜æ³„æ¼ï¼ˆè‹±è¯­ï¼šMemory leakï¼‰æ˜¯åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼Œç”±äºç–å¿½æˆ–é”™è¯¯é€ æˆç¨‹åºæœªèƒ½é‡Šæ”¾å·²ç»ä¸å†ä½¿ç”¨çš„å†…å­˜ã€‚ â€” â€” â€” ç»´åŸºç™¾ç§‘\näºŒ.å†…å­˜æ³„æ¼çš„å½±å“ ä½¿å¾—åº”ç”¨ç¨‹åºå®¹æ˜“å‘ç”Ÿ OOM\nAndroidç³»ç»Ÿä¸ºæ¯ä¸ªåº”ç”¨åˆ†é…çš„å†…å­˜æœ‰é™ï¼Œè‹¥ç¨‹åºçš„å‘ç”Ÿçš„å†…å­˜æ³„æ¼è¾ƒå¤š,ä¼šå¯¼è‡´æ‰€éœ€çš„å†…å­˜è¶…è¿‡ç³»ç»Ÿæ‰€ç»™çš„é™é¢ã€‚ æœ€ç»ˆ:OOM â†’ Crash\nä¸‰. GC Roots å¯¹äºä½¿ç”¨å¯è¾¾æ€§åˆ†æçš„åƒåœ¾å›æ”¶ç®—æ³•æ¥è¯´ï¼ŒGC rootsæ˜¯ä¸€ä¸ªæ¯”è¾ƒç‰¹åˆ«çš„å­˜åœ¨ï¼Œå®ƒç”¨æ¥å¸®åŠ©GCåˆ¤æ–­å“ªäº›å¯¹è±¡å¯ä»¥è¢«å›æ”¶ï¼Œå¦‚æœè¿™ä¸ªå¯¹è±¡è¢«æ˜¯GC roots æˆ–è€…è¢«GC rootså¼•ç”¨å°±ä¸ä¼šè¢«å›æ”¶ã€‚\nå“ªäº›å¯ä»¥ä½œä¸ºGC roots?\nClass : è¢«ç³»ç»ŸClassLoaderåŠ è½½çš„class,è‡ªå®šä¹‰çš„ClassLoaderåŠ è½½çš„classä¸æ˜¯GC roots, æ³¨æ„:é™æ€å˜é‡æ˜¯å±äºç±»çš„ã€‚ Thread: å¤„äºæ´»åŠ¨çŠ¶æ€çš„çº¿ç¨‹. Stack Local: æ–¹æ³•ä¸­çš„å˜é‡å’Œå‚æ•°. JNI Local: JNIæ–¹æ³•ä¸­çš„å˜é‡å’Œå‚æ•°. JNI Global: å…¨å±€çš„JNI reference,ä¹Ÿå°±æ˜¯JNIä¸­å…¨å±€åˆ›å»ºçš„å¼•ç”¨. Monitor Used: åŒæ­¥çš„å¯¹è±¡,ä¾‹å¦‚è¢« Synchronized é”ä½çš„å¯¹è±¡. Held by JVM: å–å†³äºå„ä¸ªJVMçš„å®ç°,ç³»ç»Ÿçš„ClassLoaderå’ŒJVMæœ¬èº«ä¼šç”¨åˆ°çš„ä¸€äº›å¯¹è±¡. åœ¨å¼€å‘ä¸­æœ€å¸¸è§çš„å°±æ˜¯æ–¹æ³•ä¸­çš„å˜é‡ä½œä¸ºGC roots,å¦‚ä¸‹ä»£ç :\næˆ‘ä»¬åˆ›å»ºäº†80Må¤§å°çš„å†…å­˜åŒºåŸŸå¹¶ç”¨å˜é‡ bæŒ‡å‘è¿™å—åŒºåŸŸï¼Œç„¶åæˆ‘ä»¬è°ƒç”¨gcã€‚\nåƒåœ¾å›æ”¶å™¨é¦–å…ˆè¿›è¡Œäº†ä¸€æ¬¡Minor GCï¼Œlogä¸­å¯ä»¥çœ‹åˆ°å¹´è½»ä»£ä»3932K é™åˆ°äº† 560Kï¼Œç„¶åå¯¹è±¡bè½¬ç§»åˆ°äº†è€å¹´ä»£ã€‚\néšååƒåœ¾å›æ”¶å™¨åˆè¿›è¡Œäº†ä¸€æ¬¡Full GC,è€å¹´ä»£ä¸­çš„å†…å­˜ä»81.9M é™åˆ° 439K, ä¹Ÿå°±æ˜¯æˆ‘ä»¬åˆ›å»ºçš„80Må†…å­˜è¢«æ­£å¸¸å›æ”¶äº†ã€‚\nå†çœ‹ä¸‹é¢ä¸€æ®µä»£ç \nå¯ä»¥çœ‹åˆ°åœ¨Full GCæ—¶,åˆ†é…çš„80Må†…å­˜å¹¶æ²¡æœ‰è¢«å›æ”¶ã€‚\nåŸå› : ByteArrayå¯¹è±¡è¢«ä½œä¸ºGC rootsçš„å˜é‡bæŒæœ‰ï¼Œæ— æ³•è¢«å›æ”¶\nå››.å†…å­˜æ³„æ¼ in Android å†…å­˜æ³„æ¼çš„æ ¹æœ¬åŸå› åœ¨äºå¯¹è±¡å§‹ç»ˆè¢«GC rootså¼•ç”¨ï¼Œæˆ–è€…æœ¬èº«ä½œä¸ºGC rootså½“ä¸åœ¨ä½¿ç”¨æ—¶æ²¡æœ‰æ­£ç¡®ç½®ç©ºæˆ–é‡Šæ”¾ã€‚\næŒæœ‰Activityçš„GC rootsçš„å¼•ç”¨é“¾å¦‚ä¸‹å›¾\nActivityè¢«ç½®ç©ºçš„æ—¶æœº:\nåœ¨onDestory()æ–¹æ³•æ‰§è¡Œæ—¶,ActivityThreadé€šè¿‡handleDestroyActivity()æ–¹æ³•å°† Activityç½®ç©º\né‚£ä¹ˆActivityè¢«å¼•ç”¨è€…ç½®ç©ºåï¼Œå¯¹GC rootså°±ä¸å¯è¾¾ï¼Œå¯ä»¥æ­£å¸¸è¢«å›æ”¶ã€‚\n1.Handlerä½¿ç”¨ä¸è§„èŒƒ å†…éƒ¨ç±»/åŒ¿åå†…éƒ¨ç±» éšå¼æŒæœ‰å¤–éƒ¨ç±»çš„å¼•ç”¨\nActivity â†’ Handler â†’ Message â†’ MessageQueue â†’ Looper()ï¼Œæœ‰Looper()å­˜åœ¨äºæ•´ä¸ªåº”ç”¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ‰€ä»¥ï¼Œå¦‚æœActivityé”€æ¯æ—¶ï¼ŒHandlerå‘é€çš„æ¶ˆæ¯è¿˜æœªå¾—åˆ°Looper()å¤„ç†ï¼Œå°†å¯¼è‡´Activityæ³„æ¼\nå†…éƒ¨ç±»é™æ€åŒ– + WeakReference\nè‹¥åƒåœ¾æ”¶é›†å™¨å‘ç°ä¸€ä¸ªå¯¹è±¡æ˜¯å¼±å¯è¾¾çš„(weakly reachable)ï¼Œ ä¼šæ¸…é™¤æ‰€æœ‰æŒ‡å‘è¯¥ å¯¹è±¡çš„å¼±å¼•ç”¨ é€šè¿‡staticå°†å†…éƒ¨ç±»ä½œä¸ºç‹¬ç«‹äºå¤–éƒ¨ç±»çš„Class é€šè¿‡å¼±å¼•ç”¨æŒæœ‰Activity,ä¸è€½è¯¯Activityå›æ”¶ åŠæ—¶ç§»é™¤æœªå¤„ç†çš„æ¶ˆæ¯ä»¥åŠcallback æ¶ˆé™¤messageå¯¹Handlerçš„å¼•ç”¨\n2.åŒ¿åå†…éƒ¨ç±» AsyncTask Thread åŒ¿åæ¥å£å›è°ƒ åŒ¿åå†…éƒ¨ç±»ä¸å†…éƒ¨ç±»éƒ½ä¼šéšå¼æŒæœ‰å¤–éƒ¨ç±»å¼•ç”¨\n3.å•ä¾‹æ¨¡å¼ å•ä¾‹æ¨¡å¼çš„ç”Ÿå‘½å‘¨æœŸ = æ•´ä¸ªappè¿è¡Œæ—¶,\nè‹¥éœ€è¦å¼•ç”¨contextï¼Œè¯·ä½¿ç”¨applicationContext\n4.æ³¨å†Œçš„ç›‘å¬å™¨æœªæ³¨é”€ EventBus class MainActivity : AppCompatActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) EventBus.getInstance().register(this) } } åœ¨Activityé”€æ¯æ—¶éœ€unregister(this)\nSensorManger void registerListener() { SensorManager sensorManager = (SensorManager) getSystemService(SENSOR_SERVICE); Sensor sensor = sensorManager.getDefaultSensor(Sensor.TYPE_ALL); sensorManager.registerListener(this, sensor, SensorManager.SENSOR_DELAY_FASTEST); } View smButton = findViewById(R.id.sm_button); smButton.setOnClickListener(new View.OnClickListener() { @Override public void onClick(View v) { registerListener(); nextActivity(); } }); åœ¨Activityé”€æ¯æ—¶éœ€SensorManger.unregisterListener(this)\nContentObserver\ngetContentResolver().registerContentObserver( SOME_URI, true, yourObserver); getContentResolver().unregisterContentObserver(yourObserver); 5. èµ„æºå¯¹è±¡æœªåŠæ—¶å…³é—­ file cursor bitmap \u0026hellip; å…­.å†…å­˜æ³„æ¼åˆ†æå·¥å…· Android Studio Monitor\nLeakCanary\n","permalink":"https://chenyongda2018.github.io/posts/android/android_memory_leak/","summary":"\u003ch2 id=\"ä¸€ä»€ä¹ˆæ˜¯å†…å­˜æ³„æ¼\"\u003eä¸€.ä»€ä¹ˆæ˜¯å†…å­˜æ³„æ¼\u003c/h2\u003e\n\u003cp\u003e\u003ccode\u003eå†…å­˜æ³„æ¼\u003c/code\u003eï¼ˆè‹±è¯­ï¼šMemory leakï¼‰æ˜¯åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼Œç”±äºç–å¿½æˆ–é”™è¯¯é€ æˆç¨‹åºæœªèƒ½é‡Šæ”¾å·²ç»ä¸å†ä½¿ç”¨çš„å†…å­˜ã€‚                                                                                                                 â€” â€” â€” ç»´åŸºç™¾ç§‘\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"Untitled\" loading=\"lazy\" src=\"https://tva1.sinaimg.cn/large/008i3skNly1gugdlcd1bij60i20b4wet02.jpg\"\u003e\u003c/p\u003e\n\u003ch2 id=\"äºŒå†…å­˜æ³„æ¼çš„å½±å“\"\u003eäºŒ.å†…å­˜æ³„æ¼çš„å½±å“\u003c/h2\u003e\n\u003cp\u003eä½¿å¾—åº”ç”¨ç¨‹åºå®¹æ˜“å‘ç”Ÿ \u003ccode\u003eOOM\u003c/code\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eAndroidç³»ç»Ÿä¸ºæ¯ä¸ªåº”ç”¨åˆ†é…çš„å†…å­˜æœ‰é™ï¼Œè‹¥ç¨‹åºçš„å‘ç”Ÿçš„å†…å­˜æ³„æ¼è¾ƒå¤š,ä¼šå¯¼è‡´æ‰€éœ€çš„å†…å­˜è¶…è¿‡ç³»ç»Ÿæ‰€ç»™çš„é™é¢ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eæœ€ç»ˆ:OOM â†’ Crash\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"Untitled 1\" loading=\"lazy\" src=\"https://tva1.sinaimg.cn/large/008i3skNly1guge4uumelj609l0gy0sy02.jpg\"\u003e\u003c/p\u003e\n\u003ch2 id=\"ä¸‰-gc-roots\"\u003eä¸‰. GC Roots\u003c/h2\u003e\n\u003cp\u003eå¯¹äºä½¿ç”¨å¯è¾¾æ€§åˆ†æçš„åƒåœ¾å›æ”¶ç®—æ³•æ¥è¯´ï¼ŒGC rootsæ˜¯ä¸€ä¸ªæ¯”è¾ƒç‰¹åˆ«çš„å­˜åœ¨ï¼Œå®ƒç”¨æ¥å¸®åŠ©GCåˆ¤æ–­å“ªäº›å¯¹è±¡å¯ä»¥è¢«å›æ”¶ï¼Œå¦‚æœè¿™ä¸ªå¯¹è±¡è¢«æ˜¯GC roots æˆ–è€…è¢«GC rootså¼•ç”¨å°±ä¸ä¼šè¢«å›æ”¶ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"Untitled 2\" loading=\"lazy\" src=\"https://tva1.sinaimg.cn/large/008i3skNly1guge6kkyjoj61060j440402.jpg\"\u003e\u003c/p\u003e\n\u003cp\u003eå“ªäº›å¯ä»¥ä½œä¸ºGC roots?\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eClass :\u003c/strong\u003e è¢«ç³»ç»ŸClassLoaderåŠ è½½çš„class,è‡ªå®šä¹‰çš„ClassLoaderåŠ è½½çš„classä¸æ˜¯GC roots, æ³¨æ„:é™æ€å˜é‡æ˜¯å±äºç±»çš„ã€‚\u003c/li\u003e\n\u003cli\u003eThread: å¤„äºæ´»åŠ¨çŠ¶æ€çš„çº¿ç¨‹.\u003c/li\u003e\n\u003cli\u003eStack Local: æ–¹æ³•ä¸­çš„å˜é‡å’Œå‚æ•°.\u003c/li\u003e\n\u003cli\u003eJNI Local: JNIæ–¹æ³•ä¸­çš„å˜é‡å’Œå‚æ•°.\u003c/li\u003e\n\u003cli\u003eJNI Global: å…¨å±€çš„JNI reference,ä¹Ÿå°±æ˜¯JNIä¸­å…¨å±€åˆ›å»ºçš„å¼•ç”¨.\u003c/li\u003e\n\u003cli\u003eMonitor Used: åŒæ­¥çš„å¯¹è±¡,ä¾‹å¦‚è¢« \u003ccode\u003eSynchronized\u003c/code\u003e  é”ä½çš„å¯¹è±¡.\u003c/li\u003e\n\u003cli\u003eHeld by JVM: å–å†³äºå„ä¸ªJVMçš„å®ç°,ç³»ç»Ÿçš„ClassLoaderå’ŒJVMæœ¬èº«ä¼šç”¨åˆ°çš„ä¸€äº›å¯¹è±¡.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eåœ¨å¼€å‘ä¸­æœ€å¸¸è§çš„å°±æ˜¯æ–¹æ³•ä¸­çš„å˜é‡ä½œä¸ºGC roots,å¦‚ä¸‹ä»£ç :\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"Untitled 3\" loading=\"lazy\" src=\"https://tva1.sinaimg.cn/large/008i3skNly1guge6uh97bj60w809smyg02.jpg\"\u003e\u003c/p\u003e\n\u003cp\u003eæˆ‘ä»¬åˆ›å»ºäº†80Må¤§å°çš„å†…å­˜åŒºåŸŸå¹¶ç”¨å˜é‡ bæŒ‡å‘è¿™å—åŒºåŸŸï¼Œç„¶åæˆ‘ä»¬è°ƒç”¨gcã€‚\u003c/p\u003e\n\u003cp\u003eåƒåœ¾å›æ”¶å™¨é¦–å…ˆè¿›è¡Œäº†ä¸€æ¬¡Minor GCï¼Œlogä¸­å¯ä»¥çœ‹åˆ°å¹´è½»ä»£ä»3932K é™åˆ°äº† 560Kï¼Œç„¶åå¯¹è±¡bè½¬ç§»åˆ°äº†è€å¹´ä»£ã€‚\u003c/p\u003e\n\u003cp\u003eéšååƒåœ¾å›æ”¶å™¨åˆè¿›è¡Œäº†ä¸€æ¬¡Full GC,è€å¹´ä»£ä¸­çš„å†…å­˜ä»81.9M é™åˆ° 439K, ä¹Ÿå°±æ˜¯æˆ‘ä»¬åˆ›å»ºçš„80Må†…å­˜è¢«æ­£å¸¸å›æ”¶äº†ã€‚\u003c/p\u003e","title":"Androidå†…å­˜æ³„æ¼æ¢ç©¶"},{"content":"1.å¸ƒå±€ä¼˜åŒ– æ·±å…¥æ¢ç´¢Androidå¸ƒå±€ä¼˜åŒ–ï¼ˆä¸Šï¼‰ æ·±å…¥æ¢ç´¢Androidå¸ƒå±€ä¼˜åŒ–ï¼ˆä¸­ï¼‰ æ·±å…¥æ¢ç´¢Androidå¸ƒå±€ä¼˜åŒ–ï¼ˆä¸‹ï¼‰ 2.ç»˜åˆ¶ä¼˜åŒ– Androidæ€§èƒ½ä¼˜åŒ–ä¹‹ç»˜åˆ¶ä¼˜åŒ– 3.å¡é¡¿ä¼˜åŒ– æ·±å…¥æ¢ç´¢Androidå¡é¡¿ä¼˜åŒ–ï¼ˆä¸Šï¼‰ æ·±å…¥æ¢ç´¢Androidå¡é¡¿ä¼˜åŒ–ï¼ˆä¸‹ï¼‰ 4.å†…å­˜ä¼˜åŒ– æ·±å…¥æ¢ç´¢ Android å†…å­˜ä¼˜åŒ–ï¼ˆç‚¼ç‹±çº§åˆ«-ä¸Šï¼‰ æ·±å…¥æ¢ç´¢ Android å†…å­˜ä¼˜åŒ–ï¼ˆç‚¼ç‹±çº§åˆ«-ä¸‹ï¼‰ 5.å¯åŠ¨é€Ÿåº¦ä¼˜åŒ– æ·±å…¥æ¢ç´¢Androidå¯åŠ¨é€Ÿåº¦ä¼˜åŒ–ï¼ˆä¸Šï¼‰ æ·±å…¥æ¢ç´¢Androidå¯åŠ¨é€Ÿåº¦ä¼˜åŒ–ï¼ˆä¸‹ï¼‰ 6.åŒ…ä½“ç§¯ä¼˜åŒ– æ·±å…¥æ¢ç´¢ Android åŒ…ä½“ç§¯ä¼˜åŒ–ï¼ˆåŒ å¿ƒåˆ¶ä½œ-ä¸Šï¼‰ æ·±å…¥æ¢ç´¢ Android åŒ…ä½“ç§¯ä¼˜åŒ–ï¼ˆåŒ å¿ƒåˆ¶ä½œ-ä¸‹ï¼‰ åŒ…ä½“ç§¯ä¼˜åŒ– Â· å·¥å…·è®º Â· åˆè¯†åŒ…ä½“ç§¯ä¼˜åŒ– åŒ…ä½“ç§¯ä¼˜åŒ– Â· æ–¹æ³•è®º Â· æ­å¼€åŒ…ä½“ç§¯ä¼˜åŒ–ç¥ç§˜é¢çº± åŒ…ä½“ç§¯ä¼˜åŒ– Â· å®æˆ˜è®º Â· æ€ä¹ˆåšåŒ…ä½“ç§¯ä¼˜åŒ–? åŒ…ä½“ç§¯ä¼˜åŒ– Â· å½©è›‹ç¯‡ Â· Androidç¼–è¯‘æœŸPNGè‡ªåŠ¨åŒ–è½¬æ¢WEBP 7.APM APMç›‘æ§ Â· å…¥é—¨ç¯‡ Â· Androidç«¯æµ‹ç›‘æ§å¹³å°å»ºè®¾ å¡é¡¿ç›‘æµ‹ Â· æ–¹æ¡ˆç¯‡ Â· Androidå¡é¡¿ç›‘æµ‹æŒ‡å¯¼åŸåˆ™ ","permalink":"https://chenyongda2018.github.io/posts/android/android_performance/","summary":"\u003ch2 id=\"1å¸ƒå±€ä¼˜åŒ–\"\u003e1.å¸ƒå±€ä¼˜åŒ–\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://juejin.cn/post/6844904047355363341\"\u003eæ·±å…¥æ¢ç´¢Androidå¸ƒå±€ä¼˜åŒ–ï¼ˆä¸Šï¼‰\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://juejin.cn/post/6870445845834104846\"\u003eæ·±å…¥æ¢ç´¢Androidå¸ƒå±€ä¼˜åŒ–ï¼ˆä¸­ï¼‰\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://juejin.cn/post/6844904048068395015\"\u003eæ·±å…¥æ¢ç´¢Androidå¸ƒå±€ä¼˜åŒ–ï¼ˆä¸‹ï¼‰\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"2ç»˜åˆ¶ä¼˜åŒ–\"\u003e2.ç»˜åˆ¶ä¼˜åŒ–\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://juejin.cn/post/6844904080989487118#heading-47\"\u003eAndroidæ€§èƒ½ä¼˜åŒ–ä¹‹ç»˜åˆ¶ä¼˜åŒ–\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"3å¡é¡¿ä¼˜åŒ–\"\u003e3.å¡é¡¿ä¼˜åŒ–\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://juejin.cn/post/6844904062610046990\"\u003eæ·±å…¥æ¢ç´¢Androidå¡é¡¿ä¼˜åŒ–ï¼ˆä¸Šï¼‰\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://juejin.cn/post/6844904066259091469\"\u003eæ·±å…¥æ¢ç´¢Androidå¡é¡¿ä¼˜åŒ–ï¼ˆä¸‹ï¼‰\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"4å†…å­˜ä¼˜åŒ–\"\u003e4.å†…å­˜ä¼˜åŒ–\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://juejin.cn/post/6844904099998089230\"\u003eæ·±å…¥æ¢ç´¢ Android å†…å­˜ä¼˜åŒ–ï¼ˆç‚¼ç‹±çº§åˆ«-ä¸Šï¼‰\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://juejin.cn/post/6872919545728729095\"\u003eæ·±å…¥æ¢ç´¢ Android å†…å­˜ä¼˜åŒ–ï¼ˆç‚¼ç‹±çº§åˆ«-ä¸‹ï¼‰\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"5å¯åŠ¨é€Ÿåº¦ä¼˜åŒ–\"\u003e5.å¯åŠ¨é€Ÿåº¦ä¼˜åŒ–\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://juejin.cn/post/6844904093786308622\"\u003eæ·±å…¥æ¢ç´¢Androidå¯åŠ¨é€Ÿåº¦ä¼˜åŒ–ï¼ˆä¸Šï¼‰\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://juejin.cn/post/6844904093786308622\"\u003eæ·±å…¥æ¢ç´¢Androidå¯åŠ¨é€Ÿåº¦ä¼˜åŒ–ï¼ˆä¸‹ï¼‰\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"6åŒ…ä½“ç§¯ä¼˜åŒ–\"\u003e6.åŒ…ä½“ç§¯ä¼˜åŒ–\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://juejin.cn/post/7176622003888226362#heading-33\"\u003eæ·±å…¥æ¢ç´¢ Android åŒ…ä½“ç§¯ä¼˜åŒ–ï¼ˆåŒ å¿ƒåˆ¶ä½œ-ä¸Šï¼‰\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://juejin.cn/post/6872920643797680136\"\u003eæ·±å…¥æ¢ç´¢ Android åŒ…ä½“ç§¯ä¼˜åŒ–ï¼ˆåŒ å¿ƒåˆ¶ä½œ-ä¸‹ï¼‰\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://juejin.cn/post/7176622003888226362#heading-33\"\u003eåŒ…ä½“ç§¯ä¼˜åŒ– Â· å·¥å…·è®º Â· åˆè¯†åŒ…ä½“ç§¯ä¼˜åŒ–\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://juejin.cn/post/7177195746272215098\"\u003eåŒ…ä½“ç§¯ä¼˜åŒ– Â· æ–¹æ³•è®º Â· æ­å¼€åŒ…ä½“ç§¯ä¼˜åŒ–ç¥ç§˜é¢çº±\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://juejin.cn/post/7179230851853451323\"\u003eåŒ…ä½“ç§¯ä¼˜åŒ– Â· å®æˆ˜è®º Â· æ€ä¹ˆåšåŒ…ä½“ç§¯ä¼˜åŒ–?\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://juejin.cn/post/6897894068068876295\"\u003eåŒ…ä½“ç§¯ä¼˜åŒ– Â· å½©è›‹ç¯‡ Â· Androidç¼–è¯‘æœŸPNGè‡ªåŠ¨åŒ–è½¬æ¢WEBP\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"7apm\"\u003e7.APM\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://juejin.cn/post/6844904163600498701\"\u003eAPMç›‘æ§ Â· å…¥é—¨ç¯‡ Â· Androidç«¯æµ‹ç›‘æ§å¹³å°å»ºè®¾\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://juejin.cn/post/7214635327407308859\"\u003eå¡é¡¿ç›‘æµ‹ Â· æ–¹æ¡ˆç¯‡ Â· Androidå¡é¡¿ç›‘æµ‹æŒ‡å¯¼åŸåˆ™\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e","title":"Androidæ€§èƒ½ä¼˜åŒ–æ–‡ç« "},{"content":"Kotlin lambda Kotlinä¸­ï¼Œå……æ–¥ç€å„ç§å„æ ·çš„Lambda è¡¨è¾¾å¼ï¼Œè¿™æ˜¯Kotlinæœ€æ–¹ä¾¿çš„ç‰¹æ€§ä¹‹ä¸€\näº†è§£Kotlin ä¸­çš„lambdaï¼Œé¦–å…ˆå¾—çŸ¥é“Kotlinä¸­çš„é«˜é˜¶å‡½æ•°\n1.é«˜é˜¶å‡½æ•° åœ¨Javaä¸­ï¼Œå¦‚æœæœ‰ä¸€ä¸ªaæ–¹æ³•ï¼Œè¦å»è°ƒç”¨bæ–¹æ³•ï¼Œé‚£ä¹ˆåœ¨é‡Œé¢ç›´æ¥è°ƒç”¨å³å¯ã€‚\nint a() { return b(1); } a(); æ¥ç€,å¦‚æœæˆ‘ä¸æƒ³æŠŠè°ƒç”¨bæ–¹æ³•çš„å‚æ•°å†™æ­»ï¼Œå¸Œæœ›åŠ¨æ€è®¾ç½®æ–¹æ³•bçš„å‚æ•°ã€‚\nint a(int param) { return b(param); } a(1); a(2); è¿™äº›åœ¨Javaä¸­å¾ˆè½»æ¾å°±èƒ½åšåˆ°ï¼Œä¸è¿‡\u0026hellip; å¦‚æœæˆ‘ä»¬æƒ³åŠ¨æ€è®¾ç½®çš„ä¸æ˜¯æ–¹æ³•å‚æ•°ï¼Œè€Œæ˜¯æ–¹æ³•æœ¬èº«å‘¢ï¼Œæ¯”å¦‚åœ¨æ–¹æ³•aå†…æœ‰ä¸€å¤„å¯¹åˆ«çš„æ–¹æ³•çš„è°ƒç”¨ï¼Œè¿™ä¸ªæ–¹æ³•å¯èƒ½æ˜¯æ–¹æ³•b,æ–¹æ³•c,æ–¹æ³•d\u0026hellip;,è¯¥æ–¹æ³•çš„å‚æ•°ç±»å‹æ˜¯int,è¿”å›å€¼ç±»å‹ä¹Ÿæ˜¯intã€‚æ–¹æ³•aåœ¨æ‰§è¡Œæ—¶ï¼Œå…·ä½“éœ€è¦è°ƒç”¨å“ªä¸ªæ–¹æ³•ï¼Œèƒ½å¦åŠ¨æ€è®¾ç½®? ä¹Ÿå°±æ˜¯è¯´èƒ½å¦å°†ä¸€ä¸ªæ–¹æ³•ä½œä¸ºå‚æ•°ä¼ ç»™a?\né€šè¿‡æ¥å£\npublic interface Wrapper { int method(int param); } å°†è¿™ä¸ªæ¥å£ç±»å‹Wrapper ä½œä¸ºæ–¹æ³•açš„å‚æ•°\nint a(Wrapper wrapper) { return wrapper.method(1); } a(wrapper1); a(wrapper2); ä¸¾ä¸ªæˆ‘ä»¬å¸¸è§çš„ä¾‹å­\nåœ¨Androidé‡ŒViewçš„ç‚¹å‡»äº‹ä»¶\npublic class View { OnClickListener mOnClickListener; ... public void onTouchEvent(MotionEvent e) { ... mOnClickListener.onClick(this); ... } } OnClickListenerå°±æ˜¯ä¸€ä¸ªæ¥å£ï¼Œç‚¹å‡»äº‹ä»¶çš„å†…å®¹å…¨åœ¨onClick()æ–¹æ³•é‡Œ\npublic interface OnClickListener { void onClick(View v); } æˆ‘ä»¬åœ¨ç»™Viewè®¾ç½®ç‚¹å‡»äº‹ä»¶æ—¶ï¼Œä¼ çš„å°±æ˜¯ä¸€ä¸ªOnClickListener,æœ¬è´¨ä¸Šè¿™æ ·ä¼ é€’çš„æ˜¯ä¸€ä¸ªç¨åä¼šè¢«è°ƒç”¨çš„onClick()æ–¹æ³•,ä¸€èˆ¬ç§°ä¹‹ä¸ºå›è°ƒ,ä¸è¿‡ç”±äºJavaä¸­ä¸å…è®¸ç›´æ¥ä¼ é€’æ–¹æ³•ï¼Œæ‰€ä»¥éœ€è¦ç”¨æ¥å£åŒ…è£…ä¸€ä¸‹ã€‚\nOnClickListener listener1 = new OnClickListener() { @Override void onClick(View v) { doSomething(); } }; view.setOnClickListener(listener1); åœ¨Kotliné‡Œï¼Œå‡½æ•°æ˜¯å¯ä»¥ä½œä¸ºä¸€ä¸ªå‚æ•°è¢«ä¼ é€’çš„ :\nfun setOnClickListener(onClick: (View) -\u0026gt; Unit) { this.onClick = onClick } ğŸ‘‡ä¼ å…¥ä¸€ä¸ªåŒ¿åæ–¹æ³•ï¼Œå‚æ•°ç±»å‹æ—¶View,æ— è¿”å›å€¼ view.setOnClickListener(fun(v: View): Unit) { doSomething() }) è¿™ç§ å‚æ•°æˆ–è€…è¿”å›å€¼æ˜¯å‡½æ•°çš„å‡½æ•° åœ¨Kotlinä¸­ç§°ä¹‹ä¸ºé«˜é˜¶å‡½æ•°(Higher-Order-Functions)\n2. Lambdaè¡¨è¾¾å¼ åœ¨åˆšåˆšçš„ä»£ç ä¸­ï¼Œä¼ å…¥çš„åŒ¿åå‡½æ•°è¿˜èƒ½è¿›ä¸€æ­¥ç®€åŒ–ï¼Œå†™æˆLambdaè¡¨è¾¾å¼çš„å½¢å¼\nğŸ‘‡ç®€åŒ–åçš„åŒ¿åæ–¹æ³• view.setOnClickListener( { v: View -\u0026gt; doSomething() } ) Kotlinå…è®¸å¦‚æœLambda æ˜¯æœ€åä¸€ä¸ªå‚æ•°æ—¶ï¼ŒLambdaå¯ä»¥å†™åœ¨æ–¹æ³•()çš„å¤–é¢ï¼š\nview.setOnClickListener() { v: View -\u0026gt; doSomething() } å¦‚æœè¯¥Lambda æ˜¯å”¯ä¸€çš„å‚æ•°ï¼Œåˆ™æ–¹æ³•()å¯ä»¥çœç•¥\nview.setOnClickListener { v: View -\u0026gt; doSomething() } è¿›ä¸€æ­¥ï¼Œå¦‚æœè¯¥Lambda åªæœ‰ä¸€ä¸ªå‚æ•°ï¼Œè¯¥å‚æ•°è¿˜å¯ä»¥çœç•¥ä¸å†™, Kotlinä¸ºè¿™ç§å”¯ä¸€å‚æ•°æä¾›äº†é»˜è®¤çš„åå­—it\nview.setOnClickListener { doSomething() it.visibility = GONE } 3. ä¸ºä»€ä¹ˆKotlinä¸­å‡½æ•°å¯ä»¥ä½œä¸ºå‚æ•°è¢«ä¼ é€’? å°†åˆšæ‰çš„ä»£ç ï¼Œåç¼–è¯‘ä¸ºJava:\nğŸ‘‡å®é™…ä¼ é€’çš„æ˜¯FunctionNç±»å‹çš„å¯¹è±¡ public static final String a(@NotNull Function1 funParam) { Intrinsics.checkNotNullParameter(funParam, \u0026#34;funParam\u0026#34;); return (String)funParam.invoke(1); } interface FunctionN\u0026lt;out R\u0026gt; : Function\u0026lt;R\u0026gt;, FunctionBase\u0026lt;R\u0026gt; { operator fun invoke(vararg args: Any?): R override val arity: Int } æ‰€ä»¥ï¼Œä¹‹æ‰€ä»¥Kotlinä¸­æ–¹æ³•å¯ä»¥è¢«å½“ä½œå‚æ•° è¿›è¡Œä¼ é€’ï¼Œæ˜¯å› ä¸ºå®ƒå®é™…ä¸€ä¸ªFunctionNç±»å‹çš„å®å®åœ¨åœ¨çš„å¯¹è±¡\nå¯¹åº”å…³ç³»:\nè¡¨è¾¾å¼ FunctionN (String) -\u0026gt; Unit Function1\u0026lt;String,Int\u0026gt; (String,Int) -\u0026gt; Double Function2\u0026lt;String,Int,Double\u0026gt; \u0026hellip; \u0026hellip; (å‚æ•°1ç±»å‹,å‚æ•°2ç±»å‹..å‚æ•°nç±»å‹) -\u0026gt; è¿”å›å€¼ç±»å‹ FunctionN\u0026lt;å‚æ•°1ç±»å‹,\u0026hellip;,å‚æ•°nç±»å‹,è¿”å›å€¼ç±»å‹\u0026gt; 4.inlineå†…è”å‡½æ•° é›†åˆæ“ä½œç¬¦ filter å¯ä»¥å®šä¹‰è§„åˆ™å¯¹é›†åˆè¿›è¡Œè¿‡æ»¤\nlistOf(1,2,3,4,5,6).filter {it \u0026gt; 2} çœ‹ä¸€ä¸‹ filter æ–¹æ³•çš„å£°æ˜\npublic inline fun \u0026lt;T\u0026gt; Iterable\u0026lt;T\u0026gt;.filter(predicate: (T) -\u0026gt; Boolean): List\u0026lt;T\u0026gt; { return filterTo(ArrayList\u0026lt;T\u0026gt;(), predicate) } public inline fun \u0026lt;T, C : MutableCollection\u0026lt;in T\u0026gt;\u0026gt; Iterable\u0026lt;T\u0026gt;.filterTo(destination: C, predicate: (T) -\u0026gt; Boolean): C { for (element in this) if (predicate(element)) destination.add(element) return destination } filteræ–¹æ³•æ¥æ”¶ä¸€ä¸ª å‡½æ•°ç±»å‹çš„å‚æ•°ï¼Œå¹¶ä¸”è¿”å›å€¼æ˜¯booleanï¼Œç¬¦åˆä½¿ç”¨lambdaçš„åœºæ™¯ï¼Œä¸Šé¢æˆ‘ä»¬è¯´è¿‡ï¼Œlamdbaæ˜¯å®ç°äº†FunctionNæ¥å£çš„å¯¹è±¡ã€‚ å¦‚æœé›†åˆé‡Œæœ‰æˆç™¾ä¸Šåƒä¸ªå…ƒç´ ï¼Œé‚£æ¯æ¬¡ç»è¿‡filter éƒ½ä¼šç”ŸæˆåŒ¿åå¯¹è±¡ï¼Œæ˜¯ä¸€ä¸ªä¸å®¹å¿½è§†çš„å¼€é”€,å¼•èµ·æ€§èƒ½é—®é¢˜ã€‚ æ‰€ä»¥,Kotlinä¸­å¼•å…¥äº†å†…è”å‡½æ•°çš„æ¦‚å¿µ:\nå†…è”å‡½æ•°å›æŠŠå‡½æ•°çš„å®ç°ç›´æ¥æ‹·è´çš„è°ƒç”¨å¤„,é¿å…åˆ›å»ºåŒ¿åå†…éƒ¨ç±»ã€‚\ninline fun inlined(getString: () -\u0026gt; String) = println(getString()) fun notInlined(getString: () -\u0026gt; String) = println(getString()) fun test() { var testVar = \u0026#34;Test\u0026#34; notInlined { testVar } inlined { testVar } } ç¼–è¯‘åçš„javaä»£ç :\npublic static final void test() { final ObjectRef testVar = new ObjectRef(); testVar.element = \u0026#34;Test Variable\u0026#34;; // notInlined: //æ¯ä¸ªé—­åŒ… lamdba éƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ä¼šé¢å¤–åˆ†é…å†…å­˜ï¼Œå½±å“è¿è¡Œæ—¶é—´ notInlined((Function0)(new Function0(0) { public Object invoke() { return this.invoke(); } @NotNull public final String invoke() { return (String)testVar.element; } })); // inlined:ä¼šç›´æ¥å°†æ–¹æ³•ä½“å¤åˆ¶åˆ°è°ƒç”¨å¤„ï¼Œ String var3 = (String)testVar.element; System.out.println(var3); } åœ¨ kotlin ä¸­ï¼Œå› ä¸ºå‡ºç°äº†å¤§é‡çš„å¸¦ lamdbaçš„ é«˜é˜¶å‡½æ•° \u0026ndash; ã€Œé«˜é˜¶å‡½æ•°æ˜¯å°†å‡½æ•°ç”¨ä½œå‚æ•°æˆ–è¿”å›å€¼çš„å‡½æ•°ã€ï¼Œä½¿å¾—è¶Šæ¥è¶Šå¤šçš„åœ°æ–¹å‡ºç° å‡½æ•°å‚æ•° ä¸æ–­ä¼ é€’çš„ç°è±¡ï¼Œæ¯ä¸€ä¸ªå‡½æ•°å‚æ•°éƒ½ä¼šè¢«ç¼–è¯‘æˆä¸€ä¸ªå¯¹è±¡ï¼Œ ä½¿å¾—å†…å­˜åˆ†é…ï¼ˆå¯¹äºå‡½æ•°å¯¹è±¡å’Œç±»ï¼‰å’Œè™šæ‹Ÿè°ƒç”¨ä¼šå¢åŠ è¿è¡Œæ—¶é—´å¼€é”€ï¼Œé€šè¿‡å†…è”åŒ– lambda è¡¨è¾¾å¼å¯ä»¥æ¶ˆé™¤è¿™ç±»çš„å¼€é”€ã€‚\n","permalink":"https://chenyongda2018.github.io/posts/android/kotlin_lamdba/","summary":"\u003ch1 id=\"kotlin-lambda\"\u003eKotlin lambda\u003c/h1\u003e\n\u003cp\u003eKotlinä¸­ï¼Œå……æ–¥ç€å„ç§å„æ ·çš„\u003ccode\u003eLambda\u003c/code\u003e è¡¨è¾¾å¼ï¼Œè¿™æ˜¯Kotlinæœ€æ–¹ä¾¿çš„ç‰¹æ€§ä¹‹ä¸€\u003c/p\u003e\n\u003cp\u003eäº†è§£Kotlin ä¸­çš„\u003ccode\u003elambda\u003c/code\u003eï¼Œé¦–å…ˆå¾—çŸ¥é“Kotlinä¸­çš„\u003ccode\u003eé«˜é˜¶å‡½æ•°\u003c/code\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"1é«˜é˜¶å‡½æ•°\"\u003e1.é«˜é˜¶å‡½æ•°\u003c/h2\u003e\n\u003cp\u003eåœ¨Javaä¸­ï¼Œå¦‚æœæœ‰ä¸€ä¸ªaæ–¹æ³•ï¼Œè¦å»è°ƒç”¨bæ–¹æ³•ï¼Œé‚£ä¹ˆåœ¨é‡Œé¢ç›´æ¥è°ƒç”¨å³å¯ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eæ¥ç€,å¦‚æœæˆ‘ä¸æƒ³æŠŠè°ƒç”¨bæ–¹æ³•çš„å‚æ•°å†™æ­»ï¼Œå¸Œæœ›åŠ¨æ€è®¾ç½®æ–¹æ³•bçš„å‚æ•°ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eparam\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eparam\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eè¿™äº›åœ¨Javaä¸­å¾ˆè½»æ¾å°±èƒ½åšåˆ°ï¼Œä¸è¿‡\u0026hellip;\nå¦‚æœæˆ‘ä»¬æƒ³åŠ¨æ€è®¾ç½®çš„ä¸æ˜¯æ–¹æ³•å‚æ•°ï¼Œè€Œæ˜¯æ–¹æ³•æœ¬èº«å‘¢ï¼Œæ¯”å¦‚åœ¨æ–¹æ³•aå†…æœ‰ä¸€å¤„å¯¹åˆ«çš„æ–¹æ³•çš„è°ƒç”¨ï¼Œè¿™ä¸ªæ–¹æ³•å¯èƒ½æ˜¯æ–¹æ³•b,æ–¹æ³•c,æ–¹æ³•d\u0026hellip;,è¯¥æ–¹æ³•çš„å‚æ•°ç±»å‹æ˜¯int,è¿”å›å€¼ç±»å‹ä¹Ÿæ˜¯intã€‚æ–¹æ³•aåœ¨æ‰§è¡Œæ—¶ï¼Œå…·ä½“éœ€è¦è°ƒç”¨å“ªä¸ªæ–¹æ³•ï¼Œèƒ½å¦åŠ¨æ€è®¾ç½®? ä¹Ÿå°±æ˜¯è¯´èƒ½å¦å°†ä¸€ä¸ªæ–¹æ³•ä½œä¸ºå‚æ•°ä¼ ç»™a?\u003c/p\u003e\n\u003cp\u003eé€šè¿‡æ¥å£\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003einterface\u003c/span\u003e \u003cspan class=\"nc\"\u003eWrapper\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003emethod\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eparam\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eå°†è¿™ä¸ªæ¥å£ç±»å‹\u003ccode\u003eWrapper\u003c/code\u003e ä½œä¸ºæ–¹æ³•açš„å‚æ•°\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eWrapper\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ewrapper\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ewrapper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003emethod\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ewrapper1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ewrapper2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eä¸¾ä¸ªæˆ‘ä»¬å¸¸è§çš„ä¾‹å­\u003c/p\u003e\n\u003cp\u003eåœ¨Androidé‡ŒViewçš„ç‚¹å‡»äº‹ä»¶\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eView\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"n\"\u003eOnClickListener\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003emOnClickListener\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"p\"\u003e...\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eonTouchEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMotionEvent\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e...\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003emOnClickListener\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eonClick\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e...\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003ccode\u003eOnClickListener\u003c/code\u003eå°±æ˜¯ä¸€ä¸ªæ¥å£ï¼Œç‚¹å‡»äº‹ä»¶çš„å†…å®¹å…¨åœ¨\u003ccode\u003eonClick()\u003c/code\u003eæ–¹æ³•é‡Œ\u003c/p\u003e","title":"Kotlin Lambda"},{"content":" Javaä½“ç³»ä¸­çš„è‡ªåŠ¨å†…å­˜ç®¡ç†ä¸»è¦åŒ…æ‹¬äº†2ä¸ªæ–¹é¢:\nè‡ªåŠ¨åœ°ç»™å¯¹è±¡åˆ†é…å†…å­˜ã€‚ è‡ªåŠ¨åœ°å›æ”¶åˆ†é…ç»™å¯¹è±¡åœ°å†…å­˜ã€‚ æœ¬æ–‡ä¹Ÿå›´ç»•è¿™ä¸¤ä¸ªç‚¹å±•å¼€ ä¸€. å†…å­˜åˆ†é…è§„åˆ™ 1.ä¼˜å…ˆåœ¨EdenåŒºåˆ†é… å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒJVMä¼šåœ¨ EdenÂ åŒºä¼˜å…ˆåˆ†é…å¯¹è±¡ï¼Œå¦‚æœ EdenÂ æ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œåˆ™è¿›è¡Œä¸€æ¬¡ Minor GCÂ ã€‚é€šè¿‡å‚æ•° -XX:+PrintGCDetailsÂ å¯ä»¥è®©è™šæ‹Ÿæœºåœ¨è¿›è¡Œåƒåœ¾å›æ”¶æ—¶æ‰“å°æ—¥å¿—ï¼Œæ–¹ä¾¿æˆ‘ä»¬çœ‹åˆ°å›æ”¶å‰åçš„å†…å­˜å ç”¨æƒ…å†µã€‚\nä¾‹: å‡å¦‚ç°åœ¨å†…å­˜å¤§å°æŒ‡å®šå¦‚ä¸‹:\næ–°ç”Ÿä»£ -\u0026gt;10M EdenåŒº -\u0026gt; 8M fromåŒº -\u0026gt; 1M to åŒº -\u0026gt; 1M è€å¹´ä»£ -\u0026gt; 10M ç„¶åæˆ‘ä»¬åˆå…ˆååœ¨ä»£ç ä¸­åˆ›å»º4ä¸ªå¯¹è±¡:\nbyte[] byte1 = new byte[2MB]; byte[] byte2 = new byte[2MB]; byte[] byte3 = new byte[2MB]; byte[] byte4 = new byte[4MB]; å½“åˆ›å»ºå®Œç¬¬ä¸‰ä¸ªå¯¹è±¡åï¼ŒEdenåŒºå·²ç»ç”¨æ‰äº†6Mçš„ç©ºé—´æ¥å­˜æ”¾ byte1,byte2,byte3 ä¸‰ä¸ªå¯¹è±¡ï¼Œå†åˆ›å»ºç¬¬å››ä¸ªå¯¹è±¡æ—¶,EdenåŒºåŠ ä¸Šä¸€ä¸ªfromåŒºå·²ç»æ”¾ä¸ä¸‹äº†ï¼Œå¦‚å…ˆå‰æ‰€è¿°ï¼Œæ­¤æ—¶ä¼šè§¦å‘ä¸€æ¬¡ MinorGCÂ ,å°†ä¸‰ä¸ª2MBçš„å¯¹è±¡è½¬ç§»åˆ°è€å¹´ä»£ä¸­ï¼Œè…¾å‡ºEdenåŒºçš„ç©ºé—´ç»™ ç¬¬å››ä¸ªå¯¹è±¡ã€‚\næ‰€ä»¥ï¼Œæ‰§è¡Œåçš„å†…å­˜æƒ…å†µå¦‚ä¸‹:\næ–°ç”Ÿä»£ -\u0026gt; 10MÂ Eden åŒº -\u0026gt; 8M (å‰©ä½™4M) å­˜æ”¾ byte4 fromåŒºÂ -\u0026gt; 1M toåŒºÂ -\u0026gt; 1M è€å¹´ä»£ -\u0026gt; 10M (å‰©ä½™4M) å­˜æ”¾byte1,byte2,byte3ã€‚ 2.å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£ é€šè¿‡ -XX:PretentureSizeThresholdÂ å‚æ•°è®¾ç½®å¤§äºè¿™ä¸ªå€¼çš„å¯¹è±¡ç›´æ¥åˆ†é…åˆ°è€å¹´ä»£ã€‚\n3.é•¿æœŸå­˜æ´»çš„å¯¹è±¡è¿›å…¥è€å¹´ä»£ æ€ä¹ˆç®—æ˜¯é•¿æœŸå­˜æ´» ?\nJVMç»™æ¯ä¸ªå¯¹è±¡å®šä¹‰äº†ä¸€ä¸ª å¯¹è±¡å¹´é¾„è®¡æ•°å™¨Â ã€‚å½“å¯¹è±¡ä¸€å¼€å§‹è¢«åˆ†é…åˆ°æ–°ç”Ÿä»£EdenåŒºï¼Œç»è¿‡ä¸€æ¬¡Â MniorGCÂ åä»ç„¶å­˜æ´»ï¼Œå¹¶ä¸”SurvivoråŒºèƒ½å¤Ÿå®¹çº³å®ƒï¼Œåˆ™æ­¤å¯¹è±¡è¢«è½¬ç§»åˆ° SurvivorÂ åŒºï¼Œå¹´é¾„å˜ä¸º1ã€‚åœ¨ SurvivorÂ åŒºä¸­çš„å¯¹è±¡æ²¡ç†¬è¿‡ä¸€æ¬¡ MniorGCÂ ,å¹´é¾„å°±æ¶¨1ï¼Œå½“å¹´é¾„è¾¾åˆ°æˆ‘ä»¬è®¾å®šçš„å¹´é¾„é˜ˆå€¼(JVMé»˜è®¤è®¾å®š15)æ—¶ï¼Œå°±ä¼šè¿›å…¥è€å¹´ä»£ã€‚15å²å°±å·²ç»æ­¥å…¥è€å¹´\u0026hellip;.å¹´é¾„é˜ˆå€¼å¯é€šè¿‡å‚æ•° -XX:MaxTenuringThreshold = æŒ‡å®šå€¼Â æ¥è®¾å®šã€‚\nå¯¹å¯¹è±¡å¹´é¾„åˆ¤å®šçš„ä¼˜åŒ– JVMä¸­ï¼Œå¦‚æœSurvivoråŒºä¸­çš„ç›¸åŒå¹´é¾„çš„æ‰€æœ‰å¯¹è±¡çš„å¤§å°æ€»å’Œå¤§äºSurvivorç©ºé—´çš„ä¸€åŠï¼Œé‚£ä¹ˆè¿™äº›åŒçª—ä»¬å°±ç›´æ¥è¿›å…¥è€å¹´ä»£ã€‚æ— é¡»ç­‰åˆ°ä¸Šé¢çš„å¹´é¾„é˜ˆå€¼ã€‚ äºŒ. ç©ºé—´åˆ†é…æ‹…ä¿æœºåˆ¶ä¸å›æ”¶ç­–ç•¥(Mnior GCè¿˜æ˜¯Full GC) é¦–å…ˆä»‹ç»ä¸€ä¸‹ Mnior GCÂ å’Œ Full GCÂ çš„åŒºåˆ«:\nMniorGC :Â å‘ç”Ÿåœ¨æ–°ç”Ÿä»£çš„åƒåœ¾å›æ”¶æ´»åŠ¨ï¼Œç”±äºæ–°ç”Ÿä»£çš„Javaå¯¹è±¡ çŸ­å‘½çš„ç‰¹æ€§ï¼Œè¿™ç§åƒåœ¾å›æ”¶æ´»åŠ¨é¢‘ç¹ï¼Œå›æ”¶é€Ÿåº¦è¾ƒå¿«ã€‚(å°±åƒæ‰«ç¢çº¸å±‘) Full GC : å‘ç”Ÿåœ¨è€å¹´çš„åƒåœ¾å›æ”¶æ´»åŠ¨ï¼Œä¸è¿‡å‡ºç°ä¸€æ¬¡Â Full GC,ä¹Ÿä¼šä¼´éšç€ä¸€æ¬¡ MniorGC,ç”±äºè€å¹´ä»£ä¸­çš„å¯¹è±¡åŸºæœ¬éƒ½æ˜¯å¤§å¯¹è±¡ï¼Œé•¿å‘½ï¼Œæ‰€ä»¥Full GCçš„é€Ÿåº¦æ¯”Mnior GC çš„é€Ÿåº¦æ…¢10å€ä»¥ä¸Šã€‚(å°±åƒæ¬å¤§çŸ³å¤´)\næ–°ç”Ÿä»£çš„åƒåœ¾å›æ”¶ç®—æ³•é‡‡ç”¨çš„æ˜¯ å¤åˆ¶ç®—æ³•Â ,å½“è¿›è¡Œä¸€æ¬¡ Mnior GCÂ æ—¶ï¼Œä¼šå°†æ–°ç”Ÿä»£çš„æ´»åŠ¨åŒºåŸŸ( EdenåŒºÂ å’ŒSurvivorä¸­çš„ FromåŒºÂ )ä¸­çš„å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ° Survivorä¸­çš„ toåŒºÂ ,å¦‚æœ to åŒºçš„å†…å­˜ä¸è¶³ä»¥æ”¾ä¸‹è¿™äº›å¯¹è±¡ï¼Œé‚£ä¹ˆè¿™æ—¶å°±éœ€è¦è€å¹´ä»£å‡ºé©¬ï¼Œè¿›è¡Œåˆ†é…æ‹…ä¿æœºåˆ¶,å°†æ”¾ä¸ä¸‹çš„å¯¹è±¡æ”¾åˆ°è€å¹´ä»£ã€‚Â æ‰€ä»¥ï¼Œåœ¨è¿›è¡Œ Monior GCÂ å‰ï¼ŒJVMä¼šåšä»¥ä¸‹æµç¨‹çš„æ£€æŸ¥ï¼Œä»¥ç¡®è®¤è€å¹´ä»£æ˜¯å¦èƒ½å¤Ÿæ”¾å¾—ä¸‹é‚£äº›å¯¹è±¡ï¼Œæ¥é€‰æ‹©è¿›è¡Œ Mnior GCÂ è¿˜æ˜¯Â Full GCÂ ã€‚\nReference:æ·±å…¥ç†è§£Javaè™šæ‹ŸæœºÂ ","permalink":"https://chenyongda2018.github.io/posts/java/jvm%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E6%9C%BA%E5%88%B6%E4%B8%8E%E5%9B%9E%E6%94%B6%E7%AD%96%E7%95%A5%E9%80%89%E6%8B%A9-jvm%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B02/","summary":"\u003cblockquote\u003e\n\u003cp\u003eJavaä½“ç³»ä¸­çš„è‡ªåŠ¨å†…å­˜ç®¡ç†ä¸»è¦åŒ…æ‹¬äº†2ä¸ªæ–¹é¢:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eè‡ªåŠ¨åœ°ç»™å¯¹è±¡åˆ†é…å†…å­˜ã€‚\u003c/li\u003e\n\u003cli\u003eè‡ªåŠ¨åœ°å›æ”¶åˆ†é…ç»™å¯¹è±¡åœ°å†…å­˜ã€‚\u003c/li\u003e\n\u003c/ol\u003e\u003c/blockquote\u003e\n\u003cp\u003eæœ¬æ–‡ä¹Ÿå›´ç»•è¿™ä¸¤ä¸ªç‚¹å±•å¼€\n\u003c!-- raw HTML omitted --\u003e\u003c!-- raw HTML omitted --\u003e\u003c/p\u003e\n\u003ch2 id=\"ä¸€-å†…å­˜åˆ†é…è§„åˆ™\"\u003eä¸€. å†…å­˜åˆ†é…è§„åˆ™\u003c/h2\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/6/24/16b8975973c1114c~tplv-t2oaga2asx-image.image\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003c!-- raw HTML omitted --\u003e\u003c!-- raw HTML omitted --\u003e\u003c/p\u003e\n\u003ch3 id=\"1ä¼˜å…ˆåœ¨edenåŒºåˆ†é…\"\u003e1.ä¼˜å…ˆåœ¨EdenåŒºåˆ†é…\u003c/h3\u003e\n\u003cp\u003eå¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒJVMä¼šåœ¨ \u003ccode\u003eEden\u003c/code\u003eÂ åŒºä¼˜å…ˆåˆ†é…å¯¹è±¡ï¼Œå¦‚æœ \u003ccode\u003eEden\u003c/code\u003eÂ æ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œåˆ™è¿›è¡Œä¸€æ¬¡ \u003ccode\u003eMinor GC\u003c/code\u003eÂ ã€‚é€šè¿‡å‚æ•° \u003ccode\u003e-XX:+PrintGCDetails\u003c/code\u003eÂ å¯ä»¥è®©è™šæ‹Ÿæœºåœ¨è¿›è¡Œåƒåœ¾å›æ”¶æ—¶æ‰“å°æ—¥å¿—ï¼Œæ–¹ä¾¿æˆ‘ä»¬çœ‹åˆ°å›æ”¶å‰åçš„å†…å­˜å ç”¨æƒ…å†µã€‚\u003c/p\u003e\n\u003cp\u003eä¾‹: å‡å¦‚ç°åœ¨å†…å­˜å¤§å°æŒ‡å®šå¦‚ä¸‹:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eæ–°ç”Ÿä»£ -\u0026gt;10M\n\u003cul\u003e\n\u003cli\u003eEdenåŒº -\u0026gt; 8M\u003c/li\u003e\n\u003cli\u003efromåŒº -\u0026gt; 1M\u003c/li\u003e\n\u003cli\u003eto åŒº -\u0026gt; 1M\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eè€å¹´ä»£ -\u0026gt; 10M\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç„¶åæˆ‘ä»¬åˆå…ˆååœ¨ä»£ç ä¸­åˆ›å»º4ä¸ªå¯¹è±¡:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"o\"\u003e[]\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebyte1\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003e2MB\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"o\"\u003e[]\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebyte2\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003e2MB\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"o\"\u003e[]\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebyte3\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003e2MB\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"o\"\u003e[]\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ebyte4\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003e4MB\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eå½“åˆ›å»ºå®Œç¬¬ä¸‰ä¸ªå¯¹è±¡åï¼ŒEdenåŒºå·²ç»ç”¨æ‰äº†6Mçš„ç©ºé—´æ¥å­˜æ”¾ byte1,byte2,byte3 ä¸‰ä¸ªå¯¹è±¡ï¼Œå†åˆ›å»ºç¬¬å››ä¸ªå¯¹è±¡æ—¶,EdenåŒºåŠ ä¸Šä¸€ä¸ªfromåŒºå·²ç»æ”¾ä¸ä¸‹äº†ï¼Œå¦‚å…ˆå‰æ‰€è¿°ï¼Œæ­¤æ—¶ä¼šè§¦å‘ä¸€æ¬¡ \u003ccode\u003eMinorGC\u003c/code\u003eÂ ,å°†ä¸‰ä¸ª2MBçš„å¯¹è±¡è½¬ç§»åˆ°è€å¹´ä»£ä¸­ï¼Œè…¾å‡ºEdenåŒºçš„ç©ºé—´ç»™ ç¬¬å››ä¸ªå¯¹è±¡ã€‚\u003c/p\u003e","title":"JVMå†…å­˜åˆ†é…æœºåˆ¶ä¸å›æ”¶ç­–ç•¥é€‰æ‹© JVMå­¦ä¹ ç¬”è®°[2]"},{"content":"\næœ¬ç« è¦æ¢ç©¶çš„é—®é¢˜ : GCåœ¨å›æ”¶å†…å­˜æ—¶ :\næ€ä¹ˆåˆ¤æ–­å“ªäº›å†…å­˜éœ€è¦å›æ”¶ ï¼Ÿ ä»€ä¹ˆæ—¶å€™å›æ”¶ï¼Ÿ åœ¨å‡ ä¸ªçº¿ç¨‹ç§æœ‰çš„è¿è¡Œæ—¶åŒºåŸŸ:\nè™šæ‹Ÿæœºæ ˆ ç¨‹åºè®¡æ•°å™¨ æœ¬åœ°æ–¹æ³•æ ˆ å®ƒä»¬çš„å†…å­˜åˆ†é…å’Œå›æ”¶å¤§å¤šéƒ½å…·æœ‰ç¡®å®šæ€§ï¼Œéšç€çº¿ç¨‹çš„åˆ›å»ºè€Œäº§ç”Ÿï¼Œéšç€çº¿ç¨‹çš„åœæ­¢è€Œè¢«å›æ”¶ã€‚æ ˆå¸§ä¸­çš„å†…å­˜å¤§å°åŸºæœ¬åœ¨ç±»çš„ç»“æ„ç¡®å®šä¸‹æ¥æ—¶å°±å·²çŸ¥ã€‚\nè€Œåœ¨çº¿ç¨‹å…±æœ‰çš„ Javaå †(Heap) å’Œ æ–¹æ³•åŒº(Class(Method) Area) è¿™ä¸¤ä¸ªåŒºåŸŸåˆ™ä¸åŒï¼š\næ¯”å¦‚ï¼Œä¸€ä¸ªæ¥å£æœ‰ä¸åŒçš„å®ç°ç±»(ç±»çš„ä¿¡æ¯åœ¨æ–¹æ³•åŒºä¸­)ï¼Œè¿™å‡ ä¸ªå®ç°ç±»çš„å†…å­˜å¤§å°è‚¯å®šä¸ä¸€ï¼Œæ²¡æ³•åœ¨è¿è¡Œå‰å°±å·²çŸ¥éœ€è¦å¤šå¤§çš„å†…å­˜ï¼Œåªæœ‰åœ¨è¿è¡ŒæœŸé—´æ‰çŸ¥é“åˆ›å»ºçš„å¯¹è±¡çš„å¤§å°ã€‚\nä¸€ï¼Œå“ªäº›å†…å­˜éœ€è¦å›æ”¶ï¼Ÿ åœ¨çŸ¥é“å“ªäº›å†…å­˜éœ€è¦å›æ”¶ä¹‹å‰ï¼Œæˆ‘ä»¬è¦çŸ¥é“æ€ä¹ˆåˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦è¿˜å­˜æ´»ï¼Œå½“å®ƒä¸å†å­˜æ´»æ—¶ï¼Œå°±å›æ”¶å®ƒã€‚è€Œ å¼•ç”¨è®¡æ•°ç®—æ³• å°±æ˜¯ç”¨æ¥åˆ¤æ–­å¯¹è±¡æ˜¯å¦å­˜æ´»çš„ä¸€ä¸ªç®—æ³•ã€‚\n1ï¼Œå¼•ç”¨è®¡æ•°ç®—æ³•ï¼ˆReference Countingï¼‰ ç®—æ³•æè¿°ï¼šç»™å¯¹è±¡æ·»åŠ ä¸€ä¸ªå¼•ç”¨è®¡æ•°å™¨ï¼Œå½“æœ‰ä¸€ä¸ªåœ°æ–¹å¼•ç”¨äº†å®ƒï¼Œè®¡æ•°å™¨+1ï¼Œå½“å¼•ç”¨å¤±æ•ˆï¼Œè®¡æ•°å™¨-1ï¼Œåœ¨ä»»ä½•æ—¶åˆ»ï¼Œè®¡æ•°å™¨ä¸º0æ—¶æ­¤å¯¹è±¡å°†ä¸èƒ½å†è¢«ä½¿ç”¨ã€‚\nå¼•ç”¨è®¡æ•°æ³•åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹è¡¨ç°éƒ½ä¸é”™ï¼Œä¹Ÿæœ‰è¢«å¾ˆå¤šå…¬å¸é‡‡ç”¨çš„åº”ç”¨æ¡ˆä¾‹ã€‚ä½†æ˜¯åœ¨JVMä¸­å¹¶æ²¡æœ‰é‡‡ç”¨è¿™ç§ç®—æ³•ï¼ŒåŸå› æ˜¯ï¼šæ— æ³•è§£å†³å¯¹è±¡ä¹‹é—´å­˜åœ¨ç›¸äº’å¼•ç”¨çš„é—®é¢˜ã€‚\npublic class Person { Object instance = null; public static void main(String[] args) { Person a = new Person(); Person b = new Person(); a.instance = b; b.instance = a; a = null; b = null;// æ­£å¸¸æƒ…å†µä¸‹åœ¨è¿™é‡ŒGCå°±ä¼šæŠŠa,bå›æ”¶æ‰ } } æ­£å¸¸æƒ…å†µä¸‹åœ¨æ‰§è¡Œ11-12è¡Œä»£ç æ—¶ï¼ŒJVMçš„GCä¼šæŠŠa,bä¸¤ä¸ªå¯¹è±¡å›æ”¶ï¼Œä½†æ˜¯åœ¨å¼•ç”¨è®¡æ•°ç®—æ³•çš„æƒ…å†µä¸‹ï¼š\næ‰§è¡Œ a=null æ—¶,açš„å¼•ç”¨è®¡æ•°å™¨å€¼ä¸º1ï¼Œå› ä¸ºbå¯¹è±¡åœ¨å¼•ç”¨å®ƒã€‚ æ‰§è¡Œ b=null æ—¶,bçš„å¼•ç”¨è®¡æ•°å™¨å€¼ä¸º1ï¼Œå› ä¸ºaå¯¹è±¡åœ¨å¼•ç”¨å®ƒã€‚ 2ï¼Œå¯è¾¾æ€§åˆ†æ(Reachability Analysis)ç®—æ³• åœ¨Javaè¯­è¨€ä¸­æ˜¯é€šè¿‡å¯è¾¾æ€§åˆ†ææ¥åˆ¤æ–­å¯¹è±¡æ˜¯å¦å­˜æ´»ã€‚ ç®—æ³•æè¿° : é€šè¿‡ä¸€ç³»åˆ—çš„ GC Roots ä½œä¸ºèµ·å§‹ç‚¹ï¼Œä»è¿™äº›èµ·å§‹ç‚¹å¼€å§‹å‘ä¸‹æœç´¢ï¼Œèƒ½æœç´¢çš„åˆ°çš„å¯¹è±¡è¯´æ˜å…¶å¯ç”¨ï¼Œä¸ä¼šè¢«GCå›æ”¶æ‰ï¼Œæœç´¢æ‰€èµ°è¿‡çš„è·¯å¾„ç§°ä¸º å¼•ç”¨é“¾(Reference Chain) ã€‚ç›¸åï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡æ²¡æœ‰åˆ°è¾¾GC Rootsçš„è·¯å¾„ï¼Œåˆ™è¯´æ˜å®ƒä¸å¯ç”¨ï¼Œè¢«åˆ¤å®šä¸ºå¯è¢«GCå›æ”¶çš„å¯¹è±¡ã€‚\nå¦‚å›¾ : 1åŒºåŸŸçš„å¯¹è±¡è™½ç„¶äº’ç›¸å…³è”ï¼Œä½†æ˜¯å®ƒä»¬ä¸å¯åˆ°è¾¾GC Roots,æ‰€ä»¥ä»–ä»¬ä¼šè¢«å›æ”¶æ‰ï¼Œè€Œ2åŒºåŸŸçš„å¯¹è±¡ä¸GC Rootsä¹‹é—´æ˜¯æœ‰å¯åˆ°è¾¾è·¯å¾„çš„ï¼Œæ‰€ä»¥å®ƒä»¬ä¸ä¼šè¢«å›æ”¶ã€‚\nä»€ä¹ˆæ˜¯GC Roots ? è™šæ‹Ÿæœºæ ˆ(æ ˆå¸§ä¸­çš„æœ¬åœ°å˜é‡è¡¨)ä¸­å¼•ç”¨çš„å¯¹è±¡ æ–¹æ³•åŒºä¸­ç±»çš„é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡ æ–¹æ³•åŒºä¸­å¸¸é‡å¼•ç”¨çš„å¯¹è±¡ æœ¬åœ°æ–¹æ³•æ ˆä¸­JNI(Nativeæ–¹æ³•)å¼•ç”¨çš„å¯¹è±¡ è¿™äº›éƒ½å¯ä½œä¸ºGC Roots.\n3ï¼Œä»€ä¹ˆæ˜¯å¼•ç”¨ï¼ˆReferenceï¼‰ æˆ‘ä»¬åœ¨ä¸Šé¢çš„ å¼•ç”¨è®¡æ•°ç®—æ³• å’Œ å¯è¾¾æ€§åˆ†æ ä¸­ï¼Œéƒ½æåˆ°äº† å¯¹è±¡ä¹‹é—´çš„å¼•ç”¨ å…³ç³»ã€‚\nåœ¨Java1.2ä¹‹å‰,å…³äº å¼•ç”¨ çš„å®šä¹‰ :\nå¦‚æœ reference ç±»å‹çš„æ•°æ®å­˜å‚¨çš„æ•°å€¼ä»£è¡¨çš„æ˜¯å¦ä¸€å—å†…å­˜çš„èµ·å§‹åœ°å€ï¼Œå°±è¯´è¿™å—å†…å­˜ä»£è¡¨ä¸€ä¸ªå¼•ç”¨ã€‚\nJDK1,2ä¹‹å,åˆå¼•å…¥äº† å¼ºå¼•ç”¨ ï¼Œ è½¯å¼•ç”¨ ï¼Œ å¼±å¼•ç”¨ ï¼Œ è™šå¼•ç”¨ ,è¿™å››ä¸ªæ¦‚å¿µï¼Œå¹¶ä¸”è¿™å››ç§è¡¨ç°çš„å¼•ç”¨å…³ç³»è¶Šæ¥è¶Šå¼±ã€‚\nå¼ºå¼•ç”¨(Strong Reference) : ä¾‹:\nObject o = new Object(); åªè¦å¼ºå¼•ç”¨è¿˜åœ¨ï¼ŒGCæ°¸è¿œä¸ä¼šå›æ”¶æ‰è¢«å¼•ç”¨çš„å¯¹è±¡ã€‚\nè½¯å¼•ç”¨(Soft Reference) : æœ‰ç”¨ï¼Œä½†éå¿…é¡»ï¼Œåœ¨å°†è¦å‘ç”Ÿå†…å­˜æº¢å‡ºæ—¶ï¼Œä¼šæŠŠ è½¯å¼•ç”¨ çš„å¯¹è±¡å›æ”¶æ‰ï¼Œå¦‚æœå†…å­˜ä¾ç„¶ä¸å¤Ÿç”¨ï¼Œåˆ™æŠ›å‡ºOOMå¼‚å¸¸ã€‚\nå¼±å¼•ç”¨(Weak Reference): éå¿…éœ€å¯¹è±¡ï¼Œåªè¦GCå‘ç”Ÿäº†åƒåœ¾å›æ”¶ï¼Œä¸ç®¡æ­¤æ—¶å†…å­˜æ˜¯å¦å……è¶³ï¼Œ å¼±å¼•ç”¨ çš„å¯¹è±¡éƒ½ä¼šè¢«å›æ”¶æ‰ã€‚\nè™šå¼•ç”¨(Phantom Reference): æœ€å¼±çš„å¼•ç”¨å…³ç³» æ— æ³•é€šè¿‡è™šå¼•ç”¨æ„é€ å¸‚å®ä¾‹ã€‚ å”¯ä¸€çš„ä½œç”¨å°±æ˜¯åœ¨è™šå¼•ç”¨å…³è”çš„å¯¹è±¡è¢«GCå›æ”¶æ‰æ—¶ï¼Œå¯ä»¥æ¥å—åˆ°ä¸€ä¸ªä¿¡å·ã€‚ 4ï¼Œå¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡å¯å›æ”¶(å·²æ­»)ï¼Ÿ ä¸€ä¸ªå¯¹è±¡ä»…ä»…é€šè¿‡ä¸Šé¢è¯´çš„å¯è¾¾æ€§åˆ†æçœ‹å®ƒæ²¡æœ‰ä¸GC ROOTSå…³è”æ¥åˆ¤å®šè¿™ä¸ªå¯¹è±¡æ˜¯å¦å¯è¢«å›æ”¶æ˜¯ä¸å¤Ÿçš„ã€‚\nä¸€ä¸ªå¯¹è±¡è¦ç»è¿‡ä¸‹é¢ä¸€æ®µåˆ¤æ–­è¿‡ç¨‹æ¥åˆ¤æ–­å®ƒæ˜¯å¦è¦è¢«å›æ”¶(å»ºè®®æ”¶è—(^__^) å˜»å˜»â€¦â€¦):\n5ï¼Œæ–¹æ³•åŒºçš„å›æ”¶ ä¸Šé¢æˆ‘ä»¬è¯´çš„æ˜¯å­˜åœ¨äºJavaå †ä¸­çš„å¯¹è±¡çš„å›æ”¶ï¼Œä½†å…¶å®åœ¨æ–¹æ³•åŒºè¿˜è¦å›æ”¶ä»¥ä¸‹ä¸œè¥¿ï¼š\nâ‘  å›æ”¶åºŸå¼ƒå¸¸é‡ å‡å¦‚å¸¸é‡æ± ä¸­æœ‰ä¸€ä¸ªå­—ç¬¦ä¸² \u0026ldquo;abc\u0026rdquo; ,ä½†æ˜¯ç³»ç»Ÿä¸­æ²¡æœ‰ä¸€ä¸ªString å¯¹è±¡æŒ‡å‘å®ƒï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªå¸¸é‡æ²¡æœ‰è¢«å¼•ç”¨ï¼Œå½“GCåœ¨å›æ”¶æ—¶ä¼šå›æ”¶æ­¤å­—é¢é‡ã€‚\nâ‘¡ å›æ”¶åºŸå¼ƒçš„ç±»(æ— ç”¨çš„ç±») è¯¥ç±»çš„å®ä¾‹éƒ½å·²è¢«å›æ”¶ï¼ŒJavaå †ä¸­ä¸å­˜åœ¨ä»»ä½•è¯¥ç±»çš„å®ä¾‹ã€‚ åŠ è½½è¯¥ç±»çš„ClassLoaderå·²ç»è¢«å›æ”¶ã€‚ è¯¥ç±»çš„Java.lang.classå¯¹è±¡æ²¡æœ‰è¢«å¼•ç”¨(åœ¨åå°„ä¸­ä¼šè¢«ç”¨åˆ°è¿™ç‚¹)ã€‚ â‘¢ æ–¹æ³•åŒºçš„å›æ”¶ç­–ç•¥: GCåœ¨å›æ”¶æ–¹æ³•åŒºæ—¶ä¼šé‡‡ç”¨ä¸€ä¸‹2ç§æ–¹å¼:\næ ‡è®°-æ•´ç† æ ‡è®°-æ¸…é™¤ äºŒï¼Œå¦‚ä½•å›æ”¶ï¼Ÿ GCåœ¨å›æ”¶å†…å­˜æ—¶ä¼šé‡‡ç”¨å¤šç§åƒåœ¾æ”¶é›†ç®—æ³•ï¼Œè¿™äº›ç®—æ³•å„æœ‰ä¼˜åŠ£ã€‚\n1.æ ‡è®°-æ¸…é™¤(Mark-Sweep)ç®—æ³• æ­¤ç®—æ³•æ˜¯æœ€åŸºç¡€ä¹Ÿæ˜¯æœ€å¤è€çš„åƒåœ¾å›æ”¶ç®—æ³•ï¼Œè¯¥ç®—æ³•ä¸»è¦ç»è¿‡2ä¸ªè¿‡ç¨‹ â‘  ç®—æ³•æè¿° æ ‡è®°é˜¶æ®µ:ç»è¿‡å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡å¯è¢«å›æ”¶æ‰€è¿°ï¼Œå¯¹å¯è¢«å›æ”¶çš„å¯¹è±¡è¿›è¡Œæ ‡è®°ã€‚ æ¸…é™¤é˜¶æ®µ:å°†è¢«æ ‡è®°çš„å¯¹è±¡ç»Ÿä¸€å›æ”¶ã€‚ â‘¡ ç®—æ³•ç¼ºé™· æ•ˆç‡é—®é¢˜:æ­¤ç§ç®—æ³•æ ‡è®°å’Œæ¸…é™¤çš„æ•ˆç‡éƒ½ä¸é«˜ã€‚ æ ‡è®°æ¸…é™¤åäº§ç”Ÿå¤§é‡ä¸è¿ç»­çš„å†…å­˜ç©ºé—´ç¢ç‰‡ã€‚ 2.å¤åˆ¶(Copying)ç®—æ³• å¤åˆ¶ç®—æ³•é’ˆå¯¹æ•ˆç‡é—®é¢˜è¿›è¡Œäº†ä¼˜åŒ–ï¼Œå®ƒå°†å†…å­˜åŒºåŸŸåˆ’åˆ†ä¸º2å—ï¼Œæ¯æ¬¡åªä½¿ç”¨å…¶ä¸­ä¸€å—ã€‚\næ´»åŠ¨åŒºåŸŸ ç©ºé—²åŒºåŸŸ â‘  ç®—æ³•æè¿° å¦‚å›¾:\nå›æ”¶å‰ : å†…å­˜è¢«åˆ’åˆ†ä¸ºå·¦å³ä¸¤ä¾§åŒºåŸŸï¼Œå³ä¾§ä¸ºç©ºé—²åŒºåŸŸï¼Œæš‚æ—¶ä¸ä½¿ç”¨å®ƒ å›æ”¶æ—¶ : å°†å·¦ä¾§è¦è¢«å›æ”¶çš„éƒ¨åˆ†(é»‘è‰²) å›æ”¶æ‰ï¼Œç„¶åå°†4ä¸ªå­˜æ´»å¯¹è±¡(æ·¡ç°è‰²)ç§»åŠ¨åˆ°å³ä¾§çš„ç©ºé—²åŒºåŸŸï¼Œå¹¶ä¸”åšäº†2ä»¶äº‹ å°†ç§»åŠ¨åˆ°ç©ºé—²åŒºåŸŸçš„å­˜æ´»å¯¹è±¡æŒ‰å†…å­˜åœ°å€è¿›è¡Œæ’åˆ—ã€‚ å°†å­˜æ´»å¯¹è±¡æŒ‡å‘çš„æ—§åœ°å€æŒ‡å‘æ–°å†…å­˜åœ°å€ã€‚ å›æ”¶å : åŸå…ˆçš„å³ä¾§ç©ºé—²åŒºåŸŸå˜ä¸ºæ´»åŠ¨åŒºåŸŸï¼Œå·¦ä¾§çš„æ´»åŠ¨åŒºåŸŸå˜ä¸ºç©ºé—²åŒºåŸŸã€‚ å·¦å³ä¸¤ä¾§çš„åŒºåŸŸçŠ¶æ€åœ¨æ¯ä¸€æ¬¡å›æ”¶åéƒ½æ¥å›è½¬æ¢\u0026hellip;\nâ‘¡ ç®—æ³•ç¼ºé™· å¾ˆæ˜¾ç„¶ï¼Œè¿™ç§ç®—æ³•æµªè´¹äº†ä¸€èˆ¬å†…å­˜ã€‚ å½“æ´»åŠ¨åŒºåŸŸçš„100%çš„å¯¹è±¡éƒ½è¿˜åœ¨æ´»è·ƒï¼Œé‚£ä¹ˆåœ¨å›æ”¶æ—¶éœ€è¦å°†å…¨éƒ¨çš„å¯¹è±¡å¤åˆ¶åˆ°å³ä¾§çš„ç©ºé—²åŒºåŸŸï¼Œæ­¤æ—¶çš„æ•ˆç‡å°±å¾ˆä½ã€‚ â‘¢ ç®—æ³•åº”ç”¨ IBMå…¬å¸ç»ç ”ç©¶è¡¨æ˜ï¼ŒJavaå †æ–°ç”Ÿä»£ç§çš„å¯¹è±¡98%æ˜¯ \u0026lsquo;æœç”Ÿå¤•æ­»\u0026rsquo; çš„å¯¹è±¡ï¼Œæ¯”å¦‚ä¸´æ—¶å˜é‡ç­‰ä½œç”¨åŸŸå¾ˆå°‘çš„å¯¹è±¡ã€‚æ‰€ä»¥ç°åœ¨çš„è™šæ‹Ÿæœºå¹¶ä¸ä¼šæŒ‰ç…§ 1:1çš„æ¯”ä¾‹åˆ’åˆ†ä¸¤ä¸ªåŒºåŸŸã€‚\nç°åœ¨çš„JVMè™šæ‹Ÿæœºä¸­ï¼Œå°†æ–°ç”Ÿä»£åˆ’åˆ†ä¸ºä¸€å— Eden åŒºåŸŸï¼Œå’Œ2å—è¾ƒå°çš„ Survivor åŒºåŸŸ(from ,toåŒº)ã€‚æ¯æ¬¡ä½¿ç”¨EdenåŒºå’Œ1å—SurvivoråŒº(fromåŒº)æœ€ä¸ºæ´»åŠ¨åŒºåŸŸï¼Œå½“å‘ç”Ÿå†…å­˜å›æ”¶æ—¶ï¼Œå°†è¿™2å—å†…å­˜ä¸­çš„å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°å¦ä¸€å—SurvivoråŒº(toåŒº)ã€‚\nåœ¨ HotSpot è™šæ‹Ÿæœºä¸­ï¼ŒEdenåŒºå’ŒSurvivorçš„åˆ’åˆ†æ˜¯: 8: 1ï¼Œè¿™æ ·ï¼Œæ´»åŠ¨åŒºåŸŸå æ–°ç”Ÿä»£çš„ (8+1)/10 *100% = 90%ï¼Œåªæœ‰10%çš„å†…å­˜æµªè´¹ã€‚\nè€å¹´ä»£ : å½“å°†å­˜æ´»å¯¹è±¡ä»æ´»åŠ¨åŒºåŸŸ(Eden,from) å¤åˆ¶åˆ° toåŒºæ—¶ï¼Œå¦‚æœtoåŒºä¸å¤Ÿç”¨ï¼Œåˆ™å°†å‰©ä¸‹çš„å­˜æ´»å¯¹è±¡æ”¾åˆ°è€å¹´ä»£ã€‚ 3.æ ‡è®°-æ•´ç†ç®—æ³• æ ‡è®°-æ•´ç†ä¸»è¦è¿ç”¨äºè€å¹´ä»£ä¸­ã€‚\nâ‘  ç®—æ³•æè¿° æ­¤ç®—æ³•ä¸æ ‡è®°-æ¸…é™¤ç®—æ³•ç±»ä¼¼ï¼Œä¹Ÿæ˜¯ç»å†2ä¸ªé˜¶æ®µ:\næ ‡è®°é˜¶æ®µ:æ­¤é˜¶æ®µäºæ ‡è®°-æ¸…é™¤ä¸­çš„æ ‡è®°é˜¶æ®µç›¸åŒï¼Œéƒ½æ˜¯æ ‡è®°å‡ºè¦å›æ”¶çš„å¯¹è±¡ã€‚ æ•´ç†é˜¶æ®µ:æŠŠæ‰€æœ‰å­˜æ´»çš„å¯¹åƒï¼ŒæŒ‰å†…å­˜åœ°å€æ’åˆ—ç§»åŠ¨åˆ°å†…å­˜åŒºåŸŸçš„ä¸€ç«¯ï¼Œå°†ç«¯è¾¹ç•Œä»¥å¤–çš„åŒºåŸŸè¿›è¡Œå›æ”¶ã€‚ â‘¡ ç®—æ³•åº”ç”¨ ç”±äºè€å¹´ä»£çš„ç‰¹ç‚¹ï¼Œå¯¹è±¡çš„å­˜æ´»ç‡è¾ƒé«˜ï¼Œæ²¡æœ‰é¢å¤–çš„ç©ºé—²åŒºåŸŸï¼Œæ‰€ä»¥ è€å¹´ä»£é€‚ç”¨ æ ‡è®°-æ¸…é™¤å’Œæ ‡è®°-æ•´ç†ç®—æ³•ã€‚\nReference:æ·±å…¥ç†è§£Javaè™šæ‹Ÿæœº\n","permalink":"https://chenyongda2018.github.io/posts/java/%E5%AF%B9%E8%B1%A1%E5%9B%9E%E6%94%B6%E5%88%A4%E5%AE%9A%E4%B8%8E%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%AE%97%E6%B3%95-jvm%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B01/","summary":"\u003cp\u003e\u003c!-- raw HTML omitted --\u003e\u003c!-- raw HTML omitted --\u003e\u003c/p\u003e\n\u003ch1 id=\"æœ¬ç« è¦æ¢ç©¶çš„é—®é¢˜-\"\u003eæœ¬ç« è¦æ¢ç©¶çš„é—®é¢˜ :\u003c/h1\u003e\n\u003cp\u003eGCåœ¨å›æ”¶å†…å­˜æ—¶ :\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eæ€ä¹ˆåˆ¤æ–­å“ªäº›å†…å­˜éœ€è¦å›æ”¶ ï¼Ÿ\u003c/li\u003e\n\u003cli\u003eä»€ä¹ˆæ—¶å€™å›æ”¶ï¼Ÿ\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eåœ¨å‡ ä¸ªçº¿ç¨‹ç§æœ‰çš„è¿è¡Œæ—¶åŒºåŸŸ:\u003c!-- raw HTML omitted --\u003e\u003cimg alt=\"image.png\" loading=\"lazy\" src=\"https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/6/17/16b64d8a41ca08fb~tplv-t2oaga2asx-image.image\"\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eè™šæ‹Ÿæœºæ ˆ\u003c/li\u003e\n\u003cli\u003eç¨‹åºè®¡æ•°å™¨\u003c/li\u003e\n\u003cli\u003eæœ¬åœ°æ–¹æ³•æ ˆ\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eå®ƒä»¬çš„å†…å­˜åˆ†é…å’Œå›æ”¶\u003cstrong\u003eå¤§å¤š\u003c/strong\u003eéƒ½å…·æœ‰ç¡®å®šæ€§ï¼Œéšç€çº¿ç¨‹çš„åˆ›å»ºè€Œäº§ç”Ÿï¼Œéšç€çº¿ç¨‹çš„åœæ­¢è€Œè¢«å›æ”¶ã€‚æ ˆå¸§ä¸­çš„å†…å­˜å¤§å°åŸºæœ¬åœ¨ç±»çš„ç»“æ„ç¡®å®šä¸‹æ¥æ—¶å°±å·²çŸ¥ã€‚\u003c/p\u003e\n\u003cp\u003eè€Œåœ¨çº¿ç¨‹å…±æœ‰çš„ \u003ccode\u003eJavaå †(Heap)\u003c/code\u003e å’Œ \u003ccode\u003eæ–¹æ³•åŒº(Class(Method) Area)\u003c/code\u003e è¿™ä¸¤ä¸ªåŒºåŸŸåˆ™ä¸åŒï¼š\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"image.png\" loading=\"lazy\" src=\"https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/6/17/16b64d8a42c57ecf~tplv-t2oaga2asx-image.image\"\u003e\u003c/p\u003e\n\u003cp\u003eæ¯”å¦‚ï¼Œä¸€ä¸ªæ¥å£æœ‰ä¸åŒçš„å®ç°ç±»(ç±»çš„ä¿¡æ¯åœ¨æ–¹æ³•åŒºä¸­)ï¼Œè¿™å‡ ä¸ªå®ç°ç±»çš„å†…å­˜å¤§å°è‚¯å®šä¸ä¸€ï¼Œæ²¡æ³•åœ¨è¿è¡Œå‰å°±å·²çŸ¥éœ€è¦å¤šå¤§çš„å†…å­˜ï¼Œåªæœ‰åœ¨è¿è¡ŒæœŸé—´æ‰çŸ¥é“åˆ›å»ºçš„å¯¹è±¡çš„å¤§å°ã€‚\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003c!-- raw HTML omitted --\u003e\u003c!-- raw HTML omitted --\u003e\u003c/p\u003e\n\u003ch2\u003e\u003c/h2\u003e\n\u003cp\u003e\u003c!-- raw HTML omitted --\u003e\u003c!-- raw HTML omitted --\u003e\u003c/p\u003e\n\u003ch2 id=\"ä¸€å“ªäº›å†…å­˜éœ€è¦å›æ”¶\"\u003eä¸€ï¼Œå“ªäº›å†…å­˜éœ€è¦å›æ”¶ï¼Ÿ\u003c/h2\u003e\n\u003cp\u003eåœ¨çŸ¥é“å“ªäº›å†…å­˜éœ€è¦å›æ”¶ä¹‹å‰ï¼Œæˆ‘ä»¬è¦çŸ¥é“æ€ä¹ˆåˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦è¿˜å­˜æ´»ï¼Œå½“å®ƒä¸å†å­˜æ´»æ—¶ï¼Œå°±å›æ”¶å®ƒã€‚\u003c!-- raw HTML omitted --\u003eè€Œ \u003ccode\u003eå¼•ç”¨è®¡æ•°ç®—æ³•\u003c/code\u003e å°±æ˜¯ç”¨æ¥åˆ¤æ–­å¯¹è±¡æ˜¯å¦å­˜æ´»çš„ä¸€ä¸ªç®—æ³•ã€‚\u003c/p\u003e\n\u003cp\u003e\u003c!-- raw HTML omitted --\u003e\u003c!-- raw HTML omitted --\u003e\u003c/p\u003e\n\u003ch3 id=\"1å¼•ç”¨è®¡æ•°ç®—æ³•reference-counting\"\u003e1ï¼Œå¼•ç”¨è®¡æ•°ç®—æ³•ï¼ˆReference Countingï¼‰\u003c/h3\u003e\n\u003cp\u003eç®—æ³•æè¿°ï¼šç»™å¯¹è±¡æ·»åŠ ä¸€ä¸ªå¼•ç”¨è®¡æ•°å™¨ï¼Œå½“æœ‰ä¸€ä¸ªåœ°æ–¹å¼•ç”¨äº†å®ƒï¼Œè®¡æ•°å™¨+1ï¼Œå½“å¼•ç”¨å¤±æ•ˆï¼Œè®¡æ•°å™¨-1ï¼Œåœ¨ä»»ä½•æ—¶åˆ»ï¼Œè®¡æ•°å™¨ä¸º0æ—¶æ­¤å¯¹è±¡å°†ä¸èƒ½å†è¢«ä½¿ç”¨ã€‚\u003c/p\u003e","title":"å¯¹è±¡å›æ”¶åˆ¤å®šä¸åƒåœ¾å›æ”¶ç®—æ³• JVMå­¦ä¹ ç¬”è®°[1]"},{"content":"ä¸€.ä½¿ç”¨ 1.é…ç½®ä¾èµ– åœ¨ appÂ å±‚ build.gradleÂ ä¸­æ·»åŠ ä¾èµ– :Â dependencies { ... implementation \u0026#39;com.github.bumptech.glide:glide:4.9.0\u0026#39; annotationProcessor \u0026#39;com.github.bumptech.glide:compiler:4.9.0\u0026#39; annotationProcessor \u0026#39;androidx.annotation:annotation:1.1.0\u0026#39; ... } æ·»åŠ å¿…è¦æƒé™ :Â \u0026lt;uses-permission android:name=\u0026#34;android.permission.INTERNET\u0026#34;/\u0026gt; \u0026lt;uses-permission android:name=\u0026#34;android.permission.ACCESS_NETWORK_STATE\u0026#34;/\u0026gt; \u0026lt;uses-permission android:name=\u0026#34;android.permission.READ_EXTERNAL_STORAGE\u0026#34; /\u0026gt; \u0026lt;uses-permission android:name=\u0026#34;android.permission.WRITE_EXTERNAL_STORAGE\u0026#34; /\u0026gt; 2.åˆæ­¥ä¸Šæ‰‹ ä»£ç  :Â Glide.with(context) .asBitmap() //æŠŠåŠ¨å›¾å½“ä½œé™æ­¢å›¾ç‰‡å¤„ç†,ä¹Ÿå°±æ˜¯åªæ˜¾ç¤ºgifå›¾çš„ç¬¬ä¸€å¸§ .load(\u0026#34;https://pic2.zhimg.com/v2-c4970ee756c55333b7b871c5b617d9ed_b.gif\u0026#34;)//å›¾ç‰‡url .placeholder(R.mipmap.ic_launcher) //å ä½ç¬¦,åœ¨åŠ è½½å›¾ç‰‡å®Œæˆä¹‹å‰æ˜¾ç¤ºçš„å›¾ç‰‡ .error(R.drawable.ic_launcher_background) //åŠ è½½å¤±è´¥æ—¶æ˜¾ç¤ºçš„å›¾ç‰‡ .fitCenter() //å½“å›¾ç‰‡é•¿å®½å¤§äºImageViewæ—¶,ç¼©æ”¾å›¾ç‰‡ .fallback(R.mipmap.ic_launcher) //å›¾ç‰‡urlä¸ºNullæ—¶æ˜¾ç¤ºçš„å›¾ç‰‡ .into(image1); // æ”¾å…¥åˆ°ImageViewä¸­ æ•ˆæœå›¾ :\nğŸˆTips : fitCenter()ä¸CenterCrop()åŒºåˆ« :Â fitCenter() : æ•ˆæœå¦‚ä¸Šå›¾,ç¼©æ”¾åŸå›¾è‡³ImageViewå¤§å°ã€‚ CenterCrop():å¦‚ä¸‹å›¾,ä¿æŒåŸå›¾ä¸å˜ï¼Œåªæ ¹æ®ImageViewå¤§å°æ˜¾ç¤ºå¯¹åº”éƒ¨åˆ†ã€‚ 3.é…åˆRecyclerViewæ˜¾ç¤ºå›¾ç‰‡åˆ—è¡¨ 1.éœ€è¦åŠ è½½çš„å›¾ç‰‡urlæ•°æ®æº\nString[] mImageList = { \u0026#34;https://gss0.bdstatic.com/94o3dSag_xI4khGkpoWK1HF6hhy/baike/crop%3D0%2C231%2C438%\u0026#34; + \u0026#34;2C219%3BeWH%3D800%2C400/sign=b9c61bb42b3fb80e189e3b970be1031c/d50735fae6cd7b89267e2d06052442a7d9330e20.jpg\u0026#34;, \u0026#34;https://s3.ifanr.com/wp-content/uploads/2018/02/https_2F2Fhk.hypebeast.com2Ffiles2F20182F012Fdragon-ball-super-ending-anime-details-01-1.jpg\u0026#34;, \u0026#34;https://gss2.bdstatic.com/-fo3dSag_xI4khGkpoWK1HF6hhy/baike/s%3D220/sign=999dccfe8082b90139adc431438ca97e/a1ec08fa513d26970f8fef845ffbb2fb4216d88f.jpg\u0026#34;, \u0026#34;http://img5.mtime.cn/CMS/News/2019/05/28/223631.52706895_620X620.jpg\u0026#34;, \u0026#34;http://newsimg.5054399.com/uploads/userup/1902/2F95FQ953.jpg\u0026#34;, \u0026#34;http://x0.ifengimg.com/cmpp/2019_37/63ef72f4f79be26_size61_w1278_h716.jpg\u0026#34;, \u0026#34;https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQJehCL30Zj-jAI8xxZ1eQI6mf9DuqaC6LXEOzF-Li8-Y1YlSnJ\u0026amp;s\u0026#34;, \u0026#34;https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRTzaN89LyHy1IzuibIhUdvJjEiCdrn8R84BnUi4O6hlPtmJZWe\u0026amp;s\u0026#34;, \u0026#34;https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQGFNu4QL1YIazFeV-hVtIv686UNFqJwjReiObeCmAZiFvl7CHJ\u0026amp;s\u0026#34;, \u0026#34;https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQyMlTlY90LK_A_nbv8egC6yZkhvd4WmAHOoMzwVuGaH8VJKQga\u0026amp;s\u0026#34;, \u0026#34;https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSNfpqnbeGqjIObnVpLipvUve0QGjT3PANsVoAEsKSvvmFdozMD\u0026amp;s\u0026#34;, \u0026#34;https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTjTT47tCkv6wy93-JIno1Egv-0QQQ5rvKmSTZ9gZ5Jd64VPY2o\u0026amp;s\u0026#34;, \u0026#34;https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQGFNu4QL1YIazFeV-hVtIv686UNFqJwjReiObeCmAZiFvl7CHJ\u0026amp;s\u0026#34;, }; 2.itemçš„å¸ƒå±€\n\u0026lt;LinearLayout xmlns:android=\u0026#34;http://schemas.android.com/apk/res/android\u0026#34; xmlns:app=\u0026#34;http://schemas.android.com/apk/res-auto\u0026#34; xmlns:tools=\u0026#34;http://schemas.android.com/tools\u0026#34; android:layout_width=\u0026#34;match_parent\u0026#34; android:layout_height=\u0026#34;wrap_content\u0026#34;\u0026gt; \u0026lt;ImageView android:id=\u0026#34;@+id/imageView\u0026#34; android:layout_width=\u0026#34;wrap_content\u0026#34; android:layout_height=\u0026#34;150dp\u0026#34; android:layout_margin=\u0026#34;10dp\u0026#34; android:layout_weight=\u0026#34;1\u0026#34; tools:srcCompat=\u0026#34;@tools:sample/avatars\u0026#34; /\u0026gt; \u0026lt;/LinearLayout\u0026gt; 3.adapter\npublic class ImageListAdapter extends RecyclerView.Adapter\u0026lt;ImageListAdapter.ViewHolder\u0026gt; { private Context mContext; private String[] mImageList; private LayoutInflater mInflater; RequestOptions mOptions = new RequestOptions() .placeholder(R.mipmap.ic_launcher) .error(R.drawable.ic_launcher_background); public ImageListAdapter(Context mContext, String[] mImageList) { this.mContext = mContext; this.mImageList = mImageList; mInflater = LayoutInflater.from(mContext); } public class ViewHolder extends RecyclerView.ViewHolder { public ImageView imageView; public ViewHolder(@NonNull View itemView) { super(itemView); imageView = (ImageView) itemView.findViewById(R.id.imageView); } } @NonNull @Override public ImageListAdapter.ViewHolder onCreateViewHolder(@NonNull ViewGroup parent, int viewType) { View view = mInflater.inflate(R.layout.main_activity_list_item,parent,false); return new ViewHolder(view); } @Override public void onBindViewHolder(@NonNull ImageListAdapter.ViewHolder holder, int position) { Glide.with(mContext) .load(mImageList[position]) .apply(mOptions) .into(holder.imageView); } @Override public int getItemCount() { return mImageList.length; } } åœ¨activityä¸­ç»‘å®šRecyclerviewå’Œæ•°æ®æº RecyclerView.LayoutManager linearLayoutManager = new LinearLayoutManager(getApplicationContext()); ImageListAdapter adapter = new ImageListAdapter(this,mImageList); mRecyclerView = findViewById(R.id.recyclerView); mRecyclerView.setLayoutManager(linearLayoutManager); mRecyclerView.setAdapter(adapter); æ•ˆæœå›¾:\n5.ç¼“å­˜ å†…å­˜ç¼“å­˜ : é€šè¿‡ skipMemoryCache(true)å¯ä»¥è®¾ç½®ä¸è¿›è¡Œå†…å­˜ç¼“å­˜Â ç£ç›˜ç¼“å­˜ : diskCacheStrategy(DiskCacheStrategy) å‚æ•°ä¸­æœ‰å››ä¸ªé€‰é¡¹ :Â DiskCacheStrategy.ALL : æ—¢ç¼“å­˜åŸå›¾ä¹Ÿç¼“å­˜å¤„ç†å›¾\nDiskCacheStrategy.NONE : å•¥éƒ½ä¸ç¼“å­˜ = ç¦ç”¨ç£ç›˜ç¼“å­˜\nDiskCacheStrategy.SOURCE : åªç¼“å­˜åŸå›¾\nDiskCacheStrategy.RESULT : åªç¼“å­˜å¤„ç†å›¾\nBitmapPool : é¿å…åå¤åˆ›å»ºåŒæ ·å°ºå¯¸çš„bitmapè€Œç»´æŠ¤çš„ä¸€ä¸ªbitmapæ± .\nğŸˆTips :Glideçš„è¯»å–ç¼“å­˜é¡ºåºæ˜¯ : å…ˆä»å†…å­˜ä¸­è¯»å–ç¼“å­˜,è‹¥æ²¡æœ‰å†ä»ç£ç›˜ä¸­è¯»å–,è‹¥æ²¡æœ‰å†ä»loadä¸­åŠ è½½ã€‚\nè®¾ç½®Glideåªä»ç¼“å­˜ä¸­åŠ è½½å›¾ç‰‡ï¼Œå¦åˆ™åŠ è½½å¤±è´¥ã€‚ Glide.with(fragment) .load(url) .onlyRetrieveFromCache(true) .into(imageView); æ¸…ç†å†…å­˜ç¼“å­˜ Glide.get(context).clearMemory(); //éœ€è¦åœ¨ä¸»çº¿ç¨‹è¿è¡Œ æ¸…ç†ç£ç›˜ç¼“å­˜(éœ€è¦åœ¨å­çº¿ç¨‹è¿è¡Œ) new AsyncTask\u0026lt;Void, Void, Void\u0026gt; { @Override protected Void doInBackground(Void... params) { Glide.get(applicationContext).clearDiskCache(); return null; } } Glideå¯¹èµ„æºçš„é‡ç”¨æœºåˆ¶ Glideé€šè¿‡Â å¼•ç”¨è®¡æ•°æ³•Â æ¥åˆ¤æ–­ä¸€ä¸ªèµ„æºæ˜¯å¦æ­£åœ¨è¢«ä½¿ç”¨ :\nå½“ä¸€ä¸ªèµ„æºé€šè¿‡ into()Â æ–¹æ³•åŠ è½½æ—¶,å®ƒçš„ å¼•ç”¨è®¡æ•°Â å°±ä¼š+1 å½“æ‰¿è½½èµ„æºAçš„ ViewÂ æˆ–è€… TargetÂ è°ƒç”¨äº† clear()Â æˆ–è€…åˆè°ƒç”¨äº† into()Â åŠ è½½äº†åˆ«çš„èµ„æºæ—¶, Aèµ„æºçš„ å¼•ç”¨è®¡æ•°Â -1ã€‚ å½“ä¸€ä¸ªèµ„æºçš„ è®¡æ•°ä¸º0æ—¶ï¼Œå°±ä¼šè¢«é‡Šæ”¾ï¼ŒGlideå¯ä»¥é‡ç”¨è¯¥èµ„æºã€‚\n6.ä½¿ç”¨ç¼©ç•¥å›¾(Thumbnail) 1.å½“ä½ å·²ç»æœ‰å›¾ç‰‡çš„ç¼©ç•¥å›¾çš„èµ„æºæ—¶,å¯ä»¥ç›´æ¥ç”¨url/uriåŠ è½½\nGlideApp.with(mContext) .asDrawable() .load(åŸå›¾url) .thumbnail(Glide.with(mContext) .load(ç¼©ç•¥å›¾url)) .into(holder.imageView); 2.æ²¡æœ‰ç¼©ç•¥å›¾çš„èµ„æºæ—¶ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä¼ å…¥æƒ³è¦ç¼©å°çš„å€æ•°\nGlide.with(mContext) .asDrawable() .load(mImageList[position]) .thumbnail(0.1f) //ç¼©ç•¥å›¾å¤§å°ä¸ºåŸæ¥çš„ 1/10 .into(holder.imageView); 7.Target Targetå¯¹è±¡ç”¨æ¥ä¿å­˜æ¯ä¸€ä¸ªGlideè¯·æ±‚ã€‚å¦‚:\nTarget\u0026lt;Drawable\u0026gt; target = Glide.with(mContext) .asDrawable() .load(R.drawable.ic_launcher_foreground) .into(holder.imageView); è¿™æ ·åšçš„ç›®çš„æ˜¯å¯ä»¥æœ‰æ•ˆçš„å¯¹glideè¯·æ±‚è¿›è¡Œç®¡ç†ï¼Œå–æ¶ˆè¯·æ±‚ï¼Œæ¸…ç†èµ„æºã€‚\næ¸…ç†ä¹‹å‰çš„è¯·æ±‚ :Â Target\u0026lt;Drawable\u0026gt; target = Glide.with(mContext) .asDrawable() .load(R.drawable.ic_launcher_foreground) .into(holder.imageView); Glide.with(fragment).clear(target); //æ¸…ç†ä¹‹å‰çš„åŠ è½½,èŠ‚çœèµ„æº å½“ä½¿ç”¨è¿™ä¸ªtargetå†å‘å‡ºæ–°çš„åŠ è½½è¯·æ±‚æ—¶,glideä¹Ÿä¼šå¯¹ä¸Šä¸€æ¬¡çš„åŠ è½½è¿›è¡Œæ¸…ç†ï¼Œé‡Šæ”¾èµ„æºã€‚\nTarget\u0026lt;Drawable\u0026gt; target = Glide.with(mContext) .asDrawable() .load(R.drawable.ic_launcher_foreground) .into(holder.imageView); Glide.with(mContext) .load(mImageList[position]) .fitCenter() .into(target); 8.è¿‡æ¸¡åŠ¨ç”»(Transitions) æ ¹æ®å®˜æ–¹æ–‡æ¡£æè¿° , è¿‡æ¸¡åŠ¨ç”»åªèƒ½ä½œç”¨äºä¸€ä¸ªè¯·æ±‚ä¸­çš„(ä¸èƒ½ä½œç”¨äºå…ˆå2ä¸ªä¸åŒçš„è¯·æ±‚) :Â ä»å ä½ç¬¦-\u0026gt;åŸå›¾çš„è¿‡ç¨‹ ä»ç¼©ç•¥å›¾-\u0026gt;åŸå›¾çš„è¿‡ç¨‹ ç¤ºä¾‹: å¯ä»¥å‘ç°å ä½å›¾åˆ°åŸå›¾ä¹‹é—´çš„æ¸å˜æ•ˆæœ Glide.with(mContext) .load(mImageList[position]) .transition(withCrossFade(600)) //è®¾ç½®æ¸å˜çš„æŒç»­æ—¶é•¿600ms .placeholder(R.drawable.ic_launcher_foreground) .centerCrop() .into(holder.imageView); 9.è‡ªå®šä¹‰Module é€šè¿‡è‡ªå®šä¹‰moduleå¯ä»¥æ–¹ä¾¿æˆ‘ä»¬æ ¹æ®é¡¹ç›®çš„å®é™…éœ€æ±‚æ¥å®šåˆ¶åŒ–glideã€‚\né¦–å…ˆæ–°å»ºä¸€ä¸ªç±»ç»§æ‰¿ AppGlideModuleÂ ,å¹¶ç”¨ @GlideModuleÂ æ³¨è§£: /** * é€šè¿‡ç»§æ‰¿AppGlideModuleæ¥è‡ªå®šä¹‰Glide * @author chenyongda */ @GlideModule public class MyGlideApp extends AppGlideModule { } å†é‡æ–° ReBuildÂ ä¸€ä¸‹é¡¹ç›® ,å°†ä»£ç ä¸­ä¹‹å‰çš„ Glide.with()Â æ¢æˆ GlideApp.with()Â : GlideApp.with(mContext) .load(mImageList[position]) .placeholder(R.mipmap.ic_launcher) .error(R.drawable.ic_launcher_background) .into(holder.imageView); åœ¨applyIOptions()ä¸­è¿›è¡Œè‡ªå®šä¹‰é…ç½®: æ¯”å¦‚,æˆ‘ä»¬æƒ³è®©glideé»˜è®¤æƒ…å†µä¸‹ä¸è¿›è¡Œä»»ä½•ç¼“å­˜ã€‚\n@Override public void applyOptions(@NonNull Context context, @NonNull GlideBuilder builder) { //ä¸ç¼“å­˜å›¾ç‰‡ RequestOptions options = new RequestOptions() //ä¸è¿›è¡Œå†…å­˜ç¼“å­˜ .skipMemoryCache(true) //ä¸è¿›è¡Œç£ç›˜ç¼“å­˜ .diskCacheStrategy(DiskCacheStrategy.NONE); builder.setDefaultRequestOptions(options); //è®¾ç½®ä¸ºé»˜è®¤é…ç½® } åœ¨ applyOptions()Â å‡½æ•°ä¸­è¿˜å¯ä»¥å¯¹ç¼“å­˜æ ¹æ®éœ€è¦è¿›è¡Œè‡ªå®šä¹‰\nè‡ªå®šä¹‰å†…å­˜ç¼“å­˜ï¼š\næœ€å¤§ç¼“å­˜20mçš„å›¾ç‰‡\n@Override public void applyOptions(Context context, GlideBuilder builder) { int memoryCacheSizeBytes = 1024 * 1024 * 20; // 20mb builder.setMemoryCache(new LruResourceCache(memoryCacheSizeBytes)); } äºŒ.æºç è§£æ 1.Glide.with() : Glideçš„ç”Ÿå‘½å‘¨æœŸç®¡ç† è¿›å…¥Glide.with()æ–¹æ³• :\n@NonNull public static RequestManager with(@NonNull Context context) { return getRetriever(context).get(context); } é¦–å…ˆçœ‹ä¸€ä¸‹ getRetriever()Â æ–¹æ³•:\n@NonNull private static RequestManagerRetriever getRetriever(@Nullable Context context) { // Context could be null for other reasons (ie the user passes in null), but in practice it will // only occur due to errors with the Fragment lifecycle. Preconditions.checkNotNull( context, \u0026#34;You cannot start a load on a not yet attached View or a Fragment where getActivity() \u0026#34; + \u0026#34;returns null (which usually occurs when getActivity() is called before the Fragment \u0026#34; + \u0026#34;is attached or after the Fragment is destroyed).\u0026#34;); return Glide.get(context).getRequestManagerRetriever(); } é€šè¿‡æ³¨é‡Šäº†è§£åˆ° :è¿™ä¸ªæ–¹æ³•å…ˆå¯¹contextè¿›è¡Œåˆ¤ç©º,ä¹Ÿå°±æ˜¯å½“viewè¿˜æ²¡åŠ è½½æ—¶æˆ–è€…fragmentè¿˜æ²¡ä¸activityå»ºç«‹è”ç³»æ—¶ã€‚\nçœ‹ä¸€ä¸‹ Glide.get(context)Â æ–¹æ³• :Â /** * Get the singleton. * * @return the singleton */ @NonNull public static Glide get(@NonNull Context context) { if (glide == null) { synchronized (Glide.class) { if (glide == null) { checkAndInitializeGlide(context); } } } return glide; } è¿™æ˜¯ä¸€ä¸ªDCLåŒé‡æ£€éªŒé”çš„å•ä¾‹æ¨¡å¼ ã€‚\ncheckAndInitializeGlide()Â æ–¹æ³• :Â private static void checkAndInitializeGlide(@NonNull Context context) { // In the thread running initGlide(), one or more classes may call Glide.get(context). // Without this check, those calls could trigger infinite recursion. if (isInitializing) { throw new IllegalStateException(\u0026#34;You cannot call Glide.get() in registerComponents(),\u0026#34; + \u0026#34; use the provided Glide instance instead\u0026#34;); } isInitializing = true; initializeGlide(context); isInitializing = false; } è¿™ä¸ªæ–¹æ³•ç”¨æ¥ä¿è¯glideåœ¨åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨åˆå§‹åŒ–å®ƒã€‚\nRequestManagerRetriever :Â è¿™ä¸ªç±»æ˜¯ Glide çš„ä¸€ä¸ªè¾…åŠ©ç±»ï¼Œç”¨æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„ RequestManagerÂ å¯¹è±¡æˆ–è€…è·å¾—ä¸€ä¸ªå·²å­˜åœ¨çš„ acitivity/fragment , é‚£ RequestManagerå°†è¯·æ±‚ä¸activity/fragmentç­‰ç»„ä»¶å»ºç«‹è”ç³»ã€‚\nå†çœ‹ä¸€ä¸‹ RequestMangerRetrieverç±»çš„get()æ–¹æ³• :Â @NonNull public RequestManager get(@NonNull Context context) { if (context == null) { throw new IllegalArgumentException(\u0026#34;You cannot start a load on a null Context\u0026#34;); } else if (Util.isOnMainThread() \u0026amp;\u0026amp; !(context instanceof Application)) { if (context instanceof FragmentActivity) { return get((FragmentActivity) context); } else if (context instanceof Activity) { return get((Activity) context); } else if (context instanceof ContextWrapper) { return get(((ContextWrapper) context).getBaseContext()); } } return getApplicationManager(context); } è¿™ä¸ªæ–¹æ³•é€šè¿‡å°†æˆ‘ä»¬ä¼ å…¥çš„ context ï¼Œè½¬æ¢ä¸ºä¸ application/activity/fragmentå»ºç«‹è”ç³»çš„ ReuqestMangerÂ ç±» ,åŠ å…¥æˆ‘ä»¬ä¼ å…¥çš„æ˜¯ activity,ç‚¹è¿›ç¬¬ 9 è¡Œä»£ç  :\n@NonNull public RequestManager get(@NonNull Activity activity) { if (Util.isOnBackgroundThread()) { //å½“æˆ‘ä»¬åœ¨å­çº¿ç¨‹ç”¨glide,glideä¼šæŠŠè¯·æ±‚ä¸æ•´ä¸ªappçš„ç”Ÿå‘½å‘¨æœŸå»ºç«‹è”ç³». return get(activity.getApplicationContext()); } else { assertNotDestroyed(activity); //ç”¨äºåˆ›å»ºfragment android.app.FragmentManager fm = activity.getFragmentManager(); return fragmentGet( activity, fm, /*parentHint=*/ null, isActivityVisible(activity)); } } ç‚¹è¿›ç¬¬8è¡Œçš„ fragmentGet()Â :\nprivate RequestManager fragmentGet(@NonNull Context context, @NonNull android.app.FragmentManager fm, @Nullable android.app.Fragment parentHint, boolean isParentVisible) { //åˆ›å»ºä¸€ä¸ªéšè—çš„Fragment RequestManagerFragment current = getRequestManagerFragment(fm, parentHint, isParentVisible); RequestManager requestManager = current.getRequestManager(); //å¦‚æœè·å¾—çš„RequestManagerä¸ºç©ºçš„è¯å°±åˆ›å»ºä¸€ä¸ªã€‚ if (requestManager == null) { Glide glide = Glide.get(context); requestManager = factory.build( glide, current.getGlideLifecycle(), current.getRequestManagerTreeNode(), context); //æŠŠRequestManagerèµ‹ç»™Fragment current.setRequestManager(requestManager); } return requestManager; } åˆ°è¿™é‡Œå¯ä»¥å‘ç° Glideä¸activityå»ºç«‹è”ç³»çš„å…³é”®åœ¨äº:\nåˆ›å»ºäº†ä¸€ä¸ªæ— UIçš„FragmentÂ åˆ›å»ºäº†ä¸€ä¸ª RequestManagerÂ ,å¹¶é€šè¿‡ current.getGlideLifecycle()Â å°†fragmentçš„ ActivityFragmentLifecycleÂ æˆå‘˜ä¼ ç»™äº† RequestManagerÂ ã€‚ æ— UIçš„Fragmenté€šè¿‡ setRequestManager()Â ä¸ RequestManagerÂ å»ºç«‹è”ç³»ã€‚ ç¬¬12è¡Œä»£ç ä¸­åˆ›å»º RequestManagerÂ å¯¹è±¡æ—¶ è°ƒç”¨äº† RequestManagerÂ çš„æ„é€ æ–¹æ³• :Â æ„é€ æ–¹æ³•çš„22è¡Œè°ƒç”¨äº†ActivityFragmentLifecycleÂ çš„ addListener()æ–¹æ³•å°† RequestManagerÂ æ·»åŠ åˆ°è‡ªå·±çš„ç›‘å¬å™¨åˆ—è¡¨ä¸­ã€‚\nRequestManager( Glide glide, Lifecycle lifecycle, RequestManagerTreeNode treeNode, RequestTracker requestTracker, ConnectivityMonitorFactory factory, Context context) { this.glide = glide; this.lifecycle = lifecycle; this.treeNode = treeNode; this.requestTracker = requestTracker; this.context = context; connectivityMonitor = factory.build( context.getApplicationContext(), new RequestManagerConnectivityListener(requestTracker)); if (Util.isOnBackgroundThread()) { mainHandler.post(addSelfToLifecycle); } else { //å°† RequestManager æ·»åŠ åˆ°è‡ªå·±çš„ç›‘å¬å™¨åˆ—è¡¨ä¸­ã€‚ lifecycle.addListener(this); } lifecycle.addListener(connectivityMonitor); defaultRequestListeners = new CopyOnWriteArrayList\u0026lt;\u0026gt;(glide.getGlideContext().getDefaultRequestListeners()); setRequestOptions(glide.getGlideContext().getDefaultRequestOptions()); glide.registerRequestManager(this); } ä¸ºäº†çœ‹æ¸…æ¥šGlideæ˜¯å¦‚ä½•ä¸ç»„ä»¶activity/fragmentå»ºç«‹ç”Ÿå‘½å‘¨æœŸè”ç³»ï¼Œæˆ‘ä»¬å…ˆä»åˆšåˆšçš„æ— UIçš„Fragment-\u0026gt; RequestManagerFragmentÂ è¿™ä¸ªç±»çš„ç”Ÿå‘½å‘¨æœŸçœ‹èµ· :\npublic class RequestManagerFragment extends Fragment { private static final String TAG = \u0026#34;SupportRMFragment\u0026#34;; private final ActivityFragmentLifecycle lifecycle; @Override public void onStart() { super.onStart(); lifecycle.onStart(); } @Override public void onStop() { super.onStop(); lifecycle.onStop(); } @Override public void onDestroy() { super.onDestroy(); lifecycle.onDestroy(); unregisterFragmentWithRoot(); } } è¿™ä¸ªfragmentä¸­çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä¸­,åˆè°ƒç”¨äº†å¯¹åº”çš„ ActivityFragmentLifecycleÂ çš„æ–¹æ³• :Â class ActivityFragmentLifecycle implements Lifecycle { private final Set\u0026lt;LifecycleListener\u0026gt; lifecycleListeners = Collections.newSetFromMap(new WeakHashMap\u0026lt;LifecycleListener, Boolean\u0026gt;()); private boolean isStarted; private boolean isDestroyed @Override public void addListener(@NonNull LifecycleListener listener) { lifecycleListeners.add(listener); if (isDestroyed) { listener.onDestroy(); } else if (isStarted) { listener.onStart(); } else { listener.onStop(); } } @Override public void removeListener(@NonNull LifecycleListener listener) { lifecycleListeners.remove(listener); } void onStart() { isStarted = true; for (LifecycleListener lifecycleListener : Util.getSnapshot(lifecycleListeners)) { lifecycleListener.onStart(); } } void onStop() { isStarted = false; for (LifecycleListener lifecycleListener : Util.getSnapshot(lifecycleListeners)) { lifecycleListener.onStop(); } } void onDestroy() { isDestroyed = true; for (LifecycleListener lifecycleListener : Util.getSnapshot(lifecycleListeners)) { lifecycleListener.onDestroy(); } } } ActivityFragmentLifecycleÂ ä¸­æœ‰ä¸€ä¸ª Set\u0026lt;LifecycleListener\u0026gt;Â ç±»å‹çš„é›†åˆ,è€Œ RequestManagerÂ ä¹Ÿæ­£å¥½å®ç°äº† LifecycleListenerÂ è¿™ä¸ªæ¥å£ ,çœ‹ä¸€ä¸‹ RequestManagerÂ ä¸­çš„ onStart()Â æ–¹æ³• :Â @Override public synchronized void onStart() { //å¤„ç†è¯·æ±‚ resumeRequests(); targetTracker.onStart(); } @Override public synchronized void onStop() { pauseRequests(); targetTracker.onStop(); } public synchronized void resumeRequests() { requestTracker.resumeRequests(); } ... æ‰€ä»¥ç°åœ¨å¯ä»¥çœ‹å‡º,Glideä¸ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸç›¸å…³è”çš„æ–¹æ³•æ˜¯åŸºäºç±»ä¼¼é“¾å¼çš„ç»“æ„ã€‚\nActivityçš„ç”Ÿå‘½å‘¨æœŸä¼šå¼•èµ·æ— UIçš„Fragmentçš„ç”Ÿå‘½å‘¨æœŸå˜åŒ–. Fragmentçš„ç”Ÿå‘½å‘¨æœŸä¼šä¼šè°ƒç”¨è‡ªå·±æˆå‘˜å˜é‡ ActivityFragmentLifecycleÂ ä¸­å¯¹åº”çš„onXXX()æ–¹æ³•. ActivityFragmentLifecycleÂ çš„onXXX()æ–¹æ³•å†…éƒ¨åˆè°ƒç”¨äº† RequestManagerÂ çš„æ–¹æ³•ã€‚ 2.load(url) :Â åœ¨load()è¿™ä¸€ç¯èŠ‚éœ€è¦æˆ‘ä»¬ä¼ å…¥éœ€è¦åŠ è½½çš„å›¾ç‰‡çš„é“¾æ¥.\n@Override public RequestBuilder\u0026lt;Drawable\u0026gt; load(@Nullable String string) { return asDrawable().load(string); } loadæ–¹æ³•é»˜è®¤è°ƒç”¨äº† asDrawable()Â æ–¹æ³• :Â æ–¹æ³•ä¸»è¦ä½œç”¨æ˜¯åˆ›å»ºä¸€ä¸ªåŠ è½½ DrawableÂ èµ„æºç±»å‹çš„ RequestBuilderÂ ã€‚\npublic RequestBuilder\u0026lt;Drawable\u0026gt; asDrawable() { return as(Drawable.class); } public \u0026lt;ResourceType\u0026gt; RequestBuilder\u0026lt;ResourceType\u0026gt; as( @NonNull Class\u0026lt;ResourceType\u0026gt; resourceClass) { return new RequestBuilder\u0026lt;\u0026gt;(glide, this, resourceClass, context); } æŸ¥çœ‹ä¸€ä¸‹ load()Â æ–¹æ³• :Â å°†Stringå­—ç¬¦ä¸²èµ‹äºˆmodelå˜é‡\npublic RequestBuilder\u0026lt;TranscodeType\u0026gt; load(@Nullable String string) { return loadGeneric(string); } private RequestBuilder\u0026lt;TranscodeType\u0026gt; loadGeneric(@Nullable Object model) { this.model = model; isModelSet = true;//è¿™ä¸ªå˜é‡è¡¨ç¤ºå·²ç»è°ƒç”¨è¿‡load(),åœ¨into()ä¸­ä¼šå†æ¬¡ç”¨åˆ°æ­¤å˜é‡ã€‚ return this; } è€Œè¿™ä¸ªmodelå˜é‡å°†åœ¨åé¢çš„ into()Â ä¸­ä½¿ç”¨ã€‚\n3.into() public ViewTarget\u0026lt;ImageView, TranscodeType\u0026gt; into(@NonNull ImageView view) { //åˆ¤æ–­å½“å‰æ˜¯å¦æ˜¯åœ¨ä¸»çº¿ç¨‹,å› ä¸ºè¿™é‡Œæ¶‰åŠåˆ°æ”¹å˜UI Util.assertMainThread(); //æ£€æŸ¥ImageViewæ˜¯å¦ä¸ºç©º Preconditions.checkNotNull(view); BaseRequestOptions\u0026lt;?\u0026gt; requestOptions = this; if (!requestOptions.isTransformationSet() \u0026amp;\u0026amp; requestOptions.isTransformationAllowed() \u0026amp;\u0026amp; view.getScaleType() != null) { // Clone in this method so that if we use this RequestBuilder to load into a View and then // into a different target, we don\u0026#39;t retain the transformation applied based on the previous // View\u0026#39;s scale type. switch (view.getScaleType()) { case CENTER_CROP: requestOptions = requestOptions.clone().optionalCenterCrop(); break; case CENTER_INSIDE: requestOptions = requestOptions.clone().optionalCenterInside(); break; case FIT_CENTER: case FIT_START: case FIT_END: requestOptions = requestOptions.clone().optionalFitCenter(); break; case FIT_XY: requestOptions = requestOptions.clone().optionalCenterInside(); break; case CENTER: case MATRIX: default: // Do nothing. } } return into( //ç”±ImageViewæ„å»ºå‡ºTarget glideContext.buildImageViewTarget(view, transcodeClass), /*targetListener=*/ null, requestOptions, Executors.mainThreadExecutor()); } è¿™é‡Œçš„into()æ–¹æ³•åªæ˜¯æ ¹æ®ImageViewçš„æ¯”ä¾‹ç±»å‹ï¼Œå¯¹ RequestOptionsÂ è¿›è¡Œé…ç½®ã€‚\n36è¡Œçš„into()æ–¹æ³•ä¸­ç”¨ GlideContextÂ çš„ buildImageViewTarget()Â ç”¨ ImageView æ„å»ºå‡º Target.\nçœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³• :\n@NonNull public \u0026lt;X\u0026gt; ViewTarget\u0026lt;ImageView, X\u0026gt; buildImageViewTarget( @NonNull ImageView imageView, @NonNull Class\u0026lt;X\u0026gt; transcodeClass) { return imageViewTargetFactory.buildTarget(imageView, transcodeClass); } public class ImageViewTargetFactory { @NonNull @SuppressWarnings(\u0026#34;unchecked\u0026#34;) public \u0026lt;Z\u0026gt; ViewTarget\u0026lt;ImageView, Z\u0026gt; buildTarget(@NonNull ImageView view, @NonNull Class\u0026lt;Z\u0026gt; clazz) { if (Bitmap.class.equals(clazz)) { //Bitmapç±»å‹çš„ViewTarget return (ViewTarget\u0026lt;ImageView, Z\u0026gt;) new BitmapImageViewTarget(view); } else if (Drawable.class.isAssignableFrom(clazz)) { //Drawableç±»å‹çš„ViewTarget return (ViewTarget\u0026lt;ImageView, Z\u0026gt;) new DrawableImageViewTarget(view); } else { throw new IllegalArgumentException( \u0026#34;Unhandled class: \u0026#34; + clazz + \u0026#34;, try .as*(Class).transcode(ResourceTranscoder)\u0026#34;); } } } å¯ä»¥çœ‹å‡º ImageViewTargetFactory è¿™ä¸ªç±»å°±æ˜¯ç”¨æ¥æŠŠ ImageView è½¬åŒ–ä¸º2ç§(Bitmap,Drawable) ç±»å‹çš„ ViewTargetçš„ã€‚\nè€Œæˆ‘ä»¬ä¹‹å‰åœ¨åˆ†æ load() æ–¹æ³•æ—¶çœ‹åˆ°é»˜è®¤æƒ…å†µä¸‹æŠŠèµ„æºå½“ä½œ Drawable ç±»å‹å¤„ç† , æ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹éƒ½æ˜¯ç”Ÿæˆçš„ DrawableImageViewTarget ã€‚\n@Override public RequestBuilder\u0026lt;Drawable\u0026gt; load(@Nullable String string) { return asDrawable().load(string); } ç»§ç»­æ·±å…¥ä¹‹å‰çš„ into() æ–¹æ³•ã€‚\nprivate \u0026lt;Y extends Target\u0026lt;TranscodeType\u0026gt;\u0026gt; Y into( @NonNull Y target, //æŠŠåˆ›å»ºçš„Targetä¼ è¿›æ¥ @Nullable RequestListener\u0026lt;TranscodeType\u0026gt; targetListener, BaseRequestOptions\u0026lt;?\u0026gt; options, Executor callbackExecutor) { //Targetä¸èƒ½ä¸ºç©º Preconditions.checkNotNull(target); // isModelSetåœ¨load()è¢«è°ƒç”¨è¿‡æ‰ä¼šä¸ºtrue if (!isModelSet) { throw new IllegalArgumentException(\u0026#34;You must call #load() before calling #into()\u0026#34;); } //åˆ›å»ºRequestå¯¹è±¡ , ç¨åè§£æ Request request = buildRequest(target, targetListener, options, callbackExecutor); //è·å–æ­¤ImageViewçš„ä¹‹å‰çš„è¯·æ±‚å¯¹è±¡ Request previous = target.getRequest(); //å¦‚æœæ­¤æ¬¡çš„è¯·æ±‚å’Œä¹‹å‰çš„è¯·æ±‚ç›¸åŒå¹¶ä¸”å¯ç”¨äº†å†…å­˜ç¼“å­˜ if (request.isEquivalentTo(previous) \u0026amp;\u0026amp; !isSkipMemoryCacheWithCompletePreviousRequest(options, previous)) { //å›æ”¶è¯·æ±‚èµ„æº request.recycle(); //è‹¥ä¸Šä¸€æ¬¡çš„è¯·æ±‚æ²¡æœ‰åœ¨åŠ è½½ï¼Œåˆ™å†æ‰§è¡Œè¿™ä¸ªè¯·æ±‚ if (!Preconditions.checkNotNull(previous).isRunning()) { previous.begin(); } return target; } //è‹¥è¿™æ¬¡è¯·æ±‚ä¸ä¸Šæ¬¡ä¸åŒ,åˆ™å–æ¶ˆä¸Šä¸€æ¬¡è¯·æ±‚ requestManager.clear(target); target.setRequest(request); requestManager.track(target, request); return target; } ","permalink":"https://chenyongda2018.github.io/posts/android/glide_study/","summary":"\u003ch1 id=\"ä¸€ä½¿ç”¨\"\u003eä¸€.ä½¿ç”¨\u003c/h1\u003e\n\u003ch2 id=\"1é…ç½®ä¾èµ–\"\u003e1.é…ç½®ä¾èµ–\u003c/h2\u003e\n\u003cp\u003eåœ¨ \u003ccode\u003eapp\u003c/code\u003eÂ å±‚ \u003ccode\u003ebuild.gradle\u003c/code\u003eÂ ä¸­æ·»åŠ ä¾èµ– :Â \u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-xml\" data-lang=\"xml\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003edependencies {\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    ...\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    implementation \u0026#39;com.github.bumptech.glide:glide:4.9.0\u0026#39;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    annotationProcessor \u0026#39;com.github.bumptech.glide:compiler:4.9.0\u0026#39;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    annotationProcessor \u0026#39;androidx.annotation:annotation:1.1.0\u0026#39;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    ...\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eæ·»åŠ å¿…è¦æƒé™ :Â \u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-xml\" data-lang=\"xml\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003e\u0026lt;uses-permission\u003c/span\u003e \u003cspan class=\"na\"\u003eandroid:name=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;android.permission.INTERNET\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003e\u0026lt;uses-permission\u003c/span\u003e \u003cspan class=\"na\"\u003eandroid:name=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;android.permission.ACCESS_NETWORK_STATE\u0026#34;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003e\u0026lt;uses-permission\u003c/span\u003e \u003cspan class=\"na\"\u003eandroid:name=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;android.permission.READ_EXTERNAL_STORAGE\u0026#34;\u003c/span\u003e \u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003e\u0026lt;uses-permission\u003c/span\u003e \u003cspan class=\"na\"\u003eandroid:name=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;android.permission.WRITE_EXTERNAL_STORAGE\u0026#34;\u003c/span\u003e \u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"2åˆæ­¥ä¸Šæ‰‹\"\u003e2.åˆæ­¥ä¸Šæ‰‹\u003c/h2\u003e\n\u003cp\u003eä»£ç  :Â \u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eGlide\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ewith\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003easBitmap\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c1\"\u003e//æŠŠåŠ¨å›¾å½“ä½œé™æ­¢å›¾ç‰‡å¤„ç†,ä¹Ÿå°±æ˜¯åªæ˜¾ç¤ºgifå›¾çš„ç¬¬ä¸€å¸§\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eload\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;https://pic2.zhimg.com/v2-c4970ee756c55333b7b871c5b617d9ed_b.gif\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"c1\"\u003e//å›¾ç‰‡url\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eplaceholder\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eR\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003emipmap\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eic_launcher\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c1\"\u003e//å ä½ç¬¦,åœ¨åŠ è½½å›¾ç‰‡å®Œæˆä¹‹å‰æ˜¾ç¤ºçš„å›¾ç‰‡\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eerror\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eR\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003edrawable\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eic_launcher_background\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c1\"\u003e//åŠ è½½å¤±è´¥æ—¶æ˜¾ç¤ºçš„å›¾ç‰‡\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003efitCenter\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c1\"\u003e//å½“å›¾ç‰‡é•¿å®½å¤§äºImageViewæ—¶,ç¼©æ”¾å›¾ç‰‡\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003efallback\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eR\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003emipmap\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eic_launcher\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c1\"\u003e//å›¾ç‰‡urlä¸ºNullæ—¶æ˜¾ç¤ºçš„å›¾ç‰‡\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003einto\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eimage1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c1\"\u003e// æ”¾å…¥åˆ°ImageViewä¸­\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eæ•ˆæœå›¾ :\u003c/p\u003e\n\u003c!-- raw HTML omitted --\u003e\n\u003cp\u003eğŸˆTips : fitCenter()ä¸CenterCrop()åŒºåˆ« :Â \u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003efitCenter() : æ•ˆæœå¦‚ä¸Šå›¾,ç¼©æ”¾åŸå›¾è‡³ImageViewå¤§å°ã€‚\u003c/li\u003e\n\u003cli\u003eCenterCrop():å¦‚ä¸‹å›¾,ä¿æŒåŸå›¾ä¸å˜ï¼Œåªæ ¹æ®ImageViewå¤§å°æ˜¾ç¤ºå¯¹åº”éƒ¨åˆ†ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003c!-- raw HTML omitted --\u003e\n\u003ch2 id=\"3é…åˆrecyclerviewæ˜¾ç¤ºå›¾ç‰‡åˆ—è¡¨\"\u003e3.é…åˆRecyclerViewæ˜¾ç¤ºå›¾ç‰‡åˆ—è¡¨\u003c/h2\u003e\n\u003cp\u003e1.éœ€è¦åŠ è½½çš„å›¾ç‰‡urlæ•°æ®æº\u003c/p\u003e","title":"Glideå­¦ä¹ ç¬”è®°"},{"content":"å‰è¨€ æœ€è¿‘å®éªŒå®¤å¼€äº†ä¸ªæ–°é¡¹ç›®ï¼Œæ˜¯ä¸€ä¸ªé€šè¿‡æ‰«æå•è¯åæŠŠæ‰«æè¿‡çš„å•è¯ç”Ÿæˆæ¸¸æˆæ¥è®©å°æœ‹å‹è®°å•è¯çš„APPï¼Œæ‰«æå•è¯è¿™ä¸ªåŠŸèƒ½éœ€è¦ç”¨åˆ°OCR.\nç°åœ¨å¸¸ç”¨çš„OCRæœ‰\nTesseract è¿™ä¸ªç”¨çš„äººæ¯”è¾ƒå¤šï¼Œè€Œä¸”å¼€æºï¼Œç›®å‰googleæ­£åœ¨ç»´æŠ¤ï¼Œä½†æ˜¯æˆ‘å°è¯•äº†ä¸€ä¸‹ï¼Œå‘ç°è¯†åˆ«å‡†ç¡®ç‡ä¸æ˜¯ç‰¹åˆ«ç†æƒ³ã€‚\nå¾®è½¯çš„Azureä¸Šçš„è®¤çŸ¥æœåŠ¡ è¯†åˆ«ç‡å¾ˆé«˜ï¼Œä½†æ˜¯æ”¶è´¹ï¼Œç°åœ¨æœ‰1å…ƒä½“éªŒçš„å¥—é¤ï¼Œè€Œä¸”ä¸éœ€è¦éªŒè¯ä¿¡ç”¨å¡ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è¯•è¯•ã€‚\nç™¾åº¦çš„æ–‡å­—è¯†åˆ« ä¹‹æ‰€ä»¥ç”¨è¿™ä¸ªæ˜¯å› ä¸ºå…è´¹ï¼Œä¸è¿‡æœ‰æ¯å¤©çš„é™åˆ¶æ¬¡æ•°ï¼Œå¯¹äºå­¦ç”Ÿé¡¹ç›®æ¥è¯´å¤Ÿç”¨ï¼Œè¿˜è¦ä»€ä¹ˆè‡ªè¡Œè½¦ã€‚\nä¸‹é¢è¿›å…¥æ­£æ–‡\nå¦‚ä½•åœ¨Android ä¸­è°ƒç”¨ç™¾åº¦çš„OCRè¿›è¡Œæ–‡å­—è¯†åˆ« 1.è·å–ç™¾åº¦æ–‡å­—è¯†åˆ«äº§å“æœåŠ¡çš„ Ak/Sk 1.åœ¨ç™¾åº¦AIå¼€æ”¾å¹³å°ä¸­è¿›å…¥æ§åˆ¶å°\n2.æ‰¾åˆ°æ–‡å­—è¯†åˆ« äº§å“æœåŠ¡\n3,åˆ›å»ºåº”ç”¨\n4,å¡«å†™ä¿¡æ¯ï¼Œæ³¨æ„è¿™é‡Œçš„åŒ…åä¸€å®šè¦å’Œé¡¹ç›®çš„åŒ…åä¸€è‡´\n5.è·å¾—AK/SK\n6.ä¸‹è½½licenseæ–‡ä»¶ï¼Œåœ¨é¡¹ç›®ä¸­å¦‚æœç›´æ¥ç”¨AK/SKæ˜æ–‡è°ƒç”¨ç™¾åº¦çš„OCRï¼Œå¾ˆä¸å®‰å…¨ï¼Œå¯èƒ½ä¼šè¢«åˆ«äººåç¼–è¯‘ä¹‹åè·å¾—ä½ çš„AK.SK\nlicenseæ–‡ä»¶é›†æˆäº†AK/SK æ”¾åœ¨é¡¹ç›®ä¸­å¯ä»¥é˜²æ­¢åˆ«äººç ´è§£ã€‚ 7.ä¸‹è½½ä¹‹åå°†è·å¾—çš„api.licenseæ–‡ä»¶æ”¾å…¥mainç›®å½•ä¸‹çš„assetsç›®å½•ä¸­\n2.æ·»åŠ ç™¾åº¦OCRçš„SDKåˆ°é¡¹ç›®ä¸­ 1.ä¸‹è½½ ç™¾åº¦OCRçš„android Sdk\n2.ä¸‹è½½çš„SDKå‹ç¼©åŒ…å°†å…¶è§£å‹ï¼Œå¹¶å°†libsä¸‹çš„ocr-sdkçš„jaråŒ…æ”¾å…¥é¡¹ç›®çš„libsç›®å½•ä¸‹ 3.åœ¨mainç›®å½•ä¸‹æ–°å»ºjniLibsç›®å½•ï¼Œå¹¶å°†libsæ–‡ä»¶å¤¹ä¸­çš„å…¶ä»–æ–‡ä»¶æ”¾å…¥å…¶ä¸­\n4.åœ¨appä¸‹çš„build,gradleä¸­æ·»åŠ \nå°†æ·»åŠ åœ¨libsä¸‹çš„sdk JARåŒ…ç¼–è¯‘\n5.è¿™é‡Œä¸‹è½½çš„å‹ç¼©åŒ…ä¸­åŒ…æ‹¬äº†ç™¾åº¦æä¾›çš„ç›¸æœºæ‰«ææ—¶çš„UIï¼Œåœ¨æ‹å®Œç…§æœ‰è£å‰ªæ¡†ï¼Œæ¯”è¾ƒæ–¹ä¾¿ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥ä½œä¸ºmoduleå¼•å…¥é¡¹ç›®ä¸­ 3.è°ƒç”¨ç™¾åº¦OCR åšå®Œå‡†å¤‡å·¥ä½œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹è°ƒç”¨ç™¾åº¦çš„OCRæ¥å£äº†ã€‚\né¦–å…ˆåœ¨æˆ‘ä»¬éœ€è¦è¿›è¡Œè¯†åˆ«çš„é¡µé¢æ‰€åœ¨çš„æ–‡ä»¶ä¸­åˆ›å»º æ ¹æ®Licenseæ–‡ä»¶åˆå§‹åŒ–OCRå®ä¾‹çš„å‡½æ•°ï¼Œå¹¶åœ¨onCreate()æ–¹æ³•ä¸­è°ƒç”¨\n/** * è‡ªå®šä¹‰licenseçš„æ–‡ä»¶è·¯å¾„å’Œæ–‡ä»¶åç§°ï¼Œä»¥licenseæ–‡ä»¶æ–¹å¼åˆå§‹åŒ– */ private void initAccessTokenLicenseFile() { OCR.getInstance(mActivity.getApplicationContext()).initAccessToken(new OnResultListener\u0026lt;AccessToken\u0026gt;() { @Override public void onResult(AccessToken accessToken) { String token = accessToken.getAccessToken(); Log.d(TAG,token); hasGotToken = true; } @Override public void onError(OCRError error) { error.printStackTrace(); alertText(\u0026#34;è‡ªå®šä¹‰æ–‡ä»¶è·¯å¾„licenceæ–¹å¼è·å–tokenå¤±è´¥\u0026#34;, error.getMessage()); } }, \u0026#34;aip.license\u0026#34;, mActivity.getApplicationContext()); } å®šä¹‰æˆ‘ä»¬çš„æ‰“å¼€ç›¸æœºäº‹ä»¶\n/** * æ‰“å¼€ç›¸æœºï¼Œè¿›å…¥çš„ç›¸æœºé¡µé¢æ˜¯å€Ÿç”¨ç™¾åº¦OCR å®˜æ–¹DEMOä¸­çš„ç›¸æœºé¡µé¢ * èƒ½å¤Ÿåœ¨ç›¸æœºä¸­è£å‰ªå›¾ç‰‡ï¼Œå’Œè¿›å…¥å›¾åº“ * @author cyd */ private void openCameraForResult() { if (!checkTokenStatus()) { return; } Intent intent = new Intent(mActivity, CameraActivity.class); intent.putExtra(CameraActivity.KEY_OUTPUT_FILE_PATH, FileUtil.getSaveFile(getActivity()).getAbsolutePath()); intent.putExtra(CameraActivity.KEY_CONTENT_TYPE, CameraActivity.CONTENT_TYPE_GENERAL); startActivityForResult(intent, REQUEST_CODE_GENERAL_BASIC); } è¿™é‡Œçš„CameraActivityç”¨çš„æ˜¯å¼•å…¥OCR_UIä¸­çš„ç›¸æœºæ´»åŠ¨ï¼Œè‡ªå¸¦å‰ªè£æ¡†\næ¥ä¸‹æ¥éœ€è¦æˆ‘ä»¬æ–°å»ºä¸€ä¸ªå¯ä»¥å­˜æ”¾OCRçš„è¯†åˆ«æ–¹æ³•çš„ç±»RecognizeService\n** * è¿™ä¸ªç±»æ˜¯ç”¨äºå°†æ‹æ‘„æˆ–è€…å›¾åº“ä¸­è·å¾—çš„å›¾ç‰‡è¿›è¡Œè¯†åˆ«ï¼Œè¿”å›JSONæ ¼å¼çš„å­—ç¬¦ä¸²ã€‚ */ public class RecognizeService { public interface ServiceListener { public void onResult(String result); } //é«˜ç²¾åº¦ç‰ˆ public static void recAccurateBasic(Context ctx, String filePath, final ServiceListener listener) { GeneralParams param = new GeneralParams(); param.setDetectDirection(true); param.setVertexesLocation(true); param.setLanguageType(GeneralBasicParams.ENGLISH); param.setRecognizeGranularity(GeneralParams.GRANULARITY_SMALL); param.setImageFile(new File(filePath)); //è¿™é‡Œçš„recognizeAccurateBasicæ–¹æ³•ä¸ºç™¾åº¦OCRè¯†åˆ«çš„æ ¸å¿ƒæ–¹æ³• OCR.getInstance(ctx).recognizeAccurateBasic(param, new OnResultListener\u0026lt;GeneralResult\u0026gt;() { @Override public void onResult(GeneralResult result) { StringBuilder sb = new StringBuilder(); for (WordSimple wordSimple : result.getWordList()) { WordSimple word = wordSimple; sb.append(word.getWords()); sb.append(\u0026#34;\\n\u0026#34;); } listener.onResult(result.getJsonRes()); } @Override public void onError(OCRError error) { listener.onResult(error.getMessage()); } }); } } åœ¨onActivityResultæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬è°ƒç”¨åˆšåˆšæ–°å»ºçš„ç±»çš„recAccurateBasicæ–¹æ³•ï¼Œæ­¤æ–¹æ³•æ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯context,æ‹ç…§è·å–çš„å›¾ç‰‡è·¯å¾„ï¼Œå’Œåœ¨RecognizeServiceç±»ä¸­å®šä¹‰çš„ç›‘å¬æ¥å£ï¼Œè¿™é‡Œçš„è·å–å›¾ç‰‡è·¯å¾„æ–¹æ³•ï¼Œæˆ‘ç”¨çš„æ˜¯ç™¾åº¦å®˜æ–¹DEMOä¸­çš„æ–¹æ³•\nåœ¨onResultæ–¹æ³•ä¸­ï¼Œè¿”å›çš„resultå­—ç¬¦ä¸²å³ä¸ºè¯†åˆ«ç»“æœçš„jsonå­—ç¬¦ä¸²ï¼Œåªéœ€è¦å¯¹JSONè§£æä¸€ä¸‹å°±èƒ½å¾—åˆ°è¯†åˆ«ç»“æœå•¦\n@Override public void onActivityResult(int requestCode, int resultCode, Intent data) { super.onActivityResult(requestCode, resultCode, data); switch (requestCode) { case REQUEST_CODE_GENERAL_BASIC: if (resultCode == Activity.RESULT_OK) { RecognizeService.recAccurateBasic(mActivity, FileUtil.getSaveFile(mActivity.getApplicationContext()).getAbsolutePath(), new RecognizeService.ServiceListener() { @Override public void onResult(String result) { Bundle bundle = new Bundle(); bundle.putString(\u0026#34;wordResultJson\u0026#34;,result ); Intent intent = new Intent(mActivity,SelectWordsActivity.class); intent.putExtra(\u0026#34;wordResultBundle\u0026#34;,bundle ); startActivity(intent); } }); } break; default: Log.d(TAG, \u0026#34;onActivityResult: \u0026#34;+\u0026#34;run in default\u0026#34;); break; } } FileUtilç±»\npublic class FileUtil { public static File getSaveFile(Context context) { File file = new File(context.getFilesDir(), \u0026#34;pic.jpg\u0026#34;); return file; } } (å®Œ~)\n","permalink":"https://chenyongda2018.github.io/posts/android/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%9C%A8android%E4%B8%AD%E8%B0%83%E7%94%A8%E7%99%BE%E5%BA%A6%E7%9A%84ocr%E6%8E%A5%E5%8F%A3%E7%9A%84%E7%BB%8F%E5%8E%86/","summary":"\u003ch1 id=\"å‰è¨€\"\u003eå‰è¨€\u003c/h1\u003e\n\u003cp\u003eæœ€è¿‘å®éªŒå®¤å¼€äº†ä¸ªæ–°é¡¹ç›®ï¼Œæ˜¯ä¸€ä¸ªé€šè¿‡æ‰«æå•è¯åæŠŠæ‰«æè¿‡çš„å•è¯ç”Ÿæˆæ¸¸æˆæ¥è®©å°æœ‹å‹è®°å•è¯çš„APPï¼Œæ‰«æå•è¯è¿™ä¸ªåŠŸèƒ½éœ€è¦ç”¨åˆ°OCR.\u003cbr\u003e\nç°åœ¨å¸¸ç”¨çš„OCRæœ‰\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/tesseract-ocr/tesseract\"\u003eTesseract\u003c/a\u003e è¿™ä¸ªç”¨çš„äººæ¯”è¾ƒå¤šï¼Œè€Œä¸”å¼€æºï¼Œç›®å‰googleæ­£åœ¨ç»´æŠ¤ï¼Œä½†æ˜¯æˆ‘å°è¯•äº†ä¸€ä¸‹ï¼Œå‘ç°è¯†åˆ«å‡†ç¡®ç‡ä¸æ˜¯ç‰¹åˆ«ç†æƒ³ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eå¾®è½¯çš„Azureä¸Šçš„\u003ca href=\"https://www.azure.cn/zh-cn/home/features/cognitive-services/computer-vision/\"\u003eè®¤çŸ¥æœåŠ¡\u003c/a\u003e è¯†åˆ«ç‡å¾ˆé«˜ï¼Œä½†æ˜¯æ”¶è´¹ï¼Œç°åœ¨æœ‰1å…ƒä½“éªŒçš„å¥—é¤ï¼Œè€Œä¸”ä¸éœ€è¦éªŒè¯ä¿¡ç”¨å¡ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è¯•è¯•ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eç™¾åº¦çš„\u003ca href=\"https://cloud.baidu.com/doc/OCR/OCR-API.html#.E8.AF.B7.E6.B1.82.E8.AF.B4.E6.98.8E\"\u003eæ–‡å­—è¯†åˆ«\u003c/a\u003e ä¹‹æ‰€ä»¥ç”¨è¿™ä¸ªæ˜¯å› ä¸ºå…è´¹ï¼Œä¸è¿‡æœ‰æ¯å¤©çš„é™åˆ¶æ¬¡æ•°ï¼Œå¯¹äºå­¦ç”Ÿé¡¹ç›®æ¥è¯´å¤Ÿç”¨ï¼Œè¿˜è¦ä»€ä¹ˆè‡ªè¡Œè½¦ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eä¸‹é¢è¿›å…¥æ­£æ–‡\u003c/p\u003e\n\u003ch1 id=\"å¦‚ä½•åœ¨android-ä¸­è°ƒç”¨ç™¾åº¦çš„ocrè¿›è¡Œæ–‡å­—è¯†åˆ«\"\u003eå¦‚ä½•åœ¨Android ä¸­è°ƒç”¨ç™¾åº¦çš„OCRè¿›è¡Œæ–‡å­—è¯†åˆ«\u003c/h1\u003e\n\u003ch2 id=\"1è·å–ç™¾åº¦æ–‡å­—è¯†åˆ«äº§å“æœåŠ¡çš„-aksk\"\u003e1.è·å–ç™¾åº¦æ–‡å­—è¯†åˆ«äº§å“æœåŠ¡çš„ Ak/Sk\u003c/h2\u003e\n\u003cp\u003e1.åœ¨\u003ca href=\"http://ai.baidu.com/tech/ocr\"\u003eç™¾åº¦AIå¼€æ”¾å¹³å°\u003c/a\u003eä¸­è¿›å…¥æ§åˆ¶å°\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/5/10/16aa0c3207893f26~tplv-t2oaga2asx-image.image\"\u003e\u003c/p\u003e\n\u003cp\u003e2.æ‰¾åˆ°æ–‡å­—è¯†åˆ« äº§å“æœåŠ¡\u003cbr\u003e\n\u003cimg loading=\"lazy\" src=\"https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/5/10/16aa0c33733f10e6~tplv-t2oaga2asx-image.image\"\u003e\u003c/p\u003e\n\u003cp\u003e3,åˆ›å»ºåº”ç”¨\u003cbr\u003e\n\u003cimg loading=\"lazy\" src=\"https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/5/10/16aa0c3205d91865~tplv-t2oaga2asx-image.image\"\u003e\u003c/p\u003e\n\u003cp\u003e4,å¡«å†™ä¿¡æ¯ï¼Œ\u003cstrong\u003eæ³¨æ„è¿™é‡Œçš„åŒ…åä¸€å®šè¦å’Œé¡¹ç›®çš„åŒ…åä¸€è‡´\u003c/strong\u003e\u003cbr\u003e\n\u003cimg loading=\"lazy\" src=\"https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/5/10/16aa0c32077c3cb0~tplv-t2oaga2asx-image.image\"\u003e\u003cbr\u003e\n\u003cimg loading=\"lazy\" src=\"https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/5/10/16aa0c3208e59688~tplv-t2oaga2asx-image.image\"\u003e\u003c/p\u003e\n\u003cp\u003e5.è·å¾—AK/SK\u003cbr\u003e\n\u003cimg loading=\"lazy\" src=\"https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/5/10/16aa0c320ae4cfd7~tplv-t2oaga2asx-image.image\"\u003e\u003c/p\u003e\n\u003cp\u003e6.ä¸‹è½½licenseæ–‡ä»¶ï¼Œåœ¨é¡¹ç›®ä¸­å¦‚æœç›´æ¥ç”¨AK/SKæ˜æ–‡è°ƒç”¨ç™¾åº¦çš„OCRï¼Œå¾ˆä¸å®‰å…¨ï¼Œå¯èƒ½ä¼šè¢«åˆ«äººåç¼–è¯‘ä¹‹åè·å¾—ä½ çš„AK.SK\u003cbr\u003e\nlicenseæ–‡ä»¶é›†æˆäº†AK/SK æ”¾åœ¨é¡¹ç›®ä¸­å¯ä»¥é˜²æ­¢åˆ«äººç ´è§£ã€‚\n\u003cimg loading=\"lazy\" src=\"https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/5/10/16aa0c32bfbe0ac0~tplv-t2oaga2asx-image.image\"\u003e\u003c/p\u003e\n\u003cp\u003e7.ä¸‹è½½ä¹‹åå°†è·å¾—çš„api.licenseæ–‡ä»¶æ”¾å…¥mainç›®å½•ä¸‹çš„assetsç›®å½•ä¸­\u003cbr\u003e\n\u003cimg loading=\"lazy\" src=\"https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/5/10/16aa0c32321a5ee2~tplv-t2oaga2asx-image.image\"\u003e\u003c/p\u003e\n\u003ch2 id=\"2æ·»åŠ ç™¾åº¦ocrçš„sdkåˆ°é¡¹ç›®ä¸­\"\u003e2.æ·»åŠ ç™¾åº¦OCRçš„SDKåˆ°é¡¹ç›®ä¸­\u003c/h2\u003e\n\u003cp\u003e1.ä¸‹è½½ \u003ca href=\"https://ai.baidu.com/sdk#ocr\"\u003eç™¾åº¦OCRçš„android Sdk\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/5/10/16aa0c33207fef3d~tplv-t2oaga2asx-image.image\"\u003e\u003cbr\u003e\n2.ä¸‹è½½çš„SDKå‹ç¼©åŒ…å°†å…¶è§£å‹ï¼Œå¹¶å°†libsä¸‹çš„ocr-sdkçš„jaråŒ…æ”¾å…¥é¡¹ç›®çš„libsç›®å½•ä¸‹ \u003cbr\u003e\n\u003cimg loading=\"lazy\" src=\"https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/5/10/16aa0c332114fc9f~tplv-t2oaga2asx-image.image\"\u003e\u003cbr\u003e\n\u003cimg loading=\"lazy\" src=\"https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/5/10/16aa0c3327d5bc7b~tplv-t2oaga2asx-image.image\"\u003e\u003c/p\u003e\n\u003cp\u003e3.åœ¨mainç›®å½•ä¸‹æ–°å»ºjniLibsç›®å½•ï¼Œå¹¶å°†libsæ–‡ä»¶å¤¹ä¸­çš„å…¶ä»–æ–‡ä»¶æ”¾å…¥å…¶ä¸­\u003cbr\u003e\n\u003cimg loading=\"lazy\" src=\"https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/5/10/16aa0c33330971ce~tplv-t2oaga2asx-image.image\"\u003e\n\u003cimg loading=\"lazy\" src=\"https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/5/10/16aa0c333ab33813~tplv-t2oaga2asx-image.image\"\u003e\u003c/p\u003e\n\u003cp\u003e4.åœ¨appä¸‹çš„build,gradleä¸­æ·»åŠ \u003cbr\u003e\n\u003cimg loading=\"lazy\" src=\"https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/5/10/16aa0c339602cd1c~tplv-t2oaga2asx-image.image\"\u003e\u003cbr\u003e\nå°†æ·»åŠ åœ¨libsä¸‹çš„sdk JARåŒ…ç¼–è¯‘\u003c/p\u003e\n\u003cp\u003e5.è¿™é‡Œä¸‹è½½çš„å‹ç¼©åŒ…ä¸­åŒ…æ‹¬äº†ç™¾åº¦æä¾›çš„ç›¸æœºæ‰«ææ—¶çš„UIï¼Œåœ¨æ‹å®Œç…§æœ‰è£å‰ªæ¡†ï¼Œæ¯”è¾ƒæ–¹ä¾¿ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥ä½œä¸ºmoduleå¼•å…¥é¡¹ç›®ä¸­\n\u003cimg loading=\"lazy\" src=\"https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/5/10/16aa0c33a2e8f5e2~tplv-t2oaga2asx-image.image\"\u003e\u003cbr\u003e\n\u003cimg loading=\"lazy\" src=\"https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/5/10/16aa0c339b46cc37~tplv-t2oaga2asx-image.image\"\u003e\u003c/p\u003e\n\u003ch2 id=\"3è°ƒç”¨ç™¾åº¦ocr\"\u003e3.è°ƒç”¨ç™¾åº¦OCR\u003c/h2\u003e\n\u003cp\u003eåšå®Œå‡†å¤‡å·¥ä½œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹è°ƒç”¨ç™¾åº¦çš„OCRæ¥å£äº†ã€‚\u003c/p\u003e\n\u003cp\u003eé¦–å…ˆåœ¨æˆ‘ä»¬éœ€è¦è¿›è¡Œè¯†åˆ«çš„é¡µé¢æ‰€åœ¨çš„æ–‡ä»¶ä¸­åˆ›å»º æ ¹æ®Licenseæ–‡ä»¶åˆå§‹åŒ–OCRå®ä¾‹çš„å‡½æ•°ï¼Œå¹¶åœ¨onCreate()æ–¹æ³•ä¸­è°ƒç”¨\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e/**\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e     * è‡ªå®šä¹‰licenseçš„æ–‡ä»¶è·¯å¾„å’Œæ–‡ä»¶åç§°ï¼Œä»¥licenseæ–‡ä»¶æ–¹å¼åˆå§‹åŒ–\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cm\"\u003e     */\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003einitAccessTokenLicenseFile\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eOCR\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetInstance\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emActivity\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetApplicationContext\u003c/span\u003e\u003cspan class=\"p\"\u003e()).\u003c/span\u003e\u003cspan class=\"na\"\u003einitAccessToken\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eOnResultListener\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eAccessToken\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Override\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eonResult\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eAccessToken\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eaccessToken\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e                \u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eaccessToken\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetAccessToken\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e                \u003c/span\u003e\u003cspan class=\"n\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ed\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eTAG\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e                \u003c/span\u003e\u003cspan class=\"n\"\u003ehasGotToken\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"nd\"\u003e@Override\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eonError\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eOCRError\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eerror\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e                \u003c/span\u003e\u003cspan class=\"n\"\u003eerror\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eprintStackTrace\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e                \u003c/span\u003e\u003cspan class=\"n\"\u003ealertText\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;è‡ªå®šä¹‰æ–‡ä»¶è·¯å¾„licenceæ–¹å¼è·å–tokenå¤±è´¥\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eerror\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetMessage\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e            \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"p\"\u003e},\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;aip.license\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003emActivity\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetApplicationContext\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg loading=\"lazy\" src=\"https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/5/10/16aa0c33cd0b0b3a~tplv-t2oaga2asx-image.image\"\u003e\u003c/p\u003e","title":"è®°ä¸€æ¬¡åœ¨Androidä¸­è°ƒç”¨ç™¾åº¦çš„OCRæ¥å£çš„ç»å†"},{"content":"(1),Androidæ¶ˆæ¯æœºåˆ¶æ¦‚è¿° Androidä¸­çš„æ¶ˆæ¯æœºåˆ¶ä¸»è¦æŒ‡ Handlerçš„è¿è¡Œæœºåˆ¶ ä»¥åŠ MessageQueueï¼ŒLooperçš„å·¥ä½œè¿‡ç¨‹ ï¼Œä¸‰è€…ç›¸äº’åä½œï¼Œä¿è¯ç€æ¶ˆæ¯çš„æ¥æ”¶ï¼Œå‘é€ï¼Œå¤„ç†ï¼Œæ‰§è¡Œã€‚\nâ€‹ å›¾ç‰‡æ¥è‡ªéƒ­ç¥çš„ã€Šç¬¬ä¸€è¡Œä»£ç ã€‹\nå…ˆç®€å•çš„ä»‹ç»ä¸€ä¸‹ Android ä¸­ æ¶ˆæ¯æœºåˆ¶å¤§å®¶åº­çš„ä¸»è¦æˆå‘˜ :\nHandler : æ˜¯Androidæ¶ˆæ¯æœºåˆ¶çš„ä¸Šå±‚æ¥å£ï¼Œæœ€ä¸ºå¤§å®¶å¸¸ç”¨ï¼Œç›¸å½“äºAndroidæ¶ˆæ¯æœºåˆ¶çš„å…¥å£ï¼Œæˆ‘ä»¬é€šè¿‡ä½¿ç”¨Handlerå‘é€æ¶ˆæ¯æ¥å¼•èµ·æ¶ˆæ¯æœºåˆ¶çš„å¾ªç¯ã€‚é€šå¸¸ç”¨äº:åœ¨å­çº¿ç¨‹æ‰§è¡Œå®Œè€—æ—¶ä»»åŠ¡å®Œåï¼Œæ›´æ–°UIã€‚\nMessageQueue : å­˜å‚¨ æ¶ˆæ¯(Message) å¯¹è±¡çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®åˆ™æ˜¯å•é“¾è¡¨ç»“æ„.\nLooper : ç”¨äºæ— é™çš„ä» MessageQueueä¸­å–å‡ºæ¶ˆæ¯ï¼Œç›¸å½“äºæ¶ˆæ¯çš„æ°¸åŠ¨æœºï¼Œå¦‚æœæœ‰æ–°çš„æ¶ˆæ¯ï¼Œåˆ™å¤„ç†æ‰§è¡Œï¼Œè‹¥æ²¡æœ‰ï¼Œåˆ™å°±ä¸€ç›´ç­‰å¾…ï¼Œå µå¡ã€‚Looper** æ‰€åœ¨çš„çº¿ç¨‹æ˜¯ åˆ›å»º Handler æ—¶æ‰€åœ¨çš„çº¿ç¨‹ã€‚\nä¸»çº¿ç¨‹åˆ›å»ºHandleræ—¶ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªLooper,ä½†æ˜¯å­çº¿ç¨‹å¹¶ä¸ä¼šè‡ªåŠ¨åˆ›å»ºLooper\nThreadLocal : åœ¨æ¯ä¸ªçº¿ç¨‹äº’ä¸å¹²æ‰°çš„å­˜å‚¨ï¼Œæä¾›æ•°æ®ï¼Œä»¥æ­¤æ¥è·å–å½“å‰çº¿ç¨‹çš„Looper\nActivityThread : Android çš„ä¸»çº¿ç¨‹ï¼Œä¹Ÿå«UIçº¿ç¨‹ï¼Œä¸»çº¿ç¨‹è¢«åˆ›å»ºæ—¶ è‡ªåŠ¨åˆå§‹åŒ–ä¸»çº¿ç¨‹çš„ Looperå¯¹è±¡ã€‚\né—®é¢˜ : å¤§å®¶éƒ½çŸ¥é“åªæœ‰åœ¨UIçº¿ç¨‹æ‰èƒ½å¯¹UIå…ƒç´ è¿›è¡Œæ“ä½œï¼Œåœ¨å­çº¿ç¨‹æ›´æ”¹UIå°±ä¼šæŠ¥é”™ï¼Œä¸ºä»€ä¹ˆï¼Ÿ çœ‹å®Œã€ŠAndroidè‰ºæœ¯å¼€å‘æ¢ç´¢ã€‹ è¿™æœ¬ä¹¦çš„ç¬¬10ç« ä¹‹åæˆ‘ä¹Ÿæ‰æ˜ç™½\nAndroidä¸­çš„UIæ§ä»¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¦‚æœåœ¨å­çº¿ç¨‹ä¸­ä¹Ÿèƒ½ä¿®æ”¹UIå…ƒç´ ï¼Œé‚£å¤šçº¿ç¨‹çš„æ—¶ï¼Œå…±åŒè®¿é—®åŒä¸€ä¸ªUIå…ƒç´ ï¼Œå°±ä¼šå¯¼è‡´è¿™ä¸ªUIå…ƒç´ å¤„äºæˆ‘ä»¬ä¸å¯é¢„çŸ¥çš„çŠ¶æ€ï¼Œè¿™ä¸ªçº¿ç¨‹è®©å®ƒå¾€å·¦ä¸€ç‚¹ï¼Œé‚£ä¸ªçº¿ç¨‹è®©å®ƒå¾€å³ä¸€ç‚¹ï¼ŒUIè¯¥å¬è°çš„ï¼Œå¥½tmä¹±ã€‚ã€‚ å¹²è„†æˆ‘å°±åªå¬ä¸»çº¿ç¨‹çš„æŠŠã€‚ é—®é¢˜ : é‚£ä¸ºä»€ä¹ˆä¸é€šè¿‡å¯¹è®¿é—®UIæ§ä»¶çš„å­çº¿ç¨‹åŠ ä¸Šé”æœºåˆ¶å‘¢ ï¼Ÿ è¿™ä¸ªå¾ˆç®€å•äº†ï¼Œå¦‚æœä¸ºä¸åŒçš„çº¿ç¨‹è®¿é—®åŒä¸€UIå…ƒç´ åŠ ä¸Šé”æœºåˆ¶ï¼Œé‚£æˆ‘ä»¬ç¨‹åºå‘˜å†™ç›¸å…³ä»£ç çš„æ—¶å€™ä¼šå˜å¾—è¶…çº§éº»çƒ¦ã€‚ã€‚ã€‚ æ”¹ä¸ªUIè¿˜å¾—è€ƒè™‘å®ƒæ˜¯ä¸æ˜¯å·²ç»è¢«åˆ«çš„çº¿ç¨‹å ç”¨äº†ï¼Œè¢«å ç”¨äº†ï¼Œè¿˜å¾—è®©é‚£ä¸ªçº¿ç¨‹é‡Šæ”¾é”ã€‚ã€‚ã€‚çº¿ç¨‹å†å¤šä¸€ç‚¹çš„è¯ï¼Œå¤§å¤§åœ°åŠ å¤§äº†ç¨‹åºå‘˜åœ°å·¥ä½œé‡.\nè€Œä¸”åŠ ä¸Šé”æœºåˆ¶æ— ç–‘ä¼šç”±äºçº¿ç¨‹å µå¡åœ°åŸå› é™ä½è®¿é—®UIçš„æ•ˆç‡ï¼Œå¸§ç‡é™ä½ï¼Œä½“éªŒä¹Ÿä¼šä¸å‹å¥½ã€‚\nè®©UIå…ƒç´ åªèƒ½å†ä¸»çº¿ç¨‹è®¿é—®å°±ä¼šçœä¸‹å¾ˆå¤šäº‹ï¼Œåˆ›å»ºä¸€ä¸ªHandlerå°±è¡Œäº†ã€‚\nä¸‹é¢ä»æ•´ä½“æ¦‚è¿°ä¸€ä¸‹ æ¶ˆæ¯æœºåˆ¶çš„æ•´ä¸ªå·¥ä½œè¿‡ç¨‹ :\nHandler åˆ›å»ºæ—¶ä¼šé‡‡ç”¨å½“å‰çº¿ç¨‹çš„ Looperæ¥æ„å»ºå†…éƒ¨çš„æ¶ˆæ¯å¾ªç¯ç³»ç»Ÿï¼Œå¦‚æœHandleråœ¨å­çº¿ç¨‹ï¼Œåˆ™ä¸€å¼€å§‹æ˜¯æ²¡æœ‰Looperå¯¹è±¡çš„(è§£å†³æ–¹æ³•ç¨åä»‹ç»)ï¼Œä¸»çº¿ç¨‹ActivityThreadé»˜è®¤æœ‰ä¸€ä¸ªLooperã€‚\nHandleråˆ›å»ºå®Œæ¯•ï¼Œé€šè¿‡ postæ–¹æ³•ä¼ å…¥Runnableå¯¹è±¡ï¼Œæˆ–è€…é€šè¿‡sendMessage(Message msg)å‘é€æ¶ˆæ¯ã€‚\npost()æ–¹æ³•é‡Œä¹Ÿæ˜¯é€šè¿‡è°ƒç”¨send()å®ç°çš„\nsend()æ–¹æ³•è¢«è°ƒç”¨åï¼Œè°ƒç”¨ MessageQueueçš„enqueueMessage()æ–¹æ³•å°†æ¶ˆæ¯å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…è¢«å¤„ç†ã€‚\nLooperå¯¹è±¡è¿è¡Œåœ¨Handleræ‰€åœ¨çš„çº¿ç¨‹ï¼Œä»MessageQueueæ¶ˆæ¯é˜Ÿåˆ—ä¸­ä¸æ–­åœ°å–å‡ºæ¶ˆæ¯ï¼Œå¤„ç†ï¼Œæ‰€ä»¥ä¸šåŠ¡é€»è¾‘(é€šå¸¸æ˜¯æ›´æ–°UI)å°±è¿è¡Œåœ¨Looperçš„çº¿ç¨‹ä¸­ã€‚\næ¥ä¸‹æ¥ä»å±€éƒ¨æ¥åˆ†ææ¶ˆæ¯æœºåˆ¶çš„æ¯ä¸ªæˆå‘˜ã€‚\n(2),ThreadLocal å·¥ä½œåŸç† 1, ä»€ä¹ˆæ˜¯ThreadLocalï¼Ÿ ThreadLocalæ˜¯ä¸€ä¸ªçº¿ç¨‹å†…éƒ¨çš„æ•°æ®å­˜å‚¨ç±»ï¼Œé€šè¿‡å®ƒå¯ä»¥åœ¨æŒ‡å®šçš„çº¿ç¨‹ä¸­è·å¾—å­˜å‚¨æ•°æ®ï¼Œè·å¾—æ•°æ®ï¼Œçº¿ç¨‹ä¹‹é—´çš„ThreadLocalç›¸äº’ç‹¬ç«‹ï¼Œä¸”æ— æ³•è·å¾—å¦ä¸€ä¸ªçº¿ç¨‹çš„TheadLocal.\nç›¸å¯¹æ•´ä¸ªç¨‹åºæ¥è¯´ï¼Œæ¯ä¸ªçº¿ç¨‹çš„ThreadLocalæ˜¯å±€éƒ¨å˜é‡ã€‚\nç›¸å¯¹ä¸€ä¸ªçº¿ç¨‹æ¥è¯´ï¼Œçº¿ç¨‹å†…çš„ThreadLocalæ˜¯çº¿ç¨‹çš„å…¨å±€å˜é‡\nThreadLocalæ˜¯ä¸€ä¸ªæ³›å‹ç±»ï¼Œå¯ä»¥å­˜å‚¨ä»»æ„ç±»å‹çš„å¯¹è±¡ã€‚\nç¤ºä¾‹:\npublic class ThreadLocalTest { public static void main(String[] args) { ThreadLocal\u0026lt;Boolean\u0026gt; mThreadLocal = new ThreadLocal\u0026lt;Boolean\u0026gt;(); mThreadLocal.set(true); System.out.println(\u0026#34;#Main Thread : ThreadLocal \u0026#34; + mThreadLocal.get()); new Thread( new Runnable() { @Override public void run() { mThreadLocal.set(false); System.out.println(\u0026#34;#1 Thread : ThreadLocal \u0026#34; + mThreadLocal.get()); } }).start(); new Thread( new Runnable() { @Override public void run() { System.out.println(\u0026#34;#2 Thread : ThreadLocal \u0026#34; + mThreadLocal.get()); } }).start(); } } æˆ‘ä»¬åœ¨ä¸»çº¿ç¨‹åˆ›å»ºä¸€ä¸ª æ³›å‹ä¸ºBooleançš„ThreadLocalï¼Œå¹¶.set(True),ç„¶ååœ¨ç¬¬ä¸€ä¸ªå­çº¿ç¨‹ä¸­.set(False)ï¼Œåœ¨ç¬¬äºŒä¸ªå­çº¿ç¨‹ä¸­ä¸åšä¿®æ”¹ï¼Œç›´æ¥æ‰“å°ã€‚ å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ä¸åŒçš„çº¿ç¨‹ä¸­è·å¾—çš„å€¼ä¹Ÿä¸åŒã€‚\nè¾“å‡º :\n#Main Thread : ThreadLocal true #1 Thread : ThreadLocal false #2 Thread : ThreadLocal null 2ï¼ŒThreadLocalçš„å®ç°åŸç† é¦–å…ˆæ¯ä¸ªçº¿ç¨‹å†…éƒ¨éƒ½ç»´æŠ¤ç€ä¸€ä¸ªThreadLocalMapå¯¹è±¡\nThread.Java\n/* ThreadLocal values pertaining to this thread. This map is maintained * by the ThreadLocal class. */ ThreadLocal.ThreadLocalMap threadLocals = null; è¿™ä¸ªThraedLocalMap ä¸Mapç±»ä¼¼ï¼Œä¸€ä¸ªçº¿ç¨‹å†…å¯ä»¥æœ‰å¤šä¸ªThreadLocalç±»å‹å˜é‡ï¼Œæ‰€ä»¥é€šè¿‡ThreadLocalMap \u0026lt;ThreadLocal\u0026lt;?\u0026gt; key, Object value\u0026gt;.ä¿å­˜ç€å¤šä¸ª\u0026lt;ThreadLocal , ä»»æ„ç±»å‹å¯¹è±¡\u0026gt;é”®å€¼å¯¹ã€‚\nçœ‹ä¸€ä¸‹ThreadLocalçš„set()æ–¹æ³•å®ç° :\n/** * Sets the current thread\u0026#39;s copy of this thread-local variable * to the specified value. Most subclasses will have no need to * override this method, relying solely on the {@link #initialValue} * method to set the values of thread-locals. * * @param value the value to be stored in the current thread\u0026#39;s copy of * this thread-local. */ public void set(T value) { Thread t = Thread.currentThread(); ThreadLocalMap map = getMap(t); if (map != null) map.set(this, value); else createMap(t, value); } å…ˆæ˜¯è·å¾—å½“å‰çº¿ç¨‹çš„ThreadLocalMapå¯¹è±¡ï¼Œmap.set(this,value) è®¾ç½®äº†æˆ‘è¿™ä¸ªThreadLocalå­˜å‚¨çš„å€¼.\nget()æ–¹æ³•å®ç° :\n/** * Returns the value in the current thread\u0026#39;s copy of this * thread-local variable. If the variable has no value for the * current thread, it is first initialized to the value returned * by an invocation of the {@link #initialValue} method. * * @return the current thread\u0026#39;s value of this thread-local */ public T get() { Thread t = Thread.currentThread();//è·å¾—å½“å‰çº¿ç¨‹ ThreadLocalMap map = getMap(t);//æ ¹æ®æ ¹æ®è·å¾—å®ƒçš„ThreadLocalMap if (map != null) { ThreadLocalMap.Entry e = map.getEntry(this);//è·å¾—\u0026lt;k,v\u0026gt;é”®å€¼å¯¹ if (e != null) { @SuppressWarnings(\u0026#34;unchecked\u0026#34;) T result = (T)e.value;//é€šè¿‡\u0026lt;k,v\u0026gt;è·å¾—å€¼ return result; } } return setInitialValue(); } 3ï¼ŒThreadLocalçš„ä½¿ç”¨åœºæ™¯ ä¸€èˆ¬ï¼Œå½“æŸäº›æ•°æ®æ˜¯ä»¥çº¿ç¨‹ä¸ºä½œç”¨åŸŸï¼Œå¹¶ä¸”ä¸åŒçš„çº¿ç¨‹å…·æœ‰ä¸åŒçš„æ•°æ®å‰¯æœ¬æ—¶ï¼Œå¯ä»¥è€ƒè™‘ç”¨ThreadLocal\nåœºæ™¯1: å¯¹äºHandler,å®ƒæƒ³è¦è·å¾—å½“å‰çº¿ç¨‹çš„Looperï¼Œå¹¶ä¸”Looperçš„ä½œç”¨åŸŸå°±æ˜¯å½“å‰çš„çº¿ç¨‹ï¼Œä¸åŒçš„çº¿ç¨‹å…·æœ‰ä¸åŒçš„Looperå¯¹è±¡ï¼Œè¿™æ—¶å¯ä»¥ä½¿ç”¨ThreadLocalã€‚\nåœºæ™¯2: å¤æ‚é€»è¾‘ä¸‹çš„å¯¹è±¡çš„ä¼ é€’ï¼Œå¦‚æœæƒ³è¦ä¸€ä¸ªå¯¹è±¡è´¯ç©¿ç€æ•´ä¸ªçº¿ç¨‹çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œå¯é‡‡ç”¨Threadlocalè®©æ­¤å¯¹è±¡ä½œä¸ºè¯¥çº¿ç¨‹çš„å…¨å±€å¯¹è±¡ã€‚\n(3),MessageQueueçš„å·¥ä½œåŸç† ä»¥å•é“¾è¡¨çš„å½¢å¼ï¼Œå­˜å‚¨ç€Handlerå‘é€è¿‡æ¥çš„æ¶ˆæ¯ï¼Œå†æ¥ä¸€å¼ å›¾åŠ æ·±å°è±¡\nä¸»è¦åŒ…å«ä¸¤ä¸ªæ“ä½œ:\né€šè¿‡enqueueMessage(Message msg,long when)ï¼Œåƒé˜Ÿåˆ—æ’å…¥ä¸€ä¸ªæ¶ˆæ¯,è¿™é‡Œä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œå°±ä¸ä¸Šæºç ï¼Œè´´ä¸Šæºç è¿æ¥,MessageQueue.enqueueMessage() é€šè¿‡next()ä»æ— é™å¾ªç¯é˜Ÿåˆ—ä¸­å–å‡ºæ¶ˆæ¯ï¼Œå¹¶ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­åˆ é™¤ã€‚MessageQueue.next() è™½ç„¶å®ƒå«åšæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä½†å†…éƒ¨å…¶å®æ˜¯ä»¥å•é“¾è¡¨çš„ç»“æ„å­˜å‚¨ï¼Œæœ‰åˆ©äºæ’å…¥ï¼Œåˆ é™¤çš„æ“ä½œã€‚\n(4),Looperçš„å·¥ä½œåŸç† å®ƒçš„ä¸»è¦ä½œç”¨å°±æ˜¯ ä¸åœåœ°ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­ æŸ¥çœ‹æ˜¯å¦æœ‰æ–°çš„æ¶ˆæ¯ï¼Œå¦‚æœæœ‰æ–°çš„æ¶ˆæ¯å°±ä¼šç«‹åˆ»å¤„ç†ï¼Œæ²¡æœ‰æ¶ˆæ¯å°±ä¼šå µå¡ã€‚\næŒæœ‰MessageQueueçš„å¼•ç”¨ï¼Œå¹¶ä¸”ä¼šåœ¨æ„é€ æ–¹æ³•ä¸­åˆå§‹åŒ–\nprivate Looper(boolean quitAllowed) { mQueue = new MessageQueue(quitAllowed); mThread = Thread.currentThread(); } é—®é¢˜: å¦‚ä½•åœ¨å­çº¿ç¨‹åˆ›å»ºå®ƒçš„Looperå¯¹è±¡ ? å‰é¢è¯´åˆ°ä¸»çº¿ç¨‹è‡ªå·±ä¼šåˆ›å»ºä¸€ä¸ªLooperå¯¹è±¡ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ä¸»çº¿ç¨‹ä½¿ç”¨Handlerçš„æ—¶å€™ç›´æ¥åˆ›å»ºå°±å¯ä»¥äº†ã€‚\nä½†æ˜¯åœ¨å­çº¿ç¨‹ä½¿ç”¨Handlerçš„è¯ï¼Œå°±éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨åˆ›å»ºLooperäº†ï¼Œ\nç¤ºä¾‹:\nnew Thread() { @Override public void run() { Looper.prepare(); Handler handler = new Handler(); Looper.loop(); } }.start(); prepare()æºç å¦‚ä¸‹:\n/** Initialize the current thread as a looper. 77 * This gives you a chance to create handlers that then reference 78 * this looper, before actually starting the loop. Be sure to call 79 * {@link #loop()} after calling this method, and end it by calling 80 * {@link #quit()}. 81 */ 82 public static void prepare() { 83 prepare(true); 84 } 85 86 private static void prepare(boolean quitAllowed) { 87 if (sThreadLocal.get() != null) { 88 throw new RuntimeException(\u0026#34;Only one Looper may be created per thread\u0026#34;); 89 } 90 sThreadLocal.set(new Looper(quitAllowed)); 91 } å¯ä»¥çœ‹åˆ°æœ€ç»ˆæ˜¯è°ƒç”¨äº† æ­¤ Looper æ‰€åœ¨çº¿ç¨‹çš„ **ThreadLocal.set()**æ–¹æ³•ï¼Œå­˜äº†ä¸€ä¸ªLooperå¯¹è±¡è¿›å»ã€‚\né™¤äº†prepare()ï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–æ–¹æ³•ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦çŸ¥é“\nloop() : å¯åŠ¨æ¶ˆæ¯å¾ªç¯ï¼Œï¼Œåªæœ‰å½“Looperè°ƒç”¨äº†loop()ä¹‹åï¼Œæ•´ä¸ªæ¶ˆæ¯å¾ªç¯æ‰æ´»äº†èµ·æ¥\nprepareMainLooper() : ç»™ä¸»çº¿ç¨‹åˆ›å»ºLooperå¯¹è±¡\ngetMainLooper() : è·å¾—ä¸»çº¿ç¨‹çš„Looperå¯¹è±¡\nquit() : é€šçŸ¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç›´æ¥é€€å‡ºæ¶ˆæ¯å¾ªç¯ï¼Œä¸ç­‰å¾…å½“å‰æ­£åœ¨å¤„ç†çš„æ¶ˆæ¯æ‰§è¡Œå®Œï¼Œquitä¹‹åï¼Œå†å‘æ¶ˆæ¯é˜Ÿåˆ—ä¸­å‘é€æ–°çš„æ¶ˆæ¯å°±ä¼šå¤±è´¥( Handlerçš„send()æ–¹æ³•å°±ä¼šè¿”å›false )\npublic void quit() { mQueue.quit(false); } quitSafety() : é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¸å†æ¥æ”¶æ–°çš„æ¶ˆæ¯ï¼Œç­‰å½“å‰çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯å¤„ç†å®Œå°±é€€å‡ºã€‚\npublic void quitSafely() { mQueue.quit(true); } ä¸‹é¢åˆ†æloop()çš„å®ç°:\n/** 119 * Run the message queue in this thread. Be sure to call 120 * {@link #quit()} to end the loop. 121 */ 122 public static void loop() { 123 final Looper me = myLooper(); 124 if (me == null) { 125 throw new RuntimeException(\u0026#34;No Looper; Looper.prepare() wasn\u0026#39;t called on this thread.\u0026#34;); 126 } 127 final MessageQueue queue = me.mQueue; 128 129 ...//çœç•¥éƒ¨åˆ†ä»£ç  133\t//ä»è¿™é‡Œå¼€å¯æ— é™å¾ªç¯ï¼Œç›´åˆ° æ²¡æœ‰æ¶ˆæ¯ 134 for (;;) { 135 Message msg = queue.next(); // might block 136 if (msg == null) { 137 // No message indicates that the message queue is quitting. 138 return; 139 } 140 141 // This must be in a local variable, in case a UI event sets the logger 142 Printer logging = me.mLogging; 143 if (logging != null) { 144 logging.println(\u0026#34;\u0026gt;\u0026gt;\u0026gt;\u0026gt;\u0026gt; Dispatching to \u0026#34; + msg.target + \u0026#34; \u0026#34; + 145 msg.callback + \u0026#34;: \u0026#34; + msg.what); 146 } 147 148 msg.target.dispatchMessage(msg); 149\t...//çœç•¥éƒ¨åˆ†ä»£ç  166 } 167 } åœ¨ for å¾ªç¯é‡Œ :\né€šè¿‡queue.next()ä¸€ç›´è¯»å–æ–°çš„æ¶ˆæ¯ï¼Œå¦‚æœæ²¡æœ‰æ¶ˆæ¯ åˆ™é€€å‡ºå¾ªç¯ã€‚ æ¥ä¸‹æ¥ï¼Œ msg.target.dispatchMessage(msg);ï¼Œtargetæ˜¯å‘é€æ­¤æ¶ˆæ¯çš„ Handerå¯¹åƒï¼Œé€šçŸ¥Handlerè°ƒç”¨dispatchMessage()æ¥æ¥æ”¶æ¶ˆæ¯ã€‚ (5),Handlerçš„å·¥ä½œåŸç† Handlerçš„ä¸»è¦å·¥ä½œå°±æ˜¯ å‘é€æ¶ˆæ¯ï¼Œæ¥æ”¶æ¶ˆæ¯ã€‚\nå‘é€æ¶ˆæ¯çš„æ–¹å¼æœ‰post(),send(),ä¸è¿‡post()æ–¹æ³•æœ€åè¿˜æ˜¯è°ƒç”¨çš„send()æ–¹æ³•\nå‘é€æ¶ˆæ¯çš„è¿‡ç¨‹:\nsendç±»å‹çš„å‘é€æ¶ˆæ¯æ–¹æ³•æœ‰å¾ˆå¤šï¼Œå¹¶ä¸”æ˜¯åµŒå¥—çš„\nsendMessage()\npublic final boolean sendMessage(Message msg) { return sendMessageDelayed(msg, 0); } sendMessageDelayed()\npublic final boolean sendMessageDelayed(Message msg, long delayMillis) { if (delayMillis \u0026lt; 0) { delayMillis = 0; } return sendMessageAtTime(msg, SystemClock.uptimeMillis() + delayMillis); } sendMessageAtTime()\npublic boolean sendMessageAtTime(Message msg, long uptimeMillis) { MessageQueue queue = mQueue; if (queue == null) { RuntimeException e = new RuntimeException( this + \u0026#34; sendMessageAtTime() called with no mQueue\u0026#34;); Log.w(\u0026#34;Looper\u0026#34;, e.getMessage(), e); return false; } return enqueueMessage(queue, msg, uptimeMillis); } ä¸‰ç§sendçš„å‘é€æ¶ˆæ¯æ–¹å¼ï¼Œæœ€åéƒ½ä¼šé€šè¿‡enqueueMessage()æ¥é€šçŸ¥æ¶ˆæ¯é˜Ÿåˆ— æ’å…¥è¿™æ¡æ–°çš„æ¶ˆæ¯ã€‚\nHandler.enqueueMessage\nprivate boolean enqueueMessage(MessageQueue queue, Message msg, long uptimeMillis) { msg.target = this; if (mAsynchronous) { msg.setAsynchronous(true); } return queue.enqueueMessage(msg, uptimeMillis);//è°ƒç”¨æ¶ˆæ¯é˜Ÿåˆ—çš„enqueueMessage() } æ¥æ”¶æ¶ˆæ¯çš„è¿‡ç¨‹\næ¥æ”¶æ¶ˆæ¯ç”±dispatchMessage(Message msg)ä¸ºå…¥å£\ndispatchMessage()\npublic void dispatchMessage(Message msg) { if (msg.callback != null) { handleCallback(msg); } else { if (mCallback != null) { if (mCallback.handleMessage(msg)) { return; } } handleMessage(msg); } } è¿™é‡Œçš„callbackæ˜¯æˆ‘ä»¬è°ƒç”¨ post(Runnable runnalbe) æ—¶ä¼ å…¥çš„Runnableå¯¹è±¡ï¼Œå¦‚æœæˆ‘ä»¬ä¼ å…¥äº†Runnableå¯¹è±¡\nå°±ä¼šæ‰§è¡ŒRunnableçš„runæ–¹æ³•:\nprivate static void handleCallback(Message message) { message.callback.run(); } å¦‚æœæ²¡æœ‰é€šè¿‡postä¼ Runnableï¼Œå°±ä¼šçœ‹åˆ›å»ºHandleræ—¶çš„æ„é€ æ–¹æ³•ä¸­æœ‰æ²¡æœ‰ä¼ Runnableå‚æ•°ï¼Œä¼ äº†çš„è¯ç”±mCallbackå­˜å‚¨ã€‚\nè¿™ä¸ªmCallbackæ˜¯Handlerå†…éƒ¨çš„ä¸€ä¸ªæ¥å£\npublic interface Callback { public boolean handleMessage(Message msg); } å¦‚æœæ„é€ Handleræ—¶ä¹Ÿæ²¡æœ‰ä¼ Runnableå¯¹è±¡ï¼Œæœ€ç»ˆä¼šæ‰§è¡ŒhandleMessage(msg),è¿™ä¸ª æ–¹æ³•å°±æ˜¯æˆ‘ä»¬åˆ›å»ºhandleræ—¶é‡å†™çš„handleMessage()æ–¹æ³•.\nå‚è€ƒèµ„æ–™: Androidè‰ºæœ¯å¼€å‘æ¢ç´¢\nhttps://www.cnblogs.com/luxiaoxun/p/8744826.html\n(å®Œ~)\n","permalink":"https://chenyongda2018.github.io/posts/android/android%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90/","summary":"\u003ch2 id=\"1androidæ¶ˆæ¯æœºåˆ¶æ¦‚è¿°\"\u003e(1),Androidæ¶ˆæ¯æœºåˆ¶æ¦‚è¿°\u003c/h2\u003e\n\u003cp\u003eAndroidä¸­çš„æ¶ˆæ¯æœºåˆ¶ä¸»è¦æŒ‡ \u003cstrong\u003eHandlerçš„è¿è¡Œæœºåˆ¶\u003c/strong\u003e ä»¥åŠ \u003cstrong\u003eMessageQueueï¼ŒLooperçš„å·¥ä½œè¿‡ç¨‹\u003c/strong\u003e ï¼Œä¸‰è€…ç›¸äº’åä½œï¼Œä¿è¯ç€æ¶ˆæ¯çš„æ¥æ”¶ï¼Œå‘é€ï¼Œå¤„ç†ï¼Œæ‰§è¡Œã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\" \" loading=\"lazy\" src=\"https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/4/28/16a645eb49972a0d~tplv-t2oaga2asx-image.image\"\u003e\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eâ€‹                                                            å›¾ç‰‡æ¥è‡ªéƒ­ç¥çš„ã€Šç¬¬ä¸€è¡Œä»£ç ã€‹\u003c/p\u003e\u003c/blockquote\u003e\n\u003cp\u003eå…ˆç®€å•çš„ä»‹ç»ä¸€ä¸‹ Android ä¸­ æ¶ˆæ¯æœºåˆ¶å¤§å®¶åº­çš„ä¸»è¦æˆå‘˜ :\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eHandler\u003c/strong\u003e : æ˜¯Androidæ¶ˆæ¯æœºåˆ¶çš„ä¸Šå±‚æ¥å£ï¼Œæœ€ä¸ºå¤§å®¶å¸¸ç”¨ï¼Œç›¸å½“äºAndroidæ¶ˆæ¯æœºåˆ¶çš„å…¥å£ï¼Œæˆ‘ä»¬é€šè¿‡ä½¿ç”¨\u003ccode\u003eHandler\u003c/code\u003eå‘é€æ¶ˆæ¯æ¥å¼•èµ·æ¶ˆæ¯æœºåˆ¶çš„å¾ªç¯ã€‚é€šå¸¸ç”¨äº:åœ¨å­çº¿ç¨‹æ‰§è¡Œå®Œè€—æ—¶ä»»åŠ¡å®Œåï¼Œæ›´æ–°UIã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eMessageQueue\u003c/strong\u003e : å­˜å‚¨ \u003cstrong\u003eæ¶ˆæ¯(Message)\u003c/strong\u003e å¯¹è±¡çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®åˆ™æ˜¯å•é“¾è¡¨ç»“æ„.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eLooper\u003c/strong\u003e : ç”¨äºæ— é™çš„ä» \u003ccode\u003eMessageQueue\u003c/code\u003eä¸­å–å‡ºæ¶ˆæ¯ï¼Œç›¸å½“äºæ¶ˆæ¯çš„æ°¸åŠ¨æœºï¼Œå¦‚æœæœ‰æ–°çš„æ¶ˆæ¯ï¼Œåˆ™å¤„ç†æ‰§è¡Œï¼Œè‹¥æ²¡æœ‰ï¼Œåˆ™å°±ä¸€ç›´ç­‰å¾…ï¼Œå µå¡ã€‚Looper** æ‰€åœ¨çš„çº¿ç¨‹æ˜¯ åˆ›å»º \u003ccode\u003eHandler\u003c/code\u003e æ—¶æ‰€åœ¨çš„çº¿ç¨‹ã€‚\u003c/p\u003e\n\u003cp\u003eä¸»çº¿ç¨‹åˆ›å»ºHandleræ—¶ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªLooper,\u003cstrong\u003eä½†æ˜¯å­çº¿ç¨‹å¹¶ä¸ä¼šè‡ªåŠ¨åˆ›å»ºLooper\u003c/strong\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eThreadLocal\u003c/strong\u003e : åœ¨æ¯ä¸ªçº¿ç¨‹äº’ä¸å¹²æ‰°çš„å­˜å‚¨ï¼Œæä¾›æ•°æ®ï¼Œä»¥æ­¤æ¥è·å–å½“å‰çº¿ç¨‹çš„\u003ccode\u003eLooper\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eActivityThread\u003c/strong\u003e : Android çš„ä¸»çº¿ç¨‹ï¼Œä¹Ÿå«UIçº¿ç¨‹ï¼Œä¸»çº¿ç¨‹è¢«åˆ›å»ºæ—¶ è‡ªåŠ¨åˆå§‹åŒ–ä¸»çº¿ç¨‹çš„ \u003ccode\u003eLooper\u003c/code\u003eå¯¹è±¡ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch4 id=\"é—®é¢˜--å¤§å®¶éƒ½çŸ¥é“åªæœ‰åœ¨uiçº¿ç¨‹æ‰èƒ½å¯¹uiå…ƒç´ è¿›è¡Œæ“ä½œåœ¨å­çº¿ç¨‹æ›´æ”¹uiå°±ä¼šæŠ¥é”™ä¸ºä»€ä¹ˆ\"\u003eé—®é¢˜ : å¤§å®¶éƒ½çŸ¥é“åªæœ‰åœ¨UIçº¿ç¨‹æ‰èƒ½å¯¹UIå…ƒç´ è¿›è¡Œæ“ä½œï¼Œåœ¨å­çº¿ç¨‹æ›´æ”¹UIå°±ä¼šæŠ¥é”™ï¼Œä¸ºä»€ä¹ˆï¼Ÿ\u003c/h4\u003e\n\u003cp\u003eçœ‹å®Œ\u003ca href=\"https://book.douban.com/subject/26599538/\"\u003eã€ŠAndroidè‰ºæœ¯å¼€å‘æ¢ç´¢ã€‹\u003c/a\u003e è¿™æœ¬ä¹¦çš„ç¬¬10ç« ä¹‹åæˆ‘ä¹Ÿæ‰æ˜ç™½\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eAndroidä¸­çš„UIæ§ä»¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¦‚æœåœ¨å­çº¿ç¨‹ä¸­ä¹Ÿèƒ½ä¿®æ”¹UIå…ƒç´ ï¼Œé‚£å¤šçº¿ç¨‹çš„æ—¶ï¼Œå…±åŒè®¿é—®åŒä¸€ä¸ªUIå…ƒç´ ï¼Œå°±ä¼šå¯¼è‡´è¿™ä¸ªUIå…ƒç´ å¤„äºæˆ‘ä»¬ä¸å¯é¢„çŸ¥çš„çŠ¶æ€ï¼Œè¿™ä¸ªçº¿ç¨‹è®©å®ƒå¾€å·¦ä¸€ç‚¹ï¼Œé‚£ä¸ªçº¿ç¨‹è®©å®ƒå¾€å³ä¸€ç‚¹ï¼ŒUIè¯¥å¬è°çš„ï¼Œå¥½tmä¹±ã€‚ã€‚ å¹²è„†æˆ‘å°±åªå¬ä¸»çº¿ç¨‹çš„æŠŠã€‚\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch4 id=\"é—®é¢˜--é‚£ä¸ºä»€ä¹ˆä¸é€šè¿‡å¯¹è®¿é—®uiæ§ä»¶çš„å­çº¿ç¨‹åŠ ä¸Šé”æœºåˆ¶å‘¢-\"\u003eé—®é¢˜ : é‚£ä¸ºä»€ä¹ˆä¸é€šè¿‡å¯¹è®¿é—®UIæ§ä»¶çš„å­çº¿ç¨‹åŠ ä¸Šé”æœºåˆ¶å‘¢ ï¼Ÿ\u003c/h4\u003e\n\u003cp\u003eè¿™ä¸ªå¾ˆç®€å•äº†ï¼Œå¦‚æœä¸ºä¸åŒçš„çº¿ç¨‹è®¿é—®åŒä¸€UIå…ƒç´ åŠ ä¸Šé”æœºåˆ¶ï¼Œé‚£æˆ‘ä»¬ç¨‹åºå‘˜å†™ç›¸å…³ä»£ç çš„æ—¶å€™ä¼šå˜å¾—è¶…çº§éº»çƒ¦ã€‚ã€‚ã€‚ æ”¹ä¸ªUIè¿˜å¾—è€ƒè™‘å®ƒæ˜¯ä¸æ˜¯å·²ç»è¢«åˆ«çš„çº¿ç¨‹å ç”¨äº†ï¼Œè¢«å ç”¨äº†ï¼Œè¿˜å¾—è®©é‚£ä¸ªçº¿ç¨‹é‡Šæ”¾é”ã€‚ã€‚ã€‚çº¿ç¨‹å†å¤šä¸€ç‚¹çš„è¯ï¼Œå¤§å¤§åœ°åŠ å¤§äº†ç¨‹åºå‘˜åœ°å·¥ä½œé‡.\u003c/p\u003e\n\u003cp\u003eè€Œä¸”åŠ ä¸Šé”æœºåˆ¶æ— ç–‘ä¼šç”±äºçº¿ç¨‹å µå¡åœ°åŸå› é™ä½è®¿é—®UIçš„æ•ˆç‡ï¼Œå¸§ç‡é™ä½ï¼Œä½“éªŒä¹Ÿä¼šä¸å‹å¥½ã€‚\u003c/p\u003e\n\u003cp\u003eè®©UIå…ƒç´ åªèƒ½å†ä¸»çº¿ç¨‹è®¿é—®å°±ä¼šçœä¸‹å¾ˆå¤šäº‹ï¼Œåˆ›å»ºä¸€ä¸ª\u003ccode\u003eHandler\u003c/code\u003eå°±è¡Œäº†ã€‚\u003c/p\u003e\n\u003cp\u003eä¸‹é¢ä»æ•´ä½“æ¦‚è¿°ä¸€ä¸‹ æ¶ˆæ¯æœºåˆ¶çš„æ•´ä¸ªå·¥ä½œè¿‡ç¨‹ :\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ccode\u003eHandler \u003c/code\u003eåˆ›å»ºæ—¶ä¼šé‡‡ç”¨å½“å‰çº¿ç¨‹çš„ \u003ccode\u003eLooper\u003c/code\u003eæ¥æ„å»ºå†…éƒ¨çš„æ¶ˆæ¯å¾ªç¯ç³»ç»Ÿï¼Œå¦‚æœHandleråœ¨å­çº¿ç¨‹ï¼Œåˆ™ä¸€å¼€å§‹æ˜¯æ²¡æœ‰\u003ccode\u003eLooper\u003c/code\u003eå¯¹è±¡çš„(è§£å†³æ–¹æ³•ç¨åä»‹ç»)ï¼Œä¸»çº¿ç¨‹\u003ccode\u003eActivityThread\u003c/code\u003eé»˜è®¤æœ‰ä¸€ä¸ªLooperã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ccode\u003eHandler\u003c/code\u003eåˆ›å»ºå®Œæ¯•ï¼Œé€šè¿‡ \u003ccode\u003epost\u003c/code\u003eæ–¹æ³•ä¼ å…¥\u003ccode\u003eRunnable\u003c/code\u003eå¯¹è±¡ï¼Œæˆ–è€…é€šè¿‡\u003ccode\u003esendMessage(Message msg)\u003c/code\u003eå‘é€æ¶ˆæ¯ã€‚\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003epost()\u003c/code\u003eæ–¹æ³•é‡Œä¹Ÿæ˜¯é€šè¿‡è°ƒç”¨\u003ccode\u003esend()\u003c/code\u003eå®ç°çš„\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ccode\u003esend()\u003c/code\u003eæ–¹æ³•è¢«è°ƒç”¨åï¼Œè°ƒç”¨ MessageQueueçš„enqueueMessage()æ–¹æ³•å°†æ¶ˆæ¯å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…è¢«å¤„ç†ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ccode\u003eLooper\u003c/code\u003eå¯¹è±¡è¿è¡Œåœ¨\u003ccode\u003eHandler\u003c/code\u003eæ‰€åœ¨çš„çº¿ç¨‹ï¼Œä»\u003ccode\u003eMessageQueueæ¶ˆæ¯é˜Ÿåˆ—\u003c/code\u003eä¸­ä¸æ–­åœ°å–å‡ºæ¶ˆæ¯ï¼Œå¤„ç†ï¼Œæ‰€ä»¥ä¸šåŠ¡é€»è¾‘(é€šå¸¸æ˜¯æ›´æ–°UI)å°±è¿è¡Œåœ¨Looperçš„çº¿ç¨‹ä¸­ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3\u003e\u003c/h3\u003e\n\u003cp\u003eæ¥ä¸‹æ¥ä»å±€éƒ¨æ¥åˆ†ææ¶ˆæ¯æœºåˆ¶çš„æ¯ä¸ªæˆå‘˜ã€‚\u003c/p\u003e","title":"Androidæ¶ˆæ¯æœºåˆ¶å…¨é¢è§£æ"}]