<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>EventBus使用详解及源码解析 | Petrichor's blog</title>
<meta name=keywords content="EventBus,Android"><meta name=description content="EventBus是一个消息订阅/发布的开源框架。

如上图所示 , EventBus框架中主要有2个角色 :

Publisher : 发布消息的, 被观察者
Subscriber : 接收消息的 , 观察者

Publisher(被观察者) 通过 post() 将一个事件/消息(Event) 发送到事件的集中地,也就是图中的 EventBus ，EventBus 再将事件/消息(Event)发给Subcriber观察者。
使用这样的框架，能够使Activity/Fragment等组件之间的通信简化 , 不用再像以前一直使用 intent 来传送数据 , 从而提升开发效率。
1.配置依赖
在app层的 build.gradle 中添加 :
implementation 'org.greenrobot:eventbus:3.1.1'
2.初步使用
根据官方文档 , 首先要定义一个Event(消息)的POJO类 :
public class MessageEvent {

    private  String message ;

    public MessageEvent(String message) {
        this.message = message;
    }


    public String getMessage() {
        return message;
    }

    public void setMessage(String message) {
        this.message = message;
    }
}
然后 , 我们要明确哪个组件是 Subsriber(观察者),  哪个组件是Publisher(被观察者) ,  在这里 , 我们通过EventBus演示一个传送消息的demo。"><meta name=author content="Petrichor"><link rel=canonical href=https://chenyongda2018.github.io/posts/android/eventbus%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.2211ca3164be7830024f6aad2b3a2e520843a64f8f048445c3401c1249aa051d.css integrity="sha256-IhHKMWS+eDACT2qtKzouUghDpk+PBIRFw0AcEkmqBR0=" rel="preload stylesheet" as=style><link rel=icon href=https://chenyongda2018.github.io/newfav.png><link rel=icon type=image/png sizes=16x16 href=https://chenyongda2018.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://chenyongda2018.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://chenyongda2018.github.io/apple-touch-icon.png><link rel=mask-icon href=https://chenyongda2018.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://chenyongda2018.github.io/posts/android/eventbus%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://chenyongda2018.github.io/posts/android/eventbus%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"><meta property="og:site_name" content="Petrichor's blog"><meta property="og:title" content="EventBus使用详解及源码解析"><meta property="og:description" content="EventBus是一个消息订阅/发布的开源框架。
如上图所示 , EventBus框架中主要有2个角色 :
Publisher : 发布消息的, 被观察者 Subscriber : 接收消息的 , 观察者 Publisher(被观察者) 通过 post() 将一个事件/消息(Event) 发送到事件的集中地,也就是图中的 EventBus ，EventBus 再将事件/消息(Event)发给Subcriber观察者。
使用这样的框架，能够使Activity/Fragment等组件之间的通信简化 , 不用再像以前一直使用 intent 来传送数据 , 从而提升开发效率。
1.配置依赖 在app层的 build.gradle 中添加 :
implementation 'org.greenrobot:eventbus:3.1.1' 2.初步使用 根据官方文档 , 首先要定义一个Event(消息)的POJO类 :
public class MessageEvent { private String message ; public MessageEvent(String message) { this.message = message; } public String getMessage() { return message; } public void setMessage(String message) { this.message = message; } } 然后 , 我们要明确哪个组件是 Subsriber(观察者), 哪个组件是Publisher(被观察者) , 在这里 , 我们通过EventBus演示一个传送消息的demo。"><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-01-05T20:29:31+08:00"><meta property="article:modified_time" content="2023-01-05T20:29:31+08:00"><meta property="article:tag" content="EventBus"><meta property="article:tag" content="Android"><meta property="og:image" content="https://chenyongda2018.github.io/images/profile.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://chenyongda2018.github.io/images/profile.jpg"><meta name=twitter:title content="EventBus使用详解及源码解析"><meta name=twitter:description content="EventBus是一个消息订阅/发布的开源框架。

如上图所示 , EventBus框架中主要有2个角色 :

Publisher : 发布消息的, 被观察者
Subscriber : 接收消息的 , 观察者

Publisher(被观察者) 通过 post() 将一个事件/消息(Event) 发送到事件的集中地,也就是图中的 EventBus ，EventBus 再将事件/消息(Event)发给Subcriber观察者。
使用这样的框架，能够使Activity/Fragment等组件之间的通信简化 , 不用再像以前一直使用 intent 来传送数据 , 从而提升开发效率。
1.配置依赖
在app层的 build.gradle 中添加 :
implementation 'org.greenrobot:eventbus:3.1.1'
2.初步使用
根据官方文档 , 首先要定义一个Event(消息)的POJO类 :
public class MessageEvent {

    private  String message ;

    public MessageEvent(String message) {
        this.message = message;
    }


    public String getMessage() {
        return message;
    }

    public void setMessage(String message) {
        this.message = message;
    }
}
然后 , 我们要明确哪个组件是 Subsriber(观察者),  哪个组件是Publisher(被观察者) ,  在这里 , 我们通过EventBus演示一个传送消息的demo。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://chenyongda2018.github.io/posts/"},{"@type":"ListItem","position":2,"name":"EventBus使用详解及源码解析","item":"https://chenyongda2018.github.io/posts/android/eventbus%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"EventBus使用详解及源码解析","name":"EventBus使用详解及源码解析","description":"EventBus是一个消息订阅/发布的开源框架。\n如上图所示 , EventBus框架中主要有2个角色 :\nPublisher : 发布消息的, 被观察者 Subscriber : 接收消息的 , 观察者 Publisher(被观察者) 通过 post() 将一个事件/消息(Event) 发送到事件的集中地,也就是图中的 EventBus ，EventBus 再将事件/消息(Event)发给Subcriber观察者。\n使用这样的框架，能够使Activity/Fragment等组件之间的通信简化 , 不用再像以前一直使用 intent 来传送数据 , 从而提升开发效率。\n1.配置依赖 在app层的 build.gradle 中添加 :\nimplementation \u0026#39;org.greenrobot:eventbus:3.1.1\u0026#39; 2.初步使用 根据官方文档 , 首先要定义一个Event(消息)的POJO类 :\npublic class MessageEvent { private String message ; public MessageEvent(String message) { this.message = message; } public String getMessage() { return message; } public void setMessage(String message) { this.message = message; } } 然后 , 我们要明确哪个组件是 Subsriber(观察者), 哪个组件是Publisher(被观察者) , 在这里 , 我们通过EventBus演示一个传送消息的demo。\n","keywords":["EventBus","Android"],"articleBody":"EventBus是一个消息订阅/发布的开源框架。\n如上图所示 , EventBus框架中主要有2个角色 :\nPublisher : 发布消息的, 被观察者 Subscriber : 接收消息的 , 观察者 Publisher(被观察者) 通过 post() 将一个事件/消息(Event) 发送到事件的集中地,也就是图中的 EventBus ，EventBus 再将事件/消息(Event)发给Subcriber观察者。\n使用这样的框架，能够使Activity/Fragment等组件之间的通信简化 , 不用再像以前一直使用 intent 来传送数据 , 从而提升开发效率。\n1.配置依赖 在app层的 build.gradle 中添加 :\nimplementation 'org.greenrobot:eventbus:3.1.1' 2.初步使用 根据官方文档 , 首先要定义一个Event(消息)的POJO类 :\npublic class MessageEvent { private String message ; public MessageEvent(String message) { this.message = message; } public String getMessage() { return message; } public void setMessage(String message) { this.message = message; } } 然后 , 我们要明确哪个组件是 Subsriber(观察者), 哪个组件是Publisher(被观察者) , 在这里 , 我们通过EventBus演示一个传送消息的demo。\n首先 , 观察者要注册EventBus , 在这里 因为当前活动就是接收消息的,所以当前活动就是 观察者(接收事件的一方) ,\n并且用 @Subscribe 注解定义一个处理接收事件的方法 ， 这里我们简单地把收到的事件内容用Toast弹出。\npublic class ToastActivity extends AppCompatActivity { @Override protected void onCreate(Bundle savedInstanceState) { super.onCreate(savedInstanceState); setContentView(R.layout.activity_toast); //注册 EventBus.getDefault().register(this); } @Override protected void onDestroy() { //解除注册 EventBus.getDefault().unregister(this); super.onDestroy(); } /** * 接收事件 * @param msg */ @Subscribe public void onMessageEvent(Message msg) { Toast.makeText(this, msg.getMessage(), Toast.LENGTH_SHORT).show(); } } 最后 , 我们要实现点击按钮,通过EventBus发送事件 , 所以当前活动也作为被 观察者(发送事件的一方) , 发送消息通过 post() 即可。\npublic class ToastActivity extends AppCompatActivity { EditText mMsgEt; @Override protected void onCreate(Bundle savedInstanceState) { super.onCreate(savedInstanceState); setContentView(R.layout.activity_toast); EventBus.getDefault().register(this); mMsgEt = (EditText) findViewById(R.id.message_et); findViewById(R.id.send_msg_btn).setOnClickListener(new View.OnClickListener() { @Override public void onClick(View v) { //发送事件 EventBus.getDefault().post(new Message(mMsgEt.getText().toString())); } }); } /** * 接收事件 * @param msg */ @Subscribe public void onMessageEvent(Message msg) { Toast.makeText(this, msg.getMessage(), Toast.LENGTH_SHORT).show(); } @Override protected void onDestroy() { EventBus.getDefault().unregister(this); super.onDestroy(); } } 3.ThreadMode 在EventBus中, 我们可以设置观察者处理接收到消息的函数所在的线程。\n1.ThreadMode.POSTING @Subscribe(threadMode = ThreadMode.POSTING) public void onMessage(MessageEvent event) { log(event.message); } 这是eventBus的默认模式 , 接收消息的函数会在发送消息所在的线程中被调用。这种模式下避免了发送事件和处理事件间的线程切换，开销最小。\n但是当发送事件在主线程时，应避免处理事件的函数发生堵塞，否则会引起卡顿。\n2.ThreadMode.MAIN @Subscribe(threadMode = ThreadMode.MAIN) public void onMessage(MessageEvent event) { log(event.message); } 这种模式下处理事件的函数将在主线程中执行 , 所以也应该避免在处理函数中发生堵塞。\n3.ThreadMode.MAIN_ORDERED @Subscribe(threadMode = ThreadMode.MAIN_ORDERED) public void onMessage(MessageEvent event) { log(event.message); } 这种模式下 , 事件的处理函数不仅在主线程 , 当有被观察者发送了多个事件的时候 , 事件将按照发送的顺序依次被处理 , 保证了事件之间的顺序性。\n4.TheadMode.BACKGROUND @Subscribe(threadMode = ThreadMode.BACKGROUND) public void onMessage(MessageEvent event) { log(event.message); } 当发送事件所在线程是子线程 , 则事件也在统一子线程处理。\n当发送事件所在线程是主线车工 , 则eventBus会在后台新开一个线程调用事件处理函数。\n5.ThreadMode.ASYNC @Subscribe(threadMode = ThreadMode.ASYNC) public void onMessage(MessageEvent event) { log(event.message); } 在此模式下 , 事件处理函数始终在与发送事件所在线程之外的子线程中执行 , 也就是两者所在线程相互独立。\n4.粘性事件 普通的事件需要接收方先注册,发送方再发送消息,才能完成消息的发送和处理。\n而粘性事件的作用就是,发送方可以先发送事件 , 接收方在之后进行注册时再完成消息的处理。\n1.简单使用 现在我们做一个注册-\u003e登陆流程的demo ,我们想要实现 :\n用户首先在注册页面填写账号\u0026密码信息 , 再进入登陆页面时, 就不用再重复输入账号密码了。\n效果图 :\n代码 :\n注册页面 :\npublic class RegisterActivity extends AppCompatActivity { EditText mUsernameEditText;//用户名编辑框 EditText mPasswordEditText;//密码编辑框 @Override protected void onCreate(Bundle savedInstanceState) { super.onCreate(savedInstanceState); setContentView(R.layout.activity_register); mUsernameEditText = (EditText) findViewById(R.id.register_username_text_input_layout); mPasswordEditText = (EditText) findViewById(R.id.register_activity_password_et); //点击注册 findViewById(R.id.register_btn).setOnClickListener(new View.OnClickListener() { @Override public void onClick(View v) { String username = mUsernameEditText.getText().toString(); String password = mPasswordEditText.getText().toString(); Toast.makeText(RegisterActivity.this, \"注册成功 , 快去登陆~\", Toast.LENGTH_SHORT).show(); //发送粘性事件 EventBus.getDefault().postSticky(new MessageEvent(username,password)); startActivity(new Intent(RegisterActivity.this, LoginActivity.class)); } }); } } 通过 postSticky() 发送一个粘性事件。\n登陆页面 :\npublic class LoginActivity extends AppCompatActivity { EditText mUsernameEd;//用户名编辑框 EditText mPasswordEd;//密码编辑框 @Override protected void onCreate(Bundle savedInstanceState) { super.onCreate(savedInstanceState); setContentView(R.layout.activity_login); EventBus.getDefault().register(this); mUsernameEd = (EditText)findViewById(R.id.login_username_text_input_layout); mPasswordEd = (EditText)findViewById(R.id.login_password_editText); } //接收粘性事件 , 将注册页面的信息赋值到编辑框中 @Subscribe(sticky = true) public void onEvent(MessageEvent event) { mUsernameEd.setText(event.getUsername()); mPasswordEd.setText(event.getPassword()); } @Override protected void onDestroy() { EventBus.getDefault().unregister(this); super.onDestroy(); } } 2. 获取/移除粘性消息 当我们发送了一个粘性消息 , 但这个消息尚未被订阅者接收处理时 , 我们可以通过 getStickyEvent() 拿到这个消息。\n//获取已经发送的但未处理的粘性消息 MessageEvent stickyEvent = EventBus.getDefault().getStickyEvent(MessageEvent.class); 并且可以通过 removeStickyEvent() 移除这个事件 , 这样之后订阅之注册之后也不会收到这个事件。\n//移除消息 EventBus.getDefault().removeStickyEvent(stickyEvent); 现在试验一下, 我们在前面的demo中进行修改 , 在注册页面点击注册按钮时 , 移除粘性事件。\npublic class RegisterActivity extends AppCompatActivity { ... @Override protected void onCreate(Bundle savedInstanceState) { super.onCreate(savedInstanceState); setContentView(R.layout.activity_register); ... findViewById(R.id.register_btn).setOnClickListener(new View.OnClickListener() { @Override public void onClick(View v) { String username = mUsernameEditText.getText().toString(); String password = mPasswordEditText.getText().toString(); //发送粘性消息 EventBus.getDefault().postSticky(new MessageEvent(username, password)); //获取已经发送的但未处理的粘性消息 MessageEvent stickyEvent = EventBus.getDefault().getStickyEvent(MessageEvent.class); if (stickyEvent != null) { //移除消息 EventBus.getDefault().removeStickyEvent(stickyEvent); } startActivity(new Intent(RegisterActivity.this, LoginActivity.class)); } }); } } 这样 , 在跳转到登陆页面时 , 自动填充用户名\u0026密码的效果就消失了。\n5.源码学习 在看EventBus源码之前 , 要先想清楚我们想要得到什么反馈 , 看源码能弄明白什么问题。\nEventBus是如何实现订阅者在事件到来时执行对应方法的 , 在register(),post()时发生了什么？ EventBus.getDefault().register(this); 1.register() : public void register(Object subscriber) { //1.获得订阅者(Activity,fragment)的Class对象 Class\u003c?\u003e subscriberClass = subscriber.getClass(); //2.根据订阅者的Class对象查找它用@Subcribe注解的方法集合 , 对于SubcriberMethodFinder的类暂时先不用管 List\u003cSubscriberMethod\u003e subscriberMethods = subscriberMethodFinder.findSubscriberMethods(subscriberClass); synchronized (this) { //3.将Class对象与它里面的@Subcribe方法进行注册绑定 for (SubscriberMethod subscriberMethod : subscriberMethods) { subscribe(subscriber, subscriberMethod); } } } register()方法中做了3件事情 :\n获得订阅者(Activity,fragment)的Class对象 根据订阅者的Class对象查找它用@Subcribe注解的方法集合 将Class对象与它里面的@Subcribe方法进行注册绑定 ##subcribe()方法 : 在注释中已经写清楚代码的作用 , 按照顺序阅读应该很容易理解。\n/** * @param subscriber 订阅者(Activity,fragment等组件)的Class对象 * @param subscriberMethod 订阅者中用@Subcribe注解的方法 */ private void subscribe(Object subscriber, SubscriberMethod subscriberMethod) { //1.获得订阅方法所对应的Event类型 Class\u003c?\u003e eventType = subscriberMethod.eventType; //2.将订阅者和订阅方法打包到一个包装类 Subscription newSubscription = new Subscription(subscriber, subscriberMethod); //3.获得这个Event所有的\u003c订阅者,订阅方法\u003e集合，集合中也可能包含参数中订阅者以外的订阅者 CopyOnWriteArrayList\u003cSubscription\u003e subscriptions = subscriptionsByEventType.get(eventType); //4.若\u003c订阅者,订阅方法\u003e集合为空 , 说明接收该Event的若干组件还未调用register() if (subscriptions == null) { subscriptions = new CopyOnWriteArrayList\u003c\u003e(); subscriptionsByEventType.put(eventType, subscriptions); } else { //5.如果这个Event对应的的\u003c订阅者,订阅方法\u003e集合中已经包含了当前这个\u003c订阅者,订阅方法\u003e，则说明当前组件重复调用register()了. if (subscriptions.contains(newSubscription)) { throw new EventBusException(\"Subscriber \" + subscriber.getClass() + \" already registered to event \" + eventType); } } int size = subscriptions.size(); //6.将订阅方法按照优先级大小排序 for (int i = 0; i \u003c= size; i++) { if (i == size || subscriberMethod.priority \u003e subscriptions.get(i).subscriberMethod.priority) { subscriptions.add(i, newSubscription); break; } } //7.获取这个订阅者订阅的所有Event集合 List\u003cClass\u003c?\u003e\u003e subscribedEvents = typesBySubscriber.get(subscriber); if (subscribedEvents == null) { subscribedEvents = new ArrayList\u003c\u003e(); typesBySubscriber.put(subscriber, subscribedEvents); } //8.将当前@Subcribe方法的Event类型添加到这个订阅者的Event集合中 subscribedEvents.add(eventType); //9.如果@Subcribe()方法中sticky = true ,则获得这个粘性事件 //注意如果当前事件是普通事件 , 则不做任何处理。 if (subscriberMethod.sticky) { if (eventInheritance) { Set\u003cMap.Entry\u003cClass\u003c?\u003e, Object\u003e\u003e entries = stickyEvents.entrySet(); for (Map.Entry\u003cClass\u003c?\u003e, Object\u003e entry : entries) { //先获得粘性事件Event的Class对象 Class\u003c?\u003e candidateEventType = entry.getKey(); //找到当前Subscribe()方法订阅的粘性事件 if (eventType.isAssignableFrom(candidateEventType)) { //得到粘性事件 Object stickyEvent = entry.getValue(); checkPostStickyEventToSubscription(newSubscription, stickyEvent); } } } else { Object stickyEvent = stickyEvents.get(eventType); //10.对sticky事件判空,并执行订阅方法 checkPostStickyEventToSubscription(newSubscription, stickyEvent); } } } 看一下第10步的方法 checkPostStickyEventToSubsctiption() :\n/** * 对事件进行判空 * @param newSubscription (订阅者,订阅方法) * @param stickyEvent 粘性事件 */ private void checkPostStickyEventToSubscription(Subscription newSubscription, Object stickyEvent) { if (stickyEvent != null) { // If the subscriber is trying to abort the event, it will fail (event is not tracked in posting state) // --\u003e Strange corner case, which we don't take care of here. postToSubscription(newSubscription, stickyEvent, isMainThread()); } } ##postToSubscription() :\nprivate void postToSubscription(Subscription subscription, Object event, boolean isMainThread) { //根据对应的ThreadMode,在对应的线程中执行 switch (subscription.subscriberMethod.threadMode) { case POSTING: invokeSubscriber(subscription, event); break; case MAIN: if (isMainThread) { invokeSubscriber(subscription, event); } else { mainThreadPoster.enqueue(subscription, event); } break; case MAIN_ORDERED: if (mainThreadPoster != null) { mainThreadPoster.enqueue(subscription, event); } else { // temporary: technically not correct as poster not decoupled from subscriber invokeSubscriber(subscription, event); } break; case BACKGROUND: if (isMainThread) { backgroundPoster.enqueue(subscription, event); } else { invokeSubscriber(subscription, event); } break; case ASYNC: asyncPoster.enqueue(subscription, event); break; default: throw new IllegalStateException(\"Unknown thread mode: \" + subscription.subscriberMethod.threadMode); } } 这个方法根据对应的ThreadMode,在对应的线程中调用 invokeSubcriber() 方法 , 这个方法就是让粘性事件的@Subcriber注解的方法执行的地方 :\n##invokeSubcriber() :\n/** * 通过反射调用订阅者中的@Subcribe方法 * @param subscription * @param event */ void invokeSubscriber(Subscription subscription, Object event) { try { // subscription.subscriberMethod.method.invoke(subscription.subscriber, event); } catch (InvocationTargetException e) { handleSubscriberException(subscription, event, e.getCause()); } catch (IllegalAccessException e) { throw new IllegalStateException(\"Unexpected exception\", e); } } 从以上流程可以看出 订阅者调用了 register() 之后 ,对粘性事件的处理情况 , 流程图如下 :\n那么普通事件是如何处理的呢 ?\n我们看一下 post() 方法做了什么 :\n2.post() /** * Posts the given event to the event bus. */ public void post(Object event) { //获取当前线程的发送状态 PostingThreadState postingState = currentPostingThreadState.get(); //获取当前线程的事件序列 List\u003cObject\u003e eventQueue = postingState.eventQueue; //把事件添加到序列中 eventQueue.add(event); //如果当前线程尚未处于发送状态 if (!postingState.isPosting) { postingState.isMainThread = isMainThread(); //标志当前线程处于发送事件状态 postingState.isPosting = true; //正处于发送状态时是不能取消的 if (postingState.canceled) { throw new EventBusException(\"Internal error. Abort state was not reset\"); } try { //将事件序列中的事件挨个发送 while (!eventQueue.isEmpty()) { postSingleEvent(eventQueue.remove(0), postingState); } } finally { postingState.isPosting = false; postingState.isMainThread = false; } } } EventBus中用ThreadLocal存储了每个线程的发送状态 ,\nprivate final ThreadLocal\u003cPostingThreadState\u003e currentPostingThreadState = new ThreadLocal\u003cPostingThreadState\u003e() { @Override protected PostingThreadState initialValue() { return new PostingThreadState(); } }; ThreadLocal这个类是线程独立的 ， 能够保证每个线程之间的发送状态互不干扰。\n进入最后发送事件的函数 postSingleEvent() :\nprivate void postSingleEvent(Object event, PostingThreadState postingState) throws Error { Class\u003c?\u003e eventClass = event.getClass(); boolean subscriptionFound = false; //是否开启了事件继承 if (eventInheritance) { //寻找当前事件类的素有父类,接口 List\u003cClass\u003c?\u003e\u003e eventTypes = lookupAllEventTypes(eventClass); int countTypes = eventTypes.size(); for (int h = 0; h \u003c countTypes; h++) { Class\u003c?\u003e clazz = eventTypes.get(h); //有多个订阅者时,只要有一个发送成功,则左边为true subscriptionFound |= postSingleEventForEventType(event, postingState, clazz); } } else { //发送单个事件 subscriptionFound = postSingleEventForEventType(event, postingState, eventClass); } //如果当前事件还没有订阅者订阅 if (!subscriptionFound) { if (logNoSubscriberMessages) { logger.log(Level.FINE, \"No subscribers registered for event \" + eventClass); } if (sendNoSubscriberEvent \u0026\u0026 eventClass != NoSubscriberEvent.class \u0026\u0026 eventClass != SubscriberExceptionEvent.class) { //发送一个没有订阅者的事件，这个事件可以由我们来接收 post(new NoSubscriberEvent(this, event)); } } } 进入 postSingleEventForEventType() :\nprivate boolean postSingleEventForEventType(Object event, PostingThreadState postingState, Class\u003c?\u003e eventClass) { CopyOnWriteArrayList\u003cSubscription\u003e subscriptions; //获取订阅了这个事件的\u003c订阅者,订阅方法\u003e列表 synchronized (this) { subscriptions = subscriptionsByEventType.get(eventClass); } //如果这个事件有订阅者 if (subscriptions != null \u0026\u0026 !subscriptions.isEmpty()) { for (Subscription subscription : subscriptions) { postingState.event = event; postingState.subscription = subscription; boolean aborted = false; try { //将事件分发给订阅者 , 在分析register()时分析过。 postToSubscription(subscription, event, postingState.isMainThread); aborted = postingState.canceled; } finally { postingState.event = null; postingState.subscription = null; postingState.canceled = false; } if (aborted) { break; } } return true; } return false; } 可以看到,最后的把事件发送给订阅者的函数 postToSubcription() 与 register() 流程中最后发送粘性事件给订阅者的一样 , 这里就不介绍了。\nprivate void postToSubscription(Subscription subscription, Object event, boolean isMainThread) { //根据对应的ThreadMode,在对应的线程中执行 switch (subscription.subscriberMethod.threadMode) { case POSTING: invokeSubscriber(subscription, event); break; case MAIN: if (isMainThread) { invokeSubscriber(subscription, event); } else { mainThreadPoster.enqueue(subscription, event); } break; case MAIN_ORDERED: if (mainThreadPoster != null) { mainThreadPoster.enqueue(subscription, event); } else { // temporary: technically not correct as poster not decoupled from subscriber invokeSubscriber(subscription, event); } break; case BACKGROUND: if (isMainThread) { backgroundPoster.enqueue(subscription, event); } else { invokeSubscriber(subscription, event); } break; case ASYNC: asyncPoster.enqueue(subscription, event); break; default: throw new IllegalStateException(\"Unknown thread mode: \" + subscription.subscriberMethod.threadMode); } } post() 的总体流程图如下 :\nReferences :\nhttp://greenrobot.org/eventbus/ https://www.jianshu.com/p/f057c460c77e https://github.com/greenrobot/EventBus ","wordCount":"1349","inLanguage":"en","image":"https://chenyongda2018.github.io/images/profile.jpg","datePublished":"2023-01-05T20:29:31+08:00","dateModified":"2023-01-05T20:29:31+08:00","author":{"@type":"Person","name":"Petrichor"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://chenyongda2018.github.io/posts/android/eventbus%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"},"publisher":{"@type":"Organization","name":"Petrichor's blog","logo":{"@type":"ImageObject","url":"https://chenyongda2018.github.io/newfav.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://chenyongda2018.github.io/ accesskey=h title="Home (Alt + H)"><img src=https://chenyongda2018.github.io/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://chenyongda2018.github.io/categories/ title=分类><span>分类</span></a></li><li><a href=https://chenyongda2018.github.io/tags/ title=标签><span>标签</span></a></li><li><a href=https://chenyongda2018.github.io/about/ title=关于><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://chenyongda2018.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://chenyongda2018.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">EventBus使用详解及源码解析</h1><div class=post-meta><span title='2023-01-05 20:29:31 +0800 CST'>January 5, 2023</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;1349 words&nbsp;·&nbsp;Petrichor&nbsp;|&nbsp;<a href=https://github.com/chenyongda2018/chenyongda2018.github.io/tree/main/content/posts/android/EventBus%e4%bd%bf%e7%94%a8%e8%af%a6%e8%a7%a3%e5%8f%8a%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90.md rel="noopener noreferrer edit" target=_blank>Suggest Changes</a></div></header><div class=post-content><p>EventBus是一个消息订阅/发布的开源框架。</p><p><img loading=lazy src=https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/11/15/16e6cfac7adeac21~tplv-t2oaga2asx-image.image></p><p>如上图所示 , EventBus框架中主要有2个角色 :</p><ul><li>Publisher : 发布消息的, 被观察者</li><li>Subscriber : 接收消息的 , 观察者</li></ul><p><code>Publisher(被观察者)</code> 通过 <code>post()</code> 将一个事件/消息(<code>Event</code>) 发送到事件的集中地,也就是图中的 <code>EventBus</code> ，<code>EventBus</code> 再将事件/消息(<code>Event</code>)发给<code>Subcriber</code>观察者。</p><p>使用这样的框架，能够使Activity/Fragment等组件之间的通信简化 , 不用再像以前一直使用 <code>intent</code> 来传送数据 , 从而提升开发效率。</p><h2 id=1配置依赖>1.配置依赖<a hidden class=anchor aria-hidden=true href=#1配置依赖>#</a></h2><p>在app层的 <code>build.gradle</code> 中添加 :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>implementation</span><span class=w> </span><span class=err>&#39;</span><span class=n>org</span><span class=p>.</span><span class=na>greenrobot</span><span class=p>:</span><span class=n>eventbus</span><span class=p>:</span><span class=n>3</span><span class=p>.</span><span class=na>1</span><span class=p>.</span><span class=na>1</span><span class=err>&#39;</span><span class=w>
</span></span></span></code></pre></div><h2 id=2初步使用>2.初步使用<a hidden class=anchor aria-hidden=true href=#2初步使用>#</a></h2><p>根据官方文档 , 首先要定义一个<code>Event(消息)</code>的POJO类 :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MessageEvent</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w>  </span><span class=n>String</span><span class=w> </span><span class=n>message</span><span class=w> </span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>MessageEvent</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>message</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>message</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>message</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>getMessage</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>message</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setMessage</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>message</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>message</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>message</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>然后 , 我们要明确哪个组件是 <code>Subsriber(观察者)</code>, 哪个组件是<code>Publisher(被观察者)</code> , 在这里 , 我们通过EventBus演示一个传送消息的demo。</p><p><img loading=lazy src=https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/11/15/16e6cfabf89f1600~tplv-t2oaga2asx-image.image></p><p>首先 , 观察者要注册EventBus , 在这里 因为当前活动就是接收消息的,所以当前活动就是 <code>观察者(接收事件的一方)</code> ,</p><p>并且用 <code>@Subscribe</code> 注解定义一个处理接收事件的方法 ， 这里我们简单地把收到的事件内容用Toast弹出。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ToastActivity</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>AppCompatActivity</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onCreate</span><span class=p>(</span><span class=n>Bundle</span><span class=w> </span><span class=n>savedInstanceState</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>.</span><span class=na>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setContentView</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=na>layout</span><span class=p>.</span><span class=na>activity_toast</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//注册</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>EventBus</span><span class=p>.</span><span class=na>getDefault</span><span class=p>().</span><span class=na>register</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onDestroy</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//解除注册</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>EventBus</span><span class=p>.</span><span class=na>getDefault</span><span class=p>().</span><span class=na>unregister</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>.</span><span class=na>onDestroy</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 接收事件
</span></span></span><span class=line><span class=cl><span class=cm>     * @param msg
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Subscribe</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onMessageEvent</span><span class=p>(</span><span class=n>Message</span><span class=w> </span><span class=n>msg</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Toast</span><span class=p>.</span><span class=na>makeText</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>msg</span><span class=p>.</span><span class=na>getMessage</span><span class=p>(),</span><span class=w> </span><span class=n>Toast</span><span class=p>.</span><span class=na>LENGTH_SHORT</span><span class=p>).</span><span class=na>show</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>最后 , 我们要实现点击按钮,通过EventBus发送事件 , 所以当前活动也作为被 <code>观察者(发送事件的一方)</code> , 发送消息通过 <code>post()</code> 即可。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ToastActivity</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>AppCompatActivity</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>EditText</span><span class=w> </span><span class=n>mMsgEt</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onCreate</span><span class=p>(</span><span class=n>Bundle</span><span class=w> </span><span class=n>savedInstanceState</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>.</span><span class=na>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setContentView</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=na>layout</span><span class=p>.</span><span class=na>activity_toast</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>EventBus</span><span class=p>.</span><span class=na>getDefault</span><span class=p>().</span><span class=na>register</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mMsgEt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>EditText</span><span class=p>)</span><span class=w> </span><span class=n>findViewById</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=na>id</span><span class=p>.</span><span class=na>message_et</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>findViewById</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=na>id</span><span class=p>.</span><span class=na>send_msg_btn</span><span class=p>).</span><span class=na>setOnClickListener</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>View</span><span class=p>.</span><span class=na>OnClickListener</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onClick</span><span class=p>(</span><span class=n>View</span><span class=w> </span><span class=n>v</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//发送事件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>EventBus</span><span class=p>.</span><span class=na>getDefault</span><span class=p>().</span><span class=na>post</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Message</span><span class=p>(</span><span class=n>mMsgEt</span><span class=p>.</span><span class=na>getText</span><span class=p>().</span><span class=na>toString</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 接收事件
</span></span></span><span class=line><span class=cl><span class=cm>     * @param msg
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Subscribe</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onMessageEvent</span><span class=p>(</span><span class=n>Message</span><span class=w> </span><span class=n>msg</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Toast</span><span class=p>.</span><span class=na>makeText</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>msg</span><span class=p>.</span><span class=na>getMessage</span><span class=p>(),</span><span class=w> </span><span class=n>Toast</span><span class=p>.</span><span class=na>LENGTH_SHORT</span><span class=p>).</span><span class=na>show</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onDestroy</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>EventBus</span><span class=p>.</span><span class=na>getDefault</span><span class=p>().</span><span class=na>unregister</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>.</span><span class=na>onDestroy</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=3threadmode>3.ThreadMode<a hidden class=anchor aria-hidden=true href=#3threadmode>#</a></h2><p>在EventBus中, 我们可以设置观察者处理接收到消息的函数所在的线程。</p><h4 id=1threadmodeposting>1.ThreadMode.POSTING<a hidden class=anchor aria-hidden=true href=#1threadmodeposting>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Subscribe</span><span class=p>(</span><span class=n>threadMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ThreadMode</span><span class=p>.</span><span class=na>POSTING</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onMessage</span><span class=p>(</span><span class=n>MessageEvent</span><span class=w> </span><span class=n>event</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>(</span><span class=n>event</span><span class=p>.</span><span class=na>message</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>这是eventBus的<strong>默认模式</strong> , 接收消息的函数会在发送消息所在的线程中被调用。这种模式下避免了发送事件和处理事件间的线程切换，开销最小。</p><p>但是当发送事件在主线程时，应避免处理事件的函数发生堵塞，否则会引起卡顿。</p><h4 id=2threadmodemain>2.ThreadMode.MAIN<a hidden class=anchor aria-hidden=true href=#2threadmodemain>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Subscribe</span><span class=p>(</span><span class=n>threadMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ThreadMode</span><span class=p>.</span><span class=na>MAIN</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onMessage</span><span class=p>(</span><span class=n>MessageEvent</span><span class=w> </span><span class=n>event</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>(</span><span class=n>event</span><span class=p>.</span><span class=na>message</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>这种模式下处理事件的函数将在主线程中执行 , 所以也应该避免在处理函数中发生堵塞。</p><h4 id=3threadmodemain_ordered>3.ThreadMode.MAIN_ORDERED<a hidden class=anchor aria-hidden=true href=#3threadmodemain_ordered>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Subscribe</span><span class=p>(</span><span class=n>threadMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ThreadMode</span><span class=p>.</span><span class=na>MAIN_ORDERED</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onMessage</span><span class=p>(</span><span class=n>MessageEvent</span><span class=w> </span><span class=n>event</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>(</span><span class=n>event</span><span class=p>.</span><span class=na>message</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>这种模式下 , 事件的处理函数不仅在主线程 , 当有被观察者发送了多个事件的时候 , 事件将按照发送的顺序依次被处理 , 保证了事件之间的顺序性。</p><h4 id=4theadmodebackground>4.TheadMode.BACKGROUND<a hidden class=anchor aria-hidden=true href=#4theadmodebackground>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Subscribe</span><span class=p>(</span><span class=n>threadMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ThreadMode</span><span class=p>.</span><span class=na>BACKGROUND</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onMessage</span><span class=p>(</span><span class=n>MessageEvent</span><span class=w> </span><span class=n>event</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>(</span><span class=n>event</span><span class=p>.</span><span class=na>message</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><ol><li><p>当发送事件所在线程是子线程 , 则事件也在统一子线程处理。</p></li><li><p>当发送事件所在线程是主线车工 , 则eventBus会在后台新开一个线程调用事件处理函数。</p></li></ol><h4 id=5threadmodeasync>5.ThreadMode.ASYNC<a hidden class=anchor aria-hidden=true href=#5threadmodeasync>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Subscribe</span><span class=p>(</span><span class=n>threadMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ThreadMode</span><span class=p>.</span><span class=na>ASYNC</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onMessage</span><span class=p>(</span><span class=n>MessageEvent</span><span class=w> </span><span class=n>event</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>(</span><span class=n>event</span><span class=p>.</span><span class=na>message</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>在此模式下 , 事件处理函数始终在与发送事件所在线程之外的子线程中执行 , 也就是两者所在线程相互独立。</p><h2 id=4粘性事件>4.粘性事件<a hidden class=anchor aria-hidden=true href=#4粘性事件>#</a></h2><p>普通的事件需要接收方先注册,发送方再发送消息,才能完成消息的发送和处理。</p><p>而粘性事件的作用就是,发送方可以先发送事件 , 接收方在之后进行注册时再完成消息的处理。</p><h4 id=1简单使用>1.简单使用<a hidden class=anchor aria-hidden=true href=#1简单使用>#</a></h4><p>现在我们做一个注册->登陆流程的demo ,我们想要实现 :</p><p><strong>用户首先在注册页面填写账号&密码信息 , 再进入登陆页面时, 就不用再重复输入账号密码了</strong>。</p><p>效果图 :</p><p><img loading=lazy src=https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/11/15/16e6cfabf8782ede~tplv-t2oaga2asx-image.image></p><p>代码 :</p><p>注册页面 :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>RegisterActivity</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>AppCompatActivity</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>EditText</span><span class=w> </span><span class=n>mUsernameEditText</span><span class=p>;</span><span class=c1>//用户名编辑框</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>EditText</span><span class=w> </span><span class=n>mPasswordEditText</span><span class=p>;</span><span class=c1>//密码编辑框</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onCreate</span><span class=p>(</span><span class=n>Bundle</span><span class=w> </span><span class=n>savedInstanceState</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>.</span><span class=na>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setContentView</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=na>layout</span><span class=p>.</span><span class=na>activity_register</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mUsernameEditText</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>EditText</span><span class=p>)</span><span class=w> </span><span class=n>findViewById</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=na>id</span><span class=p>.</span><span class=na>register_username_text_input_layout</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mPasswordEditText</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>EditText</span><span class=p>)</span><span class=w> </span><span class=n>findViewById</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=na>id</span><span class=p>.</span><span class=na>register_activity_password_et</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//点击注册</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>findViewById</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=na>id</span><span class=p>.</span><span class=na>register_btn</span><span class=p>).</span><span class=na>setOnClickListener</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>View</span><span class=p>.</span><span class=na>OnClickListener</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onClick</span><span class=p>(</span><span class=n>View</span><span class=w> </span><span class=n>v</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mUsernameEditText</span><span class=p>.</span><span class=na>getText</span><span class=p>().</span><span class=na>toString</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>password</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mPasswordEditText</span><span class=p>.</span><span class=na>getText</span><span class=p>().</span><span class=na>toString</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Toast</span><span class=p>.</span><span class=na>makeText</span><span class=p>(</span><span class=n>RegisterActivity</span><span class=p>.</span><span class=na>this</span><span class=p>,</span><span class=w> </span><span class=s>&#34;注册成功 , 快去登陆~&#34;</span><span class=p>,</span><span class=w> </span><span class=n>Toast</span><span class=p>.</span><span class=na>LENGTH_SHORT</span><span class=p>).</span><span class=na>show</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//发送粘性事件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>EventBus</span><span class=p>.</span><span class=na>getDefault</span><span class=p>().</span><span class=na>postSticky</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>MessageEvent</span><span class=p>(</span><span class=n>username</span><span class=p>,</span><span class=n>password</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>startActivity</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Intent</span><span class=p>(</span><span class=n>RegisterActivity</span><span class=p>.</span><span class=na>this</span><span class=p>,</span><span class=w> </span><span class=n>LoginActivity</span><span class=p>.</span><span class=na>class</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>通过 <code>postSticky()</code> 发送一个粘性事件。</p><p>登陆页面 :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>LoginActivity</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>AppCompatActivity</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>EditText</span><span class=w> </span><span class=n>mUsernameEd</span><span class=p>;</span><span class=c1>//用户名编辑框</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>EditText</span><span class=w> </span><span class=n>mPasswordEd</span><span class=p>;</span><span class=c1>//密码编辑框</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onCreate</span><span class=p>(</span><span class=n>Bundle</span><span class=w> </span><span class=n>savedInstanceState</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>.</span><span class=na>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setContentView</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=na>layout</span><span class=p>.</span><span class=na>activity_login</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>EventBus</span><span class=p>.</span><span class=na>getDefault</span><span class=p>().</span><span class=na>register</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mUsernameEd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>EditText</span><span class=p>)</span><span class=n>findViewById</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=na>id</span><span class=p>.</span><span class=na>login_username_text_input_layout</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mPasswordEd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>EditText</span><span class=p>)</span><span class=n>findViewById</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=na>id</span><span class=p>.</span><span class=na>login_password_editText</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//接收粘性事件 , 将注册页面的信息赋值到编辑框中</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Subscribe</span><span class=p>(</span><span class=n>sticky</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onEvent</span><span class=p>(</span><span class=n>MessageEvent</span><span class=w> </span><span class=n>event</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mUsernameEd</span><span class=p>.</span><span class=na>setText</span><span class=p>(</span><span class=n>event</span><span class=p>.</span><span class=na>getUsername</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mPasswordEd</span><span class=p>.</span><span class=na>setText</span><span class=p>(</span><span class=n>event</span><span class=p>.</span><span class=na>getPassword</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onDestroy</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>EventBus</span><span class=p>.</span><span class=na>getDefault</span><span class=p>().</span><span class=na>unregister</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>.</span><span class=na>onDestroy</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h4 id=2-获取移除粘性消息>2. 获取/移除粘性消息<a hidden class=anchor aria-hidden=true href=#2-获取移除粘性消息>#</a></h4><p>当我们发送了一个粘性消息 , 但这个消息尚未被订阅者接收处理时 , 我们可以通过 <code>getStickyEvent()</code> 拿到这个消息。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//获取已经发送的但未处理的粘性消息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>MessageEvent</span><span class=w> </span><span class=n>stickyEvent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>EventBus</span><span class=p>.</span><span class=na>getDefault</span><span class=p>().</span><span class=na>getStickyEvent</span><span class=p>(</span><span class=n>MessageEvent</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>并且可以通过 <code>removeStickyEvent()</code> 移除这个事件 , 这样之后订阅之注册之后也不会收到这个事件。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//移除消息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>EventBus</span><span class=p>.</span><span class=na>getDefault</span><span class=p>().</span><span class=na>removeStickyEvent</span><span class=p>(</span><span class=n>stickyEvent</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>现在试验一下, 我们在前面的demo中进行修改 , 在注册页面点击注册按钮时 , 移除粘性事件。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>RegisterActivity</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>AppCompatActivity</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onCreate</span><span class=p>(</span><span class=n>Bundle</span><span class=w> </span><span class=n>savedInstanceState</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>.</span><span class=na>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setContentView</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=na>layout</span><span class=p>.</span><span class=na>activity_register</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>findViewById</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=na>id</span><span class=p>.</span><span class=na>register_btn</span><span class=p>).</span><span class=na>setOnClickListener</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>View</span><span class=p>.</span><span class=na>OnClickListener</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onClick</span><span class=p>(</span><span class=n>View</span><span class=w> </span><span class=n>v</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mUsernameEditText</span><span class=p>.</span><span class=na>getText</span><span class=p>().</span><span class=na>toString</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>password</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mPasswordEditText</span><span class=p>.</span><span class=na>getText</span><span class=p>().</span><span class=na>toString</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//发送粘性消息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>EventBus</span><span class=p>.</span><span class=na>getDefault</span><span class=p>().</span><span class=na>postSticky</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>MessageEvent</span><span class=p>(</span><span class=n>username</span><span class=p>,</span><span class=w> </span><span class=n>password</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//获取已经发送的但未处理的粘性消息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>MessageEvent</span><span class=w> </span><span class=n>stickyEvent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>EventBus</span><span class=p>.</span><span class=na>getDefault</span><span class=p>().</span><span class=na>getStickyEvent</span><span class=p>(</span><span class=n>MessageEvent</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>stickyEvent</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//移除消息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>EventBus</span><span class=p>.</span><span class=na>getDefault</span><span class=p>().</span><span class=na>removeStickyEvent</span><span class=p>(</span><span class=n>stickyEvent</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>startActivity</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Intent</span><span class=p>(</span><span class=n>RegisterActivity</span><span class=p>.</span><span class=na>this</span><span class=p>,</span><span class=w> </span><span class=n>LoginActivity</span><span class=p>.</span><span class=na>class</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>这样 , 在跳转到登陆页面时 , 自动填充用户名&密码的效果就消失了。</p><h2 id=5源码学习>5.源码学习<a hidden class=anchor aria-hidden=true href=#5源码学习>#</a></h2><blockquote><p>在看EventBus源码之前 , 要先想清楚我们想要得到什么反馈 , 看源码能弄明白什么问题。</p></blockquote><ul><li>EventBus是如何实现订阅者在事件到来时执行对应方法的 , 在register(),post()时发生了什么？</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w> </span><span class=n>EventBus</span><span class=p>.</span><span class=na>getDefault</span><span class=p>().</span><span class=na>register</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><h3 id=1register->1.register() :<a hidden class=anchor aria-hidden=true href=#1register->#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>register</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>subscriber</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//1.获得订阅者(Activity,fragment)的Class对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>subscriberClass</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>subscriber</span><span class=p>.</span><span class=na>getClass</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//2.根据订阅者的Class对象查找它用@Subcribe注解的方法集合 , 对于SubcriberMethodFinder的类暂时先不用管</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>SubscriberMethod</span><span class=o>&gt;</span><span class=w> </span><span class=n>subscriberMethods</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>subscriberMethodFinder</span><span class=p>.</span><span class=na>findSubscriberMethods</span><span class=p>(</span><span class=n>subscriberClass</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//3.将Class对象与它里面的@Subcribe方法进行注册绑定</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>SubscriberMethod</span><span class=w> </span><span class=n>subscriberMethod</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>subscriberMethods</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>subscribe</span><span class=p>(</span><span class=n>subscriber</span><span class=p>,</span><span class=w> </span><span class=n>subscriberMethod</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>register()方法中做了3件事情 :</p><ol><li>获得订阅者(Activity,fragment)的Class对象</li><li>根据订阅者的Class对象查找它用@Subcribe注解的方法集合</li><li>将Class对象与它里面的@Subcribe方法进行注册绑定</li></ol><p>##subcribe()方法 : 在注释中已经写清楚代码的作用 , 按照顺序阅读应该很容易理解。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * @param subscriber       订阅者(Activity,fragment等组件)的Class对象
</span></span></span><span class=line><span class=cl><span class=cm>     * @param subscriberMethod 订阅者中用@Subcribe注解的方法
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>subscribe</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>subscriber</span><span class=p>,</span><span class=w> </span><span class=n>SubscriberMethod</span><span class=w> </span><span class=n>subscriberMethod</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//1.获得订阅方法所对应的Event类型</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>eventType</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>subscriberMethod</span><span class=p>.</span><span class=na>eventType</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//2.将订阅者和订阅方法打包到一个包装类</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Subscription</span><span class=w> </span><span class=n>newSubscription</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Subscription</span><span class=p>(</span><span class=n>subscriber</span><span class=p>,</span><span class=w> </span><span class=n>subscriberMethod</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//3.获得这个Event所有的&lt;订阅者,订阅方法&gt;集合，集合中也可能包含参数中订阅者以外的订阅者</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CopyOnWriteArrayList</span><span class=o>&lt;</span><span class=n>Subscription</span><span class=o>&gt;</span><span class=w> </span><span class=n>subscriptions</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>subscriptionsByEventType</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>eventType</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//4.若&lt;订阅者,订阅方法&gt;集合为空 , 说明接收该Event的若干组件还未调用register()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>subscriptions</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>subscriptions</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CopyOnWriteArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>subscriptionsByEventType</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>eventType</span><span class=p>,</span><span class=w> </span><span class=n>subscriptions</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//5.如果这个Event对应的的&lt;订阅者,订阅方法&gt;集合中已经包含了当前这个&lt;订阅者,订阅方法&gt;，则说明当前组件重复调用register()了.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>subscriptions</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>newSubscription</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>EventBusException</span><span class=p>(</span><span class=s>&#34;Subscriber &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>subscriber</span><span class=p>.</span><span class=na>getClass</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; already registered to event &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>+</span><span class=w> </span><span class=n>eventType</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>subscriptions</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//6.将订阅方法按照优先级大小排序</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>size</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>size</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>subscriberMethod</span><span class=p>.</span><span class=na>priority</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>subscriptions</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>).</span><span class=na>subscriberMethod</span><span class=p>.</span><span class=na>priority</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>subscriptions</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=n>newSubscription</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//7.获取这个订阅者订阅的所有Event集合</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span><span class=w> </span><span class=n>subscribedEvents</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>typesBySubscriber</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>subscriber</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>subscribedEvents</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>subscribedEvents</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>typesBySubscriber</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>subscriber</span><span class=p>,</span><span class=w> </span><span class=n>subscribedEvents</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//8.将当前@Subcribe方法的Event类型添加到这个订阅者的Event集合中</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>subscribedEvents</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>eventType</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//9.如果@Subcribe()方法中sticky = true ,则获得这个粘性事件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//注意如果当前事件是普通事件 , 则不做任何处理。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>subscriberMethod</span><span class=p>.</span><span class=na>sticky</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>eventInheritance</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>Map</span><span class=p>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>entries</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>stickyEvents</span><span class=p>.</span><span class=na>entrySet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Map</span><span class=p>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>entry</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>entries</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//先获得粘性事件Event的Class对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>candidateEventType</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>entry</span><span class=p>.</span><span class=na>getKey</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//找到当前Subscribe()方法订阅的粘性事件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>eventType</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>candidateEventType</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>//得到粘性事件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>Object</span><span class=w> </span><span class=n>stickyEvent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>entry</span><span class=p>.</span><span class=na>getValue</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>checkPostStickyEventToSubscription</span><span class=p>(</span><span class=n>newSubscription</span><span class=p>,</span><span class=w> </span><span class=n>stickyEvent</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Object</span><span class=w> </span><span class=n>stickyEvent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>stickyEvents</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>eventType</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//10.对sticky事件判空,并执行订阅方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>checkPostStickyEventToSubscription</span><span class=p>(</span><span class=n>newSubscription</span><span class=p>,</span><span class=w> </span><span class=n>stickyEvent</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>看一下第10步的方法 <code>checkPostStickyEventToSubsctiption()</code> :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 对事件进行判空 
</span></span></span><span class=line><span class=cl><span class=cm>     * @param newSubscription (订阅者,订阅方法)
</span></span></span><span class=line><span class=cl><span class=cm>     * @param stickyEvent 粘性事件
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>checkPostStickyEventToSubscription</span><span class=p>(</span><span class=n>Subscription</span><span class=w> </span><span class=n>newSubscription</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>stickyEvent</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>stickyEvent</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// If the subscriber is trying to abort the event, it will fail (event is not tracked in posting state)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// --&gt; Strange corner case, which we don&#39;t take care of here.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>postToSubscription</span><span class=p>(</span><span class=n>newSubscription</span><span class=p>,</span><span class=w> </span><span class=n>stickyEvent</span><span class=p>,</span><span class=w> </span><span class=n>isMainThread</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>##postToSubscription() :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>postToSubscription</span><span class=p>(</span><span class=n>Subscription</span><span class=w> </span><span class=n>subscription</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>event</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>isMainThread</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//根据对应的ThreadMode,在对应的线程中执行</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>subscription</span><span class=p>.</span><span class=na>subscriberMethod</span><span class=p>.</span><span class=na>threadMode</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=n>POSTING</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>invokeSubscriber</span><span class=p>(</span><span class=n>subscription</span><span class=p>,</span><span class=w> </span><span class=n>event</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=n>MAIN</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isMainThread</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>invokeSubscriber</span><span class=p>(</span><span class=n>subscription</span><span class=p>,</span><span class=w> </span><span class=n>event</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mainThreadPoster</span><span class=p>.</span><span class=na>enqueue</span><span class=p>(</span><span class=n>subscription</span><span class=p>,</span><span class=w> </span><span class=n>event</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=n>MAIN_ORDERED</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mainThreadPoster</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mainThreadPoster</span><span class=p>.</span><span class=na>enqueue</span><span class=p>(</span><span class=n>subscription</span><span class=p>,</span><span class=w> </span><span class=n>event</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// temporary: technically not correct as poster not decoupled from subscriber</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>invokeSubscriber</span><span class=p>(</span><span class=n>subscription</span><span class=p>,</span><span class=w> </span><span class=n>event</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=n>BACKGROUND</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isMainThread</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>backgroundPoster</span><span class=p>.</span><span class=na>enqueue</span><span class=p>(</span><span class=n>subscription</span><span class=p>,</span><span class=w> </span><span class=n>event</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>invokeSubscriber</span><span class=p>(</span><span class=n>subscription</span><span class=p>,</span><span class=w> </span><span class=n>event</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=n>ASYNC</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>asyncPoster</span><span class=p>.</span><span class=na>enqueue</span><span class=p>(</span><span class=n>subscription</span><span class=p>,</span><span class=w> </span><span class=n>event</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&#34;Unknown thread mode: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>subscription</span><span class=p>.</span><span class=na>subscriberMethod</span><span class=p>.</span><span class=na>threadMode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>这个方法根据对应的ThreadMode,在对应的线程中调用 <code>invokeSubcriber()</code> 方法 , 这个方法就是让粘性事件的@Subcriber注解的方法执行的地方 :</p><p>##invokeSubcriber() :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 通过反射调用订阅者中的@Subcribe方法
</span></span></span><span class=line><span class=cl><span class=cm>     * @param subscription
</span></span></span><span class=line><span class=cl><span class=cm>     * @param event
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>invokeSubscriber</span><span class=p>(</span><span class=n>Subscription</span><span class=w> </span><span class=n>subscription</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>event</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>subscription</span><span class=p>.</span><span class=na>subscriberMethod</span><span class=p>.</span><span class=na>method</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=n>subscription</span><span class=p>.</span><span class=na>subscriber</span><span class=p>,</span><span class=w> </span><span class=n>event</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InvocationTargetException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>handleSubscriberException</span><span class=p>(</span><span class=n>subscription</span><span class=p>,</span><span class=w> </span><span class=n>event</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>getCause</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IllegalAccessException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&#34;Unexpected exception&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>从以上流程可以看出 订阅者调用了 <code>register()</code> 之后 ,对粘性事件的处理情况 , 流程图如下 :</p><p><img alt=image.png loading=lazy src=https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/11/15/16e6e50aa978d397~tplv-t2oaga2asx-image.image></p><p>那么普通事件是如何处理的呢 ?</p><p>我们看一下 <code>post()</code> 方法做了什么 :</p><h3 id=2post>2.post()<a hidden class=anchor aria-hidden=true href=#2post>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Posts the given event to the event bus.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>post</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>event</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//获取当前线程的发送状态</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PostingThreadState</span><span class=w> </span><span class=n>postingState</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>currentPostingThreadState</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//获取当前线程的事件序列</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>eventQueue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>postingState</span><span class=p>.</span><span class=na>eventQueue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//把事件添加到序列中</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>eventQueue</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>event</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//如果当前线程尚未处于发送状态</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>postingState</span><span class=p>.</span><span class=na>isPosting</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>postingState</span><span class=p>.</span><span class=na>isMainThread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>isMainThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//标志当前线程处于发送事件状态</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>postingState</span><span class=p>.</span><span class=na>isPosting</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//正处于发送状态时是不能取消的</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>postingState</span><span class=p>.</span><span class=na>canceled</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>EventBusException</span><span class=p>(</span><span class=s>&#34;Internal error. Abort state was not reset&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//将事件序列中的事件挨个发送</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>eventQueue</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>postSingleEvent</span><span class=p>(</span><span class=n>eventQueue</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>0</span><span class=p>),</span><span class=w> </span><span class=n>postingState</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>postingState</span><span class=p>.</span><span class=na>isPosting</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>postingState</span><span class=p>.</span><span class=na>isMainThread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>EventBus中用ThreadLocal存储了每个线程的发送状态 ,</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>PostingThreadState</span><span class=o>&gt;</span><span class=w> </span><span class=n>currentPostingThreadState</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>PostingThreadState</span><span class=o>&gt;</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>protected</span><span class=w> </span><span class=n>PostingThreadState</span><span class=w> </span><span class=nf>initialValue</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>PostingThreadState</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span></code></pre></div><p>ThreadLocal这个类是线程独立的 ， 能够保证每个线程之间的发送状态互不干扰。</p><p>进入最后发送事件的函数 <code>postSingleEvent()</code> :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>postSingleEvent</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>event</span><span class=p>,</span><span class=w> </span><span class=n>PostingThreadState</span><span class=w> </span><span class=n>postingState</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Error</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>eventClass</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>event</span><span class=p>.</span><span class=na>getClass</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>subscriptionFound</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//是否开启了事件继承</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>eventInheritance</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//寻找当前事件类的素有父类,接口</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span><span class=w> </span><span class=n>eventTypes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lookupAllEventTypes</span><span class=p>(</span><span class=n>eventClass</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>countTypes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>eventTypes</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>countTypes</span><span class=p>;</span><span class=w> </span><span class=n>h</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>clazz</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>eventTypes</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>h</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//有多个订阅者时,只要有一个发送成功,则左边为true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>subscriptionFound</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>postSingleEventForEventType</span><span class=p>(</span><span class=n>event</span><span class=p>,</span><span class=w> </span><span class=n>postingState</span><span class=p>,</span><span class=w> </span><span class=n>clazz</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//发送单个事件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>subscriptionFound</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>postSingleEventForEventType</span><span class=p>(</span><span class=n>event</span><span class=p>,</span><span class=w> </span><span class=n>postingState</span><span class=p>,</span><span class=w> </span><span class=n>eventClass</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//如果当前事件还没有订阅者订阅</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>subscriptionFound</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>logNoSubscriberMessages</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>logger</span><span class=p>.</span><span class=na>log</span><span class=p>(</span><span class=n>Level</span><span class=p>.</span><span class=na>FINE</span><span class=p>,</span><span class=w> </span><span class=s>&#34;No subscribers registered for event &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>eventClass</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sendNoSubscriberEvent</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>eventClass</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>NoSubscriberEvent</span><span class=p>.</span><span class=na>class</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>eventClass</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>SubscriberExceptionEvent</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//发送一个没有订阅者的事件，这个事件可以由我们来接收</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>post</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>NoSubscriberEvent</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>event</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>进入 <code>postSingleEventForEventType()</code> :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>postSingleEventForEventType</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>event</span><span class=p>,</span><span class=w> </span><span class=n>PostingThreadState</span><span class=w> </span><span class=n>postingState</span><span class=p>,</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>eventClass</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CopyOnWriteArrayList</span><span class=o>&lt;</span><span class=n>Subscription</span><span class=o>&gt;</span><span class=w> </span><span class=n>subscriptions</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//获取订阅了这个事件的&lt;订阅者,订阅方法&gt;列表</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>subscriptions</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>subscriptionsByEventType</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>eventClass</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//如果这个事件有订阅者</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>subscriptions</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>subscriptions</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Subscription</span><span class=w> </span><span class=n>subscription</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>subscriptions</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>postingState</span><span class=p>.</span><span class=na>event</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>event</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>postingState</span><span class=p>.</span><span class=na>subscription</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>subscription</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>boolean</span><span class=w> </span><span class=n>aborted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//将事件分发给订阅者 , 在分析register()时分析过。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>postToSubscription</span><span class=p>(</span><span class=n>subscription</span><span class=p>,</span><span class=w> </span><span class=n>event</span><span class=p>,</span><span class=w> </span><span class=n>postingState</span><span class=p>.</span><span class=na>isMainThread</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>aborted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>postingState</span><span class=p>.</span><span class=na>canceled</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>postingState</span><span class=p>.</span><span class=na>event</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>postingState</span><span class=p>.</span><span class=na>subscription</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>postingState</span><span class=p>.</span><span class=na>canceled</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>aborted</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>可以看到,最后的把事件发送给订阅者的函数 <code>postToSubcription()</code> 与 <code>register()</code> 流程中最后发送粘性事件给订阅者的一样 , 这里就不介绍了。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>postToSubscription</span><span class=p>(</span><span class=n>Subscription</span><span class=w> </span><span class=n>subscription</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>event</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>isMainThread</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//根据对应的ThreadMode,在对应的线程中执行</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>subscription</span><span class=p>.</span><span class=na>subscriberMethod</span><span class=p>.</span><span class=na>threadMode</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=n>POSTING</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>invokeSubscriber</span><span class=p>(</span><span class=n>subscription</span><span class=p>,</span><span class=w> </span><span class=n>event</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=n>MAIN</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isMainThread</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>invokeSubscriber</span><span class=p>(</span><span class=n>subscription</span><span class=p>,</span><span class=w> </span><span class=n>event</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mainThreadPoster</span><span class=p>.</span><span class=na>enqueue</span><span class=p>(</span><span class=n>subscription</span><span class=p>,</span><span class=w> </span><span class=n>event</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=n>MAIN_ORDERED</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mainThreadPoster</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mainThreadPoster</span><span class=p>.</span><span class=na>enqueue</span><span class=p>(</span><span class=n>subscription</span><span class=p>,</span><span class=w> </span><span class=n>event</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// temporary: technically not correct as poster not decoupled from subscriber</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>invokeSubscriber</span><span class=p>(</span><span class=n>subscription</span><span class=p>,</span><span class=w> </span><span class=n>event</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=n>BACKGROUND</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isMainThread</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>backgroundPoster</span><span class=p>.</span><span class=na>enqueue</span><span class=p>(</span><span class=n>subscription</span><span class=p>,</span><span class=w> </span><span class=n>event</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>invokeSubscriber</span><span class=p>(</span><span class=n>subscription</span><span class=p>,</span><span class=w> </span><span class=n>event</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=n>ASYNC</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>asyncPoster</span><span class=p>.</span><span class=na>enqueue</span><span class=p>(</span><span class=n>subscription</span><span class=p>,</span><span class=w> </span><span class=n>event</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&#34;Unknown thread mode: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>subscription</span><span class=p>.</span><span class=na>subscriberMethod</span><span class=p>.</span><span class=na>threadMode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><code>post()</code> 的总体流程图如下 :</p><p><img alt=image.png loading=lazy src=https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/11/15/16e6e50aa9be6ae2~tplv-t2oaga2asx-image.image></p><blockquote><p>References :</p><ul><li><a href=http://greenrobot.org/eventbus/>http://greenrobot.org/eventbus/</a></li><li><a href=https://www.jianshu.com/p/f057c460c77e>https://www.jianshu.com/p/f057c460c77e</a></li><li><a href=https://github.com/greenrobot/EventBus>https://github.com/greenrobot/EventBus</a></li></ul></blockquote></div><footer class=post-footer><ul class=post-tags><li><a href=https://chenyongda2018.github.io/tags/eventbus/>EventBus</a></li><li><a href=https://chenyongda2018.github.io/tags/android/>Android</a></li></ul><nav class=paginav><a class=prev href=https://chenyongda2018.github.io/posts/android/android%E7%BA%A6%E6%9D%9F%E5%B8%83%E5%B1%80%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7/><span class=title>« Prev</span><br><span>Android约束布局使用技巧</span>
</a><a class=next href=https://chenyongda2018.github.io/posts/android/android%E9%A2%9C%E8%89%B2%E6%A0%BC%E5%BC%8F%E5%8C%BA%E5%88%AB/><span class=title>Next »</span><br><span>Android颜色格式区别</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share EventBus使用详解及源码解析 on x" href="https://x.com/intent/tweet/?text=EventBus%e4%bd%bf%e7%94%a8%e8%af%a6%e8%a7%a3%e5%8f%8a%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90&amp;url=https%3a%2f%2fchenyongda2018.github.io%2fposts%2fandroid%2feventbus%25E4%25BD%25BF%25E7%2594%25A8%25E8%25AF%25A6%25E8%25A7%25A3%25E5%258F%258A%25E6%25BA%2590%25E7%25A0%2581%25E8%25A7%25A3%25E6%259E%2590%2f&amp;hashtags=EventBus%2cAndroid"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share EventBus使用详解及源码解析 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fchenyongda2018.github.io%2fposts%2fandroid%2feventbus%25E4%25BD%25BF%25E7%2594%25A8%25E8%25AF%25A6%25E8%25A7%25A3%25E5%258F%258A%25E6%25BA%2590%25E7%25A0%2581%25E8%25A7%25A3%25E6%259E%2590%2f&amp;title=EventBus%e4%bd%bf%e7%94%a8%e8%af%a6%e8%a7%a3%e5%8f%8a%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90&amp;summary=EventBus%e4%bd%bf%e7%94%a8%e8%af%a6%e8%a7%a3%e5%8f%8a%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90&amp;source=https%3a%2f%2fchenyongda2018.github.io%2fposts%2fandroid%2feventbus%25E4%25BD%25BF%25E7%2594%25A8%25E8%25AF%25A6%25E8%25A7%25A3%25E5%258F%258A%25E6%25BA%2590%25E7%25A0%2581%25E8%25A7%25A3%25E6%259E%2590%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share EventBus使用详解及源码解析 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fchenyongda2018.github.io%2fposts%2fandroid%2feventbus%25E4%25BD%25BF%25E7%2594%25A8%25E8%25AF%25A6%25E8%25A7%25A3%25E5%258F%258A%25E6%25BA%2590%25E7%25A0%2581%25E8%25A7%25A3%25E6%259E%2590%2f&title=EventBus%e4%bd%bf%e7%94%a8%e8%af%a6%e8%a7%a3%e5%8f%8a%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share EventBus使用详解及源码解析 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fchenyongda2018.github.io%2fposts%2fandroid%2feventbus%25E4%25BD%25BF%25E7%2594%25A8%25E8%25AF%25A6%25E8%25A7%25A3%25E5%258F%258A%25E6%25BA%2590%25E7%25A0%2581%25E8%25A7%25A3%25E6%259E%2590%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share EventBus使用详解及源码解析 on whatsapp" href="https://api.whatsapp.com/send?text=EventBus%e4%bd%bf%e7%94%a8%e8%af%a6%e8%a7%a3%e5%8f%8a%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90%20-%20https%3a%2f%2fchenyongda2018.github.io%2fposts%2fandroid%2feventbus%25E4%25BD%25BF%25E7%2594%25A8%25E8%25AF%25A6%25E8%25A7%25A3%25E5%258F%258A%25E6%25BA%2590%25E7%25A0%2581%25E8%25A7%25A3%25E6%259E%2590%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share EventBus使用详解及源码解析 on telegram" href="https://telegram.me/share/url?text=EventBus%e4%bd%bf%e7%94%a8%e8%af%a6%e8%a7%a3%e5%8f%8a%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90&amp;url=https%3a%2f%2fchenyongda2018.github.io%2fposts%2fandroid%2feventbus%25E4%25BD%25BF%25E7%2594%25A8%25E8%25AF%25A6%25E8%25A7%25A3%25E5%258F%258A%25E6%25BA%2590%25E7%25A0%2581%25E8%25A7%25A3%25E6%259E%2590%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share EventBus使用详解及源码解析 on ycombinator" href="https://news.ycombinator.com/submitlink?t=EventBus%e4%bd%bf%e7%94%a8%e8%af%a6%e8%a7%a3%e5%8f%8a%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90&u=https%3a%2f%2fchenyongda2018.github.io%2fposts%2fandroid%2feventbus%25E4%25BD%25BF%25E7%2594%25A8%25E8%25AF%25A6%25E8%25A7%25A3%25E5%258F%258A%25E6%25BA%2590%25E7%25A0%2581%25E8%25A7%25A3%25E6%259E%2590%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://chenyongda2018.github.io/>Petrichor's blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>